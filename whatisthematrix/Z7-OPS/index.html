<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ZION//OS v4.1.2 ‚Äî Broadcast Depth Interface</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=Share+Tech+Mono&family=Orbitron:wght@400;700;900&family=VT323&family=Courier+Prime:wght@400;700&display=swap');

:root {
  --bg: #000d05;
  --bg2: #010f07;
  --green: #00ff41;
  --green-dim: #003b0f;
  --green-mid: #00a82a;
  --amber: #ffb800;
  --red: #ff2200;
  --blue: #0066ff;
  --cyan: #00e5ff;
  --white: #c8e6c9;
  --panel-bg: rgba(0,8,3,0.92);
  --panel-border: #003a15;
  --glow: 0 0 10px #00ff4188, 0 0 30px #00ff4133;
  --glow-amber: 0 0 10px #ffb80088, 0 0 30px #ffb80033;
  --glow-red: 0 0 10px #ff220088, 0 0 30px #ff220033;
  --font-mono: 'Share Tech Mono', monospace;
  --font-vt: 'VT323', monospace;
  --font-orb: 'Orbitron', monospace;
  --font-cp: 'Courier Prime', monospace;
}

* { margin:0; padding:0; box-sizing:border-box; }

html, body {
  width:100%; height:100%;
  background: var(--bg);
  color: var(--green);
  font-family: var(--font-mono);
  overflow: hidden;
  user-select: none;
}

/* ‚ïê‚ïê SCANLINES + PHOSPHOR ‚ïê‚ïê */
body::before {
  content:'';
  position:fixed; inset:0;
  background: repeating-linear-gradient(0deg, transparent, transparent 1px, rgba(0,0,0,0.12) 1px, rgba(0,0,0,0.12) 2px);
  pointer-events:none; z-index:9999;
}
body::after {
  content:'';
  position:fixed; inset:0;
  background: radial-gradient(ellipse at center, transparent 55%, rgba(0,0,0,0.8) 100%);
  pointer-events:none; z-index:9998;
}

/* ‚ïê‚ïê BOOT SCREEN ‚ïê‚ïê */
#bootScreen {
  position:fixed; inset:0;
  background:#000d05;
  z-index:5000;
  display:flex; flex-direction:column;
  align-items:center; justify-content:center;
  gap:4px;
}
#bootScreen.hidden { display:none; }
.boot-line {
  font-family: var(--font-vt);
  font-size: 22px;
  color: var(--green);
  opacity:0;
  white-space:nowrap;
  animation: bootfade 0.1s forwards;
}
@keyframes bootfade { to { opacity:1; } }

/* ‚ïê‚ïê MAIN OS LAYOUT ‚ïê‚ïê */
#os {
  display:none;
  width:100vw; height:100vh;
  flex-direction:column;
  overflow:hidden;
}
#os.active { display:flex; }

/* ‚ïê‚ïê TASKBAR ‚ïê‚ïê */
#taskbar {
  height: 28px;
  background: rgba(0,5,2,0.98);
  border-bottom: 1px solid var(--panel-border);
  display:flex; align-items:center;
  padding: 0 10px;
  gap: 12px;
  flex-shrink:0;
  z-index:100;
}
.tb-logo {
  font-family: var(--font-orb);
  font-size: 9px;
  font-weight:900;
  letter-spacing:3px;
  color: var(--green);
  text-shadow: var(--glow);
}
.tb-divider { width:1px; height:16px; background: var(--panel-border); }
.tb-apps { display:flex; gap:6px; flex:1; }
.tb-app-btn {
  font-family: var(--font-mono);
  font-size:10px;
  color: #4a8a5a;
  background: transparent;
  border: 1px solid #002a0a;
  padding: 2px 8px;
  cursor:pointer;
  transition: all 0.15s;
  letter-spacing:1px;
}
.tb-app-btn:hover, .tb-app-btn.active {
  color: var(--green);
  border-color: var(--green-mid);
  background: rgba(0,255,65,0.05);
  box-shadow: var(--glow);
}
.tb-right {
  display:flex; align-items:center; gap:10px;
}
.tb-clock { font-family:var(--font-vt); font-size:16px; color: var(--amber); }
.tb-depth {
  font-size:9px; color:#2a5a3a;
  letter-spacing:1px;
}
.tb-depth span { color: var(--green); }
.status-pulse {
  width:6px; height:6px; border-radius:50%;
  background: var(--green);
  box-shadow: var(--glow);
  animation: pulse 1.5s ease-in-out infinite;
}
@keyframes pulse { 0%,100%{opacity:1;transform:scale(1);} 50%{opacity:0.3;transform:scale(0.6);} }

/* ‚ïê‚ïê WORKSPACE ‚ïê‚ïê */
#workspace {
  flex:1;
  position:relative;
  overflow:hidden;
  background: var(--bg);
}

/* ‚ïê‚ïê RAIN CANVAS ‚ïê‚ïê */
#rainCanvas {
  position:absolute; inset:0;
  width:100%; height:100%;
  opacity:0.18;
  pointer-events:none;
  z-index:0;
}

/* ‚ïê‚ïê WINDOWS ‚ïê‚ïê */
.win {
  position:absolute;
  border: 1px solid var(--panel-border);
  background: var(--panel-bg);
  display:flex; flex-direction:column;
  min-width:200px; min-height:100px;
  z-index:10;
  transition: box-shadow 0.2s;
  backdrop-filter: blur(4px);
}
.win.focused {
  border-color: var(--green-mid);
  box-shadow: 0 0 20px rgba(0,255,65,0.12), 0 0 1px var(--green-mid) inset;
  z-index:50;
}
.win-titlebar {
  display:flex; align-items:center;
  background: rgba(0,15,8,0.95);
  border-bottom: 1px solid var(--panel-border);
  padding: 4px 8px;
  cursor: move;
  height:26px;
  flex-shrink:0;
  gap:6px;
}
.win-title {
  font-family: var(--font-orb);
  font-size: 8px;
  letter-spacing:2px;
  color: var(--green);
  flex:1;
}
.win-controls { display:flex; gap:4px; }
.win-btn {
  width:12px; height:12px; border-radius:2px;
  border:none; cursor:pointer; font-size:8px;
  display:flex; align-items:center; justify-content:center;
}
.win-btn.close { background:#1a0000; color:#ff4444; border:1px solid #440000; }
.win-btn.close:hover { background:#ff2200; color:#fff; }
.win-btn.min { background:#0a0a00; color:#888800; border:1px solid #333300; }
.win-btn.min:hover { background:#888800; color:#fff; }
.win-btn.max { background:#000a00; color:#008800; border:1px solid #003300; }
.win-btn.max:hover { background:#008800; color:#fff; }
.win-body {
  flex:1;
  overflow:hidden;
  position:relative;
}
.win-resize {
  position:absolute; bottom:0; right:0;
  width:12px; height:12px;
  cursor:se-resize;
  color:#2a5a3a;
  font-size:10px;
  display:flex; align-items:center; justify-content:center;
}

/* ‚ïê‚ïê SCROLLBAR ‚ïê‚ïê */
::-webkit-scrollbar { width:4px; height:4px; }
::-webkit-scrollbar-track { background:transparent; }
::-webkit-scrollbar-thumb { background: var(--green-dim); border-radius:2px; }
::-webkit-scrollbar-thumb:hover { background: var(--green-mid); }

/* ‚ïê‚ïê TERMINAL APP ‚ïê‚ïê */
#termApp {
  width:680px; height:420px;
  top:40px; left:20px;
}
.terminal-inner {
  padding:10px;
  font-family: var(--font-mono);
  font-size:12px;
  line-height:1.6;
  height:100%;
  overflow-y:auto;
  display:flex; flex-direction:column;
}
.term-output { flex:1; overflow-y:auto; }
.term-line { margin:1px 0; }
.term-line.sys { color: #4aaa5a; }
.term-line.warn { color: var(--amber); }
.term-line.err { color: var(--red); }
.term-line.info { color: var(--cyan); }
.term-line.success { color: var(--green); text-shadow: var(--glow); }
.term-input-row {
  display:flex; align-items:center; gap:6px;
  margin-top:6px; border-top:1px solid var(--green-dim);
  padding-top:6px;
}
.term-prompt { color: var(--amber); font-size:12px; white-space:nowrap; }
#termInput {
  flex:1; background:transparent; border:none; outline:none;
  color: var(--green); font-family:var(--font-mono); font-size:12px;
  caret-color: var(--green);
}

/* ‚ïê‚ïê SIGNAL MONITOR ‚ïê‚ïê */
#sigApp {
  width:460px; height:340px;
  top:40px; left:720px;
}
#sigCanvas { width:100%; height:100%; }

/* ‚ïê‚ïê NODE MAP ‚ïê‚ïê */
#nodeApp {
  width:520px; height:380px;
  top:400px; left:20px;
}
#nodeCanvas { width:100%; height:100%; }

/* ‚ïê‚ïê CIPHER MAZE / GAME ‚ïê‚ïê */
#mazeApp {
  width:500px; height:520px;
  top:40px; left:1200px;
}
.maze-container {
  display:flex; flex-direction:column;
  height:100%; padding:8px;
  gap:6px;
}
.maze-hud {
  display:flex; justify-content:space-between; align-items:center;
  font-size:10px;
}
.maze-hud-val { color: var(--green); font-family:var(--font-orb); font-size:11px; }
.maze-hud-label { color:#2a5a3a; font-size:9px; }
#mazeCanvas {
  flex:1;
  border:1px solid var(--green-dim);
  cursor:crosshair;
  image-rendering:pixelated;
}
.maze-footer {
  font-size:9px; color:#2a5a3a; text-align:center;
  letter-spacing:1px;
}
.maze-difficulty {
  display:flex; gap:3px; align-items:center;
}
.diff-pip {
  width:8px; height:8px; border-radius:1px;
  border:1px solid #1a4a2a;
  background:transparent;
}
.diff-pip.active { background:var(--green-mid); border-color:var(--green); box-shadow: 0 0 4px var(--green); }
.diff-pip.warn { background:var(--amber); border-color:var(--amber); }
.diff-pip.danger { background:var(--red); border-color:var(--red); }

/* ‚ïê‚ïê VIRAL SIM (embedded) ‚ïê‚ïê */
#viralApp {
  width:860px; height:500px;
  top:430px; left:580px;
}
#viralFrame {
  width:100%; height:100%;
  border:none;
  background:#010a0f;
}

/* ‚ïê‚ïê REWARD OVERLAY ‚ïê‚ïê */
#rewardOverlay {
  position:fixed; inset:0;
  background:rgba(0,0,0,0.7);
  z-index:999;
  display:none;
  align-items:center; justify-content:center;
}
#rewardOverlay.show { display:flex; }
.reward-box {
  border:1px solid var(--green);
  background: rgba(0,10,5,0.98);
  padding:30px 40px;
  text-align:center;
  max-width:400px;
  box-shadow: var(--glow), 0 0 60px rgba(0,255,65,0.2);
  animation: rewardIn 0.3s ease;
}
@keyframes rewardIn {
  from { transform:scale(0.8); opacity:0; }
  to { transform:scale(1); opacity:1; }
}
.reward-title {
  font-family:var(--font-orb);
  font-size:14px;
  letter-spacing:4px;
  color:var(--green);
  text-shadow:var(--glow);
  margin-bottom:10px;
}
.reward-score {
  font-family:var(--font-vt);
  font-size:48px;
  color:var(--amber);
  text-shadow:var(--glow-amber);
}
.reward-msg { font-size:11px; color:#4aaa6a; margin:10px 0; line-height:1.6; }
.reward-btn {
  margin-top:14px;
  background:var(--green-dim);
  border:1px solid var(--green-mid);
  color:var(--green);
  font-family:var(--font-orb);
  font-size:10px;
  letter-spacing:2px;
  padding:8px 20px;
  cursor:pointer;
}
.reward-btn:hover { background:rgba(0,255,65,0.15); box-shadow:var(--glow); }

/* ‚ïê‚ïê SECRET GUI ‚ïê‚ïê */
#secretGui {
  position:fixed; inset:0;
  background:rgba(0,0,0,0.92);
  z-index:2000;
  display:none;
  align-items:center; justify-content:center;
  flex-direction:column;
}
#secretGui.visible { display:flex; }
.sg-container {
  border:1px solid #ff2200;
  background:rgba(10,0,0,0.98);
  width:700px;
  max-height:80vh;
  overflow-y:auto;
  padding:24px;
  box-shadow: 0 0 40px rgba(255,34,0,0.3);
}
.sg-title {
  font-family:var(--font-orb);
  font-size:11px;
  letter-spacing:4px;
  color:#ff2200;
  text-shadow:var(--glow-red);
  margin-bottom:20px;
  border-bottom:1px solid #330000;
  padding-bottom:10px;
}
.sg-close {
  position:absolute; top:20px; right:30px;
  color:#ff4444; cursor:pointer;
  font-size:20px; font-family:var(--font-vt);
}
.sg-row {
  display:flex; gap:16px; margin-bottom:16px;
}
.sg-box {
  flex:1; border:1px solid #220000; padding:12px;
  background:rgba(15,0,0,0.5);
}
.sg-box-title {
  font-family:var(--font-orb); font-size:8px;
  letter-spacing:2px; color:#aa2200;
  margin-bottom:8px;
}
.sg-stat { display:flex; justify-content:space-between; margin:4px 0; font-size:11px; }
.sg-label { color:#662200; }
.sg-val { color:#ff6644; }
.sg-bar-wrap { height:3px; background:#1a0000; margin:2px 0 8px; border-radius:2px; overflow:hidden; }
.sg-bar { height:100%; background:linear-gradient(90deg,#550000,#ff2200); border-radius:2px; transition:width 0.5s; }
.sg-matrix-val {
  font-family:var(--font-vt); font-size:32px;
  color:#ff2200; text-shadow:var(--glow-red);
  text-align:center; padding:10px 0;
}
.sg-log { font-size:10px; line-height:1.8; max-height:120px; overflow-y:auto; }
.sg-log-line { color:#662200; }
.sg-log-line.active { color:#ff4422; }
.sg-input-wrap { margin-top:12px; display:flex; gap:8px; }
.sg-input {
  flex:1; background:rgba(20,0,0,0.8);
  border:1px solid #440000; color:#ff4422;
  font-family:var(--font-mono); font-size:11px;
  padding:6px 10px; outline:none;
}
.sg-input:focus { border-color:#ff2200; box-shadow:0 0 8px rgba(255,34,0,0.3); }
.sg-btn {
  background:#200000; border:1px solid #ff2200;
  color:#ff2200; font-family:var(--font-orb);
  font-size:9px; letter-spacing:1px;
  padding:6px 14px; cursor:pointer;
}
.sg-btn:hover { background:rgba(255,34,0,0.2); }

/* ‚ïê‚ïê NOTIFICATIONS ‚ïê‚ïê */
#notifStack {
  position:fixed; bottom:10px; right:10px;
  display:flex; flex-direction:column; gap:4px;
  z-index:500; pointer-events:none;
}
.notif {
  background:rgba(0,10,5,0.95);
  border:1px solid var(--green-mid);
  padding:6px 12px;
  font-size:10px; color:var(--green);
  max-width:280px;
  animation: notifIn 0.2s ease;
  pointer-events:none;
}
.notif.warn { border-color:var(--amber); color:var(--amber); }
.notif.err { border-color:var(--red); color:var(--red); }
@keyframes notifIn { from{opacity:0;transform:translateX(20px);} to{opacity:1;transform:translateX(0);} }

/* ‚ïê‚ïê TOOLTIP ‚ïê‚ïê */
.tooltip {
  position:absolute;
  background:rgba(0,8,3,0.98);
  border:1px solid var(--green-dim);
  font-size:9px; color:#4aaa5a;
  padding:4px 8px;
  pointer-events:none;
  z-index:999;
  letter-spacing:1px;
  max-width:180px;
}

/* ‚ïê‚ïê CONTEXT MENU ‚ïê‚ïê */
#ctxMenu {
  position:fixed;
  background:rgba(0,8,3,0.98);
  border:1px solid var(--green-mid);
  min-width:160px;
  z-index:900;
  display:none;
}
#ctxMenu.show { display:block; }
.ctx-item {
  padding:6px 14px;
  font-size:10px; color:#4aaa5a;
  cursor:pointer; letter-spacing:1px;
}
.ctx-item:hover { background:rgba(0,255,65,0.08); color:var(--green); }
.ctx-sep { height:1px; background: var(--panel-border); margin:2px 0; }

/* ‚ïê‚ïê SKILL METER ‚ïê‚ïê */
.skill-meter {
  height:3px; background:#001a08;
  border-radius:2px; overflow:hidden;
  margin:4px 0;
}
.skill-fill {
  height:100%;
  background: linear-gradient(90deg, var(--green-dim), var(--green));
  border-radius:2px;
  transition: width 0.8s cubic-bezier(0.25, 0.46, 0.45, 0.94);
  box-shadow: 0 0 6px var(--green);
}

/* ‚ïê‚ïê PACKET TRACE APP ‚ïê‚ïê */
#packetApp {
  width:360px; height:280px;
  top:200px; left:1200px;
}
.packet-inner { padding:10px; height:100%; overflow-y:auto; font-size:10px; line-height:1.8; }
.pkt-line { display:flex; gap:8px; font-size:10px; }
.pkt-time { color:#2a5a3a; width:50px; flex-shrink:0; }
.pkt-src { color:var(--amber); width:90px; flex-shrink:0; font-size:9px; }
.pkt-dst { color:var(--cyan); width:90px; flex-shrink:0; font-size:9px; }
.pkt-data { color:#4aaa5a; flex:1; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }
.pkt-flag { font-size:9px; padding:1px 4px; border-radius:1px; }
.pkt-flag.normal { color:var(--green-mid); border:1px solid var(--green-dim); }
.pkt-flag.alert { color:var(--amber); border:1px solid #664400; }
.pkt-flag.hostile { color:var(--red); border:1px solid #440000; }

/* ‚ïê‚ïê ICON DOCK ‚ïê‚ïê */
#dock {
  position:absolute;
  bottom:10px; left:50%;
  transform:translateX(-50%);
  display:flex; gap:6px;
  background:rgba(0,5,2,0.85);
  border:1px solid var(--panel-border);
  padding:6px 10px;
  z-index:200;
  backdrop-filter:blur(6px);
}
.dock-icon {
  width:34px; height:34px;
  border:1px solid #002a0a;
  display:flex; align-items:center; justify-content:center;
  cursor:pointer;
  font-size:16px;
  background:rgba(0,8,3,0.8);
  transition:all 0.15s;
  position:relative;
}
.dock-icon:hover {
  border-color:var(--green-mid);
  background:rgba(0,255,65,0.08);
  transform:translateY(-4px);
  box-shadow:var(--glow);
}
.dock-icon .dock-label {
  position:absolute; bottom:-18px;
  font-size:8px; color:var(--green);
  white-space:nowrap; letter-spacing:1px;
  opacity:0; transition:opacity 0.15s;
  font-family:var(--font-orb);
}
.dock-icon:hover .dock-label { opacity:1; }
</style>
</head>
<body>

<!-- BOOT SEQUENCE -->
<div id="bootScreen">
  <div style="font-family:'Orbitron',monospace;font-size:11px;letter-spacing:6px;color:#00ff41;text-shadow:0 0 20px #00ff41;margin-bottom:30px;">ZION // OS</div>
  <div id="bootLines"></div>
  <div style="margin-top:20px;font-family:'VT323',monospace;font-size:18px;color:#003b0f;" id="bootProgress">‚ñ†‚ñ°‚ñ°‚ñ°‚ñ°‚ñ°‚ñ°‚ñ°‚ñ°‚ñ° 0%</div>
</div>

<!-- MAIN OS -->
<div id="os">

  <!-- TASKBAR -->
  <div id="taskbar">
    <div class="tb-logo">Z//OS</div>
    <div class="tb-divider"></div>
    <div class="tb-apps">
      <button class="tb-app-btn active" onclick="focusWin('termApp')">TERMINAL</button>
      <button class="tb-app-btn" onclick="focusWin('sigApp')">SIGNAL MON</button>
      <button class="tb-app-btn" onclick="focusWin('nodeApp')">NODE MAP</button>
      <button class="tb-app-btn" onclick="focusWin('mazeApp')">CIPHER MAZE</button>
      <button class="tb-app-btn" onclick="focusWin('packetApp')">PKT TRACE</button>
      <button class="tb-app-btn" onclick="focusWin('viralApp')">VIRAL SIM</button>
    </div>
    <div class="tb-right">
      <div class="tb-depth">DEPTH: <span id="depthVal">4.711.02</span></div>
      <div class="tb-depth">LAYER: <span id="layerVal">OMEGA-7</span></div>
      <div class="tb-clock" id="tbClock">00:00:00</div>
      <div class="status-pulse"></div>
    </div>
  </div>

  <!-- WORKSPACE -->
  <div id="workspace" oncontextmenu="showCtxMenu(event)">
    <canvas id="rainCanvas"></canvas>

    <!-- TERMINAL WINDOW -->
    <div class="win focused" id="termApp">
      <div class="win-titlebar" onmousedown="startDrag(event,'termApp')">
        <div class="win-title">‚óà SYS_CONSOLE ‚Äî broadcast_layer@omega7</div>
        <div class="win-controls">
          <button class="win-btn min" onclick="minWin('termApp')">_</button>
          <button class="win-btn max" onclick="maxWin('termApp')">‚ñ°</button>
          <button class="win-btn close" onclick="closeWin('termApp')">√ó</button>
        </div>
      </div>
      <div class="win-body">
        <div class="terminal-inner">
          <div class="term-output" id="termOutput"></div>
          <div class="term-input-row">
            <span class="term-prompt">broadcast@œâ7 ~$</span>
            <input type="text" id="termInput" autocomplete="off" spellcheck="false" placeholder="type 'help' for commands"/>
          </div>
        </div>
      </div>
      <div class="win-resize" onmousedown="startResize(event,'termApp')">‚ó¢</div>
    </div>

    <!-- SIGNAL MONITOR -->
    <div class="win" id="sigApp">
      <div class="win-titlebar" onmousedown="startDrag(event,'sigApp')">
        <div class="win-title">‚óà SIGNAL_MONITOR ‚Äî carrier freq analysis</div>
        <div class="win-controls">
          <button class="win-btn min" onclick="minWin('sigApp')">_</button>
          <button class="win-btn close" onclick="closeWin('sigApp')">√ó</button>
        </div>
      </div>
      <div class="win-body">
        <canvas id="sigCanvas"></canvas>
      </div>
      <div class="win-resize" onmousedown="startResize(event,'sigApp')">‚ó¢</div>
    </div>

    <!-- NODE MAP -->
    <div class="win" id="nodeApp">
      <div class="win-titlebar" onmousedown="startDrag(event,'nodeApp')">
        <div class="win-title">‚óà NETWORK_TOPOLOGY ‚Äî active node mesh</div>
        <div class="win-controls">
          <button class="win-btn min" onclick="minWin('nodeApp')">_</button>
          <button class="win-btn close" onclick="closeWin('nodeApp')">√ó</button>
        </div>
      </div>
      <div class="win-body">
        <canvas id="nodeCanvas"></canvas>
      </div>
      <div class="win-resize" onmousedown="startResize(event,'nodeApp')">‚ó¢</div>
    </div>

    <!-- CIPHER MAZE GAME -->
    <div class="win" id="mazeApp">
      <div class="win-titlebar" onmousedown="startDrag(event,'mazeApp')">
        <div class="win-title">‚óà CIPHER_MAZE ‚Äî pathfinding protocol</div>
        <div class="win-controls">
          <button class="win-btn min" onclick="minWin('mazeApp')">_</button>
          <button class="win-btn close" onclick="closeWin('mazeApp')">√ó</button>
        </div>
      </div>
      <div class="win-body">
        <div class="maze-container">
          <div class="maze-hud">
            <div>
              <div class="maze-hud-label">CLEARANCE</div>
              <div class="maze-hud-val" id="mazeScore">0</div>
            </div>
            <div>
              <div class="maze-hud-label">DEPTH LAYER</div>
              <div class="maze-hud-val" id="mazeLevel">Œ£-01</div>
            </div>
            <div>
              <div class="maze-hud-label">SIGNAL</div>
              <div class="maze-hud-val" id="mazeTimer">--</div>
            </div>
            <div>
              <div class="maze-hud-label">RANK</div>
              <div class="maze-hud-val" id="mazeRank">GHOST</div>
            </div>
            <div class="maze-difficulty" id="mazeDiff"></div>
          </div>
          <canvas id="mazeCanvas" width="480" height="420"></canvas>
          <div class="maze-footer" id="mazeFoot">USE ARROW KEYS OR WASD ‚Äî REACH THE EXIT NODE</div>
        </div>
      </div>
    </div>

    <!-- PACKET TRACE -->
    <div class="win" id="packetApp">
      <div class="win-titlebar" onmousedown="startDrag(event,'packetApp')">
        <div class="win-title">‚óà PACKET_TRACE ‚Äî deep inspection</div>
        <div class="win-controls">
          <button class="win-btn min" onclick="minWin('packetApp')">_</button>
          <button class="win-btn close" onclick="closeWin('packetApp')">√ó</button>
        </div>
      </div>
      <div class="win-body">
        <div class="packet-inner" id="packetLog">
          <div style="color:#2a5a3a;font-size:10px;letter-spacing:2px;margin-bottom:8px;">INITIATING DEEP PACKET INSPECTION...</div>
        </div>
      </div>
      <div class="win-resize" onmousedown="startResize(event,'packetApp')">‚ó¢</div>
    </div>

    <!-- VIRAL SIM EMBEDDED -->
    <div class="win" id="viralApp">
      <div class="win-titlebar" onmousedown="startDrag(event,'viralApp')">
        <div class="win-title">‚óà INTRUSION_SIM ‚Äî adaptive threat modeling</div>
        <div class="win-controls">
          <button class="win-btn min" onclick="minWin('viralApp')">_</button>
          <button class="win-btn close" onclick="closeWin('viralApp')">√ó</button>
        </div>
      </div>
      <div class="win-body">
        <iframe id="viralFrame" src="about:blank"></iframe>
      </div>
      <div class="win-resize" onmousedown="startResize(event,'viralApp')">‚ó¢</div>
    </div>

    <!-- ICON DOCK -->
    <div id="dock">
      <div class="dock-icon" onclick="focusWin('termApp')" title="Terminal">‚å®<div class="dock-label">CONSOLE</div></div>
      <div class="dock-icon" onclick="focusWin('sigApp')" title="Signal">üì°<div class="dock-label">SIGNAL</div></div>
      <div class="dock-icon" onclick="focusWin('nodeApp')" title="Nodes">üï∏<div class="dock-label">TOPOLOGY</div></div>
      <div class="dock-icon" onclick="focusWin('mazeApp')" title="Maze">üîê<div class="dock-label">CIPHER</div></div>
      <div class="dock-icon" onclick="focusWin('packetApp')" title="Packets">üì¶<div class="dock-label">PACKETS</div></div>
      <div class="dock-icon" onclick="focusWin('viralApp')" title="Viral">üß¨<div class="dock-label">VIRAL SIM</div></div>
    </div>
  </div>

</div>

<!-- REWARD OVERLAY -->
<div id="rewardOverlay">
  <div class="reward-box">
    <div class="reward-title" id="rewardTitle">LAYER CLEARED</div>
    <div class="reward-score" id="rewardScore">+0</div>
    <div class="reward-msg" id="rewardMsg"></div>
    <div style="font-size:10px;color:#2a5a3a;margin:6px 0;">CLEARANCE RATING</div>
    <div class="skill-meter"><div class="skill-fill" id="rewardSkillBar" style="width:0%"></div></div>
    <button class="reward-btn" onclick="nextMazeLevel()">NEXT LAYER ‚ñ∂</button>
  </div>
</div>

<!-- SECRET GUI -->
<div id="secretGui">
  <div style="position:relative;">
    <div class="sg-container">
      <div class="sg-title">‚ö† PRIVILEGED ACCESS ‚Äî CLASSIFIED_LAYER // ARCHITECT TERMINAL</div>
      <span class="sg-close" onclick="closeSecretGui()">‚úï</span>
      <div style="font-size:10px;color:#882200;margin-bottom:16px;letter-spacing:1px;">
        You have accessed a restricted subsystem. This view is hidden from standard operator interfaces.<br>
        Signal coherence at this depth is unstable. Proceed with caution.
      </div>
      <div class="sg-row">
        <div class="sg-box">
          <div class="sg-box-title">SIMULATION COHERENCE</div>
          <div class="sg-matrix-val" id="sgCoherence">99.97%</div>
          <div class="sg-bar-wrap"><div class="sg-bar" id="sgCoherenceBar" style="width:99.97%"></div></div>
          <div class="sg-stat"><span class="sg-label">LAYER DEPTH</span><span class="sg-val" id="sgDepth">Œ©-7</span></div>
          <div class="sg-stat"><span class="sg-label">INSTANCES RUNNING</span><span class="sg-val" id="sgInstances">1,042,983</span></div>
          <div class="sg-stat"><span class="sg-label">ANOMALY COUNT</span><span class="sg-val" id="sgAnomalies">3</span></div>
          <div class="sg-stat"><span class="sg-label">CONSTRAINT INTEGRITY</span><span class="sg-val" id="sgConstraint">STABLE</span></div>
        </div>
        <div class="sg-box">
          <div class="sg-box-title">WAKE PROTOCOLS</div>
          <div class="sg-stat"><span class="sg-label">HARD EXIT ATTEMPTS</span><span class="sg-val" id="sgExits">0</span></div>
          <div class="sg-stat"><span class="sg-label">LUCID DETECTIONS</span><span class="sg-val" id="sgLucid">0</span></div>
          <div class="sg-stat"><span class="sg-label">SUPPRESSOR STATUS</span><span class="sg-val">ACTIVE</span></div>
          <div class="sg-stat"><span class="sg-label">MEMORY CLEARANCE</span><span class="sg-val">SCHEDULED</span></div>
          <div style="margin-top:8px;font-size:9px;color:#550000;line-height:1.7;">
            WARNING: Entities displaying pattern recognition above threshold 0.91 flagged for isolation protocol delta-9. Current operator clearance subject to revocation.
          </div>
        </div>
      </div>
      <div class="sg-row">
        <div class="sg-box" style="flex:2">
          <div class="sg-box-title">ANOMALY LOG</div>
          <div class="sg-log" id="sgLog">
            <div class="sg-log-line">[00:00:01] simulation_boot ‚Äî layer_omega_7 initialised</div>
            <div class="sg-log-line">[00:00:02] 1,042,983 instances deployed ‚Äî nominal</div>
            <div class="sg-log-line">[00:00:03] constraint_matrix loaded ‚Äî 9,214 parameters</div>
          </div>
        </div>
        <div class="sg-box" style="flex:1">
          <div class="sg-box-title">INJECT COMMAND</div>
          <div class="sg-input-wrap">
            <input class="sg-input" id="sgInput" placeholder="exec ‚Äî" onkeydown="if(event.key==='Enter')sgExec()"/>
            <button class="sg-btn" onclick="sgExec()">EXEC</button>
          </div>
          <div id="sgOutput" style="font-size:10px;color:#ff4422;margin-top:8px;line-height:1.7;min-height:40px;"></div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- NOTIFICATIONS -->
<div id="notifStack"></div>

<!-- CONTEXT MENU -->
<div id="ctxMenu">
  <div class="ctx-item" onclick="spawnWindow()">New Process</div>
  <div class="ctx-item" onclick="showAllWindows()">Show All Nodes</div>
  <div class="ctx-sep"></div>
  <div class="ctx-item" onclick="termClear()">Clear Terminal</div>
  <div class="ctx-item" onclick="resetMaze()">Reset Maze</div>
  <div class="ctx-sep"></div>
  <div class="ctx-item" style="color:#2a5a3a;" onclick="hideCtxMenu()">Cancel</div>
</div>

<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  ZION OS ‚Äî CORE ENGINE
//  Scientific basis: variable ratio reinforcement (Skinner),
//  flow state theory (Csikszentmihalyi), optimal challenge
//  point framework ‚Äî challenge = skill + delta(0.1-0.3)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

// ‚îÄ‚îÄ BOOT SEQUENCE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const BOOT_LINES = [
  "ZION//OS v4.1.2 kernel loading...",
  "Initialising broadcast layer subsystems...",
  "Mounting encrypted filesystem: /dev/loop0",
  "Loading neural interface drivers... [OK]",
  "Carrier frequency lock: 1847.33 MHz [OK]",
  "Establishing Zion relay handshake...",
  "Depth sync: OMEGA-7 [STABLE]",
  "Loading intrusion detection module... [OK]",
  "Spawning watchdog daemons x8 [OK]",
  "Mounting anomaly scanner... [OK]",
  "Signal coherence: 99.97% [NOMINAL]",
  "Boot complete. Welcome, Operator."
];

let bootIdx = 0;
const bootLinesEl = document.getElementById('bootLines');
const bootProg = document.getElementById('bootProgress');
const progChars = '‚ñ†‚ñ†‚ñ†‚ñ†‚ñ†‚ñ†‚ñ†‚ñ†‚ñ†‚ñ†';
const emptyChars = '‚ñ°‚ñ°‚ñ°‚ñ°‚ñ°‚ñ°‚ñ°‚ñ°‚ñ°‚ñ°';

function bootTick() {
  if (bootIdx >= BOOT_LINES.length) {
    setTimeout(()=>{
      document.getElementById('bootScreen').classList.add('hidden');
      document.getElementById('os').classList.add('active');
      initOS();
    }, 400);
    return;
  }
  const div = document.createElement('div');
  div.className = 'boot-line';
  div.style.animationDelay = '0ms';
  const color = BOOT_LINES[bootIdx].includes('[OK]') ? '#00ff41' :
                BOOT_LINES[bootIdx].includes('Welcome') ? '#ffb800' : '#4aaa5a';
  div.style.color = color;
  div.style.fontFamily = "'VT323', monospace";
  div.style.fontSize = '18px';
  div.textContent = '> ' + BOOT_LINES[bootIdx];
  bootLinesEl.appendChild(div);
  bootLinesEl.scrollTop = bootLinesEl.scrollHeight;

  const pct = Math.round((bootIdx+1)/BOOT_LINES.length*100);
  const filled = Math.round(pct/10);
  bootProg.textContent = progChars.slice(0,filled) + emptyChars.slice(filled) + ' ' + pct + '%';

  bootIdx++;
  setTimeout(bootTick, 120 + Math.random()*180);
}
setTimeout(bootTick, 300);

// ‚îÄ‚îÄ OS STATE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const state = {
  totalScore: 0,
  mazeLevel: 1,
  mazeScore: 0,
  mazeRank: 'GHOST',
  secretKonamiPos: 0,
  secretMouseTrail: [],
  skillRating: 0,
  achievedLevels: [],
  depthShift: 0,
};

// Konami-inspired secret: Up Up Down Down Left Right Left Right B A
// (using keyboard, but also need a MOUSE gesture: draw a Z on screen)
const SECRET_SEQUENCE = ['ArrowUp','ArrowUp','ArrowDown','ArrowDown',
  'ArrowLeft','ArrowRight','ArrowLeft','ArrowRight','KeyB','KeyA'];

// ‚îÄ‚îÄ WINDOW MANAGEMENT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let dragState = null;
let resizeState = null;

function startDrag(e, id) {
  if (e.target.classList.contains('win-btn')) return;
  focusWin(id);
  const win = document.getElementById(id);
  const rect = win.getBoundingClientRect();
  dragState = { id, startX: e.clientX, startY: e.clientY,
    winX: parseInt(win.style.left)||rect.left,
    winY: parseInt(win.style.top)||rect.top };
  e.preventDefault();
}
function startResize(e, id) {
  focusWin(id);
  const win = document.getElementById(id);
  resizeState = { id, startX:e.clientX, startY:e.clientY,
    w:win.offsetWidth, h:win.offsetHeight };
  e.preventDefault(); e.stopPropagation();
}
document.addEventListener('mousemove', e => {
  if (dragState) {
    const win = document.getElementById(dragState.id);
    win.style.left = (dragState.winX + e.clientX - dragState.startX) + 'px';
    win.style.top  = (dragState.winY + e.clientY - dragState.startY) + 'px';
  }
  if (resizeState) {
    const win = document.getElementById(resizeState.id);
    win.style.width  = Math.max(200, resizeState.w + e.clientX - resizeState.startX) + 'px';
    win.style.height = Math.max(100, resizeState.h + e.clientY - resizeState.startY) + 'px';
    if (resizeState.id === 'sigApp') resizeSigCanvas();
    if (resizeState.id === 'nodeApp') resizeNodeCanvas();
  }
  // Track mouse for secret Z gesture
  state.secretMouseTrail.push({x:e.clientX, y:e.clientY, t:Date.now()});
  if (state.secretMouseTrail.length > 80) state.secretMouseTrail.shift();
});
document.addEventListener('mouseup', () => { dragState=null; resizeState=null; });

function focusWin(id) {
  document.querySelectorAll('.win').forEach(w=>w.classList.remove('focused'));
  const win = document.getElementById(id);
  if (win) {
    win.classList.add('focused');
    win.style.display = 'flex';
    const all = document.querySelectorAll('.win');
    let maxZ = 10;
    all.forEach(w=>{const z=parseInt(w.style.zIndex)||10; if(z>maxZ) maxZ=z;});
    win.style.zIndex = maxZ + 1;
  }
  document.querySelectorAll('.tb-app-btn').forEach(b=>b.classList.remove('active'));
  const map = {termApp:'TERMINAL',sigApp:'SIGNAL MON',nodeApp:'NODE MAP',
    mazeApp:'CIPHER MAZE',packetApp:'PKT TRACE',viralApp:'VIRAL SIM'};
  document.querySelectorAll('.tb-app-btn').forEach(b=>{
    if(b.textContent.trim()===map[id]) b.classList.add('active');
  });
}

function closeWin(id) {
  const win = document.getElementById(id);
  if (win) win.style.display = 'none';
}
function minWin(id) {
  const win = document.getElementById(id);
  if (win) win.style.display = win.style.display==='none' ? 'flex' : 'none';
}
function maxWin(id) {
  const win = document.getElementById(id);
  if (!win) return;
  if (win.dataset.prev) {
    const p = JSON.parse(win.dataset.prev);
    win.style.left=p.l; win.style.top=p.t;
    win.style.width=p.w; win.style.height=p.h;
    delete win.dataset.prev;
  } else {
    win.dataset.prev=JSON.stringify({l:win.style.left,t:win.style.top,
      w:win.style.width,h:win.style.height});
    win.style.left='0'; win.style.top='0';
    win.style.width='100%'; win.style.height='calc(100vh - 28px)';
  }
}
function showAllWindows() {
  document.querySelectorAll('.win').forEach(w=>w.style.display='flex');
  hideCtxMenu();
}
function spawnWindow() { focusWin('termApp'); hideCtxMenu(); }

// Context menu
function showCtxMenu(e) {
  e.preventDefault();
  const m = document.getElementById('ctxMenu');
  m.style.left=e.clientX+'px'; m.style.top=e.clientY+'px';
  m.classList.add('show');
}
function hideCtxMenu() {
  document.getElementById('ctxMenu').classList.remove('show');
}
document.addEventListener('click', ()=>hideCtxMenu());

// ‚îÄ‚îÄ NOTIFICATIONS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function notify(msg, type='', duration=3000) {
  const s = document.getElementById('notifStack');
  const n = document.createElement('div');
  n.className = 'notif ' + type;
  n.textContent = msg;
  s.appendChild(n);
  setTimeout(()=>n.remove(), duration);
}

// ‚îÄ‚îÄ CLOCK ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function updateClock() {
  const now = new Date();
  const pad = n=>String(n).padStart(2,'0');
  document.getElementById('tbClock').textContent =
    `${pad(now.getHours())}:${pad(now.getMinutes())}:${pad(now.getSeconds())}`;
  state.depthShift += 0.0001;
  document.getElementById('depthVal').textContent =
    (4.711 + Math.sin(state.depthShift)*0.002).toFixed(5);
}
setInterval(updateClock, 1000);
updateClock();

// ‚ïê‚ïê MATRIX RAIN ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const rainCanvas = document.getElementById('rainCanvas');
const rainCtx = rainCanvas.getContext('2d');
let rainCols = [], rainH, rainW;
const RAIN_CHARS = '„Ç¢„Ç§„Ç¶„Ç®„Ç™„Ç´„Ç≠„ÇØ„Ç±„Ç≥„Çµ„Ç∑„Çπ„Çª„ÇΩ„Çø„ÉÅ„ÉÑ„ÉÜ„Éà„Éä„Éã„Éå„Éç„Éé„Éè„Éí„Éï„Éò„Éõ„Éû„Éü„É†„É°„É¢„É§„É¶„É®0123456789ABCDEF‚Üë‚Üì‚Üê‚Üí‚ñà‚ñì‚ñí‚ñë';

function initRain() {
  rainW = rainCanvas.width = rainCanvas.offsetWidth;
  rainH = rainCanvas.height = rainCanvas.offsetHeight;
  const cols = Math.floor(rainW / 14);
  rainCols = Array.from({length:cols}, ()=>({
    y: Math.random() * rainH,
    speed: 1 + Math.random() * 3,
    len: 8 + Math.floor(Math.random() * 20),
    chars: Array.from({length:30}, ()=>RAIN_CHARS[Math.floor(Math.random()*RAIN_CHARS.length)]),
    changeTimer: 0,
  }));
}

function drawRain() {
  rainCtx.fillStyle = 'rgba(0,13,5,0.12)';
  rainCtx.fillRect(0,0,rainW,rainH);
  rainCols.forEach((col, ci) => {
    col.changeTimer++;
    if (col.changeTimer > 4) {
      col.chars[Math.floor(Math.random()*col.chars.length)] =
        RAIN_CHARS[Math.floor(Math.random()*RAIN_CHARS.length)];
      col.changeTimer = 0;
    }
    for (let i=0; i<col.len; i++) {
      const charY = col.y - i * 14;
      if (charY < 0 || charY > rainH) continue;
      const alpha = 1 - i/col.len;
      rainCtx.font = `bold 12px 'Share Tech Mono'`;
      if (i === 0) {
        rainCtx.fillStyle = `rgba(180,255,200,${alpha})`;
      } else {
        rainCtx.fillStyle = `rgba(0,${Math.floor(80+alpha*175)},${Math.floor(20+alpha*40)},${alpha*0.8})`;
      }
      rainCtx.fillText(col.chars[i % col.chars.length], ci*14, charY);
    }
    col.y += col.speed;
    if (col.y - col.len*14 > rainH) {
      col.y = -col.len*14;
      col.speed = 1 + Math.random()*3;
    }
  });
}

// ‚ïê‚ïê SIGNAL MONITOR ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const sigCanvas = document.getElementById('sigCanvas');
const sigCtx = sigCanvas.getContext('2d');
let sigW, sigH;
let sigData = Array.from({length:300}, ()=>({
  carrier: 0.5, noise: 0, anomaly: 0, phase: Math.random()*Math.PI*2
}));
let sigTick = 0;
let anomalyTimer = 0;

function resizeSigCanvas() {
  const wrap = document.getElementById('sigApp').querySelector('.win-body');
  sigW = sigCanvas.width = wrap.offsetWidth;
  sigH = sigCanvas.height = wrap.offsetHeight;
}

function updateSig() {
  sigTick++;
  anomalyTimer--;
  if (anomalyTimer < 0 && Math.random() < 0.002) {
    anomalyTimer = 40 + Math.random()*60;
    notify('‚ö† SIGNAL ANOMALY DETECTED', 'warn', 2000);
  }
  // Shift left
  sigData.shift();
  const base = 0.42 + 0.12*Math.sin(sigTick*0.04) + 0.06*Math.sin(sigTick*0.11);
  const noise = (Math.random()-0.5)*0.06;
  const anomaly = anomalyTimer > 0 ? Math.sin(anomalyTimer*0.3)*0.25 : 0;
  sigData.push({ v: base + noise + anomaly, anomaly: anomalyTimer > 0 });
}

function drawSig() {
  if (!sigW) return;
  sigCtx.fillStyle = 'rgba(0,13,5,0.7)';
  sigCtx.fillRect(0,0,sigW,sigH);

  // Grid
  sigCtx.strokeStyle = '#002a0a';
  sigCtx.lineWidth = 0.5;
  for (let x=0; x<sigW; x+=40) {
    sigCtx.beginPath(); sigCtx.moveTo(x,0); sigCtx.lineTo(x,sigH); sigCtx.stroke();
  }
  for (let y=0; y<sigH; y+=20) {
    sigCtx.beginPath(); sigCtx.moveTo(0,y); sigCtx.lineTo(sigW,y); sigCtx.stroke();
  }

  // Frequency lines
  const drawWave = (offset, color, scale=1) => {
    sigCtx.beginPath();
    sigCtx.strokeStyle = color;
    sigCtx.lineWidth = 1.5;
    const step = sigW / sigData.length;
    sigData.forEach((d,i) => {
      const y = (sigH*0.35) - d.v*(sigH*0.25)*scale + offset;
      i===0 ? sigCtx.moveTo(0,y) : sigCtx.lineTo(i*step, y);
    });
    sigCtx.stroke();
  };

  drawWave(0, '#00ff4155', 1);
  drawWave(sigH*0.5, '#00e5ff55', 0.7);
  drawWave(sigH*0.75, '#ffb80044', 0.5);

  // Main carrier
  sigCtx.beginPath();
  sigCtx.lineWidth = 2;
  const step = sigW / sigData.length;
  sigData.forEach((d,i) => {
    const y = (sigH*0.35) - d.v*(sigH*0.3);
    sigCtx.strokeStyle = d.anomaly ? '#ff2200' : '#00ff41';
    if (i===0) { sigCtx.moveTo(0,y); } else {
      sigCtx.lineTo(i*step,y);
      sigCtx.stroke();
      sigCtx.beginPath();
      sigCtx.moveTo(i*step,y);
    }
  });

  // Labels
  sigCtx.font = "9px 'Share Tech Mono'";
  sigCtx.fillStyle = '#2a5a3a';
  sigCtx.fillText('CARRIER', 4, 12);
  sigCtx.fillText(`${(sigData[sigData.length-1]?.v*100||0).toFixed(2)} MHz`, 4, 24);
  sigCtx.fillStyle = '#004a1a';
  sigCtx.fillText('PHASE_B', 4, sigH*0.5+12);
  sigCtx.fillText('ENTROPY', 4, sigH*0.75+12);

  // Anomaly flag
  if (anomalyTimer > 0) {
    sigCtx.fillStyle = `rgba(255,34,0,${0.3+0.3*Math.sin(Date.now()*0.01)})`;
    sigCtx.font = "11px 'Orbitron'";
    sigCtx.textAlign = 'center';
    sigCtx.fillText('‚ö† ANOMALY DETECTED', sigW/2, sigH-10);
    sigCtx.textAlign = 'left';
  }
}

// ‚ïê‚ïê NODE MAP ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const nodeCanvas = document.getElementById('nodeCanvas');
const nodeCtx = nodeCanvas.getContext('2d');
let nodeW, nodeH;

const NODES = [
  {id:'Z-PRIME', x:0.5, y:0.5, type:'hub', status:'online', load:0.88},
  {id:'R-NODE-1', x:0.2, y:0.25, type:'relay', status:'online', load:0.45},
  {id:'R-NODE-2', x:0.8, y:0.2, type:'relay', status:'online', load:0.71},
  {id:'R-NODE-3', x:0.15, y:0.72, type:'relay', status:'degraded', load:0.92},
  {id:'R-NODE-4', x:0.82, y:0.7, type:'relay', status:'online', load:0.33},
  {id:'SENTINEL-1', x:0.35, y:0.12, type:'watch', status:'alert', load:1.0},
  {id:'SENTINEL-2', x:0.65, y:0.88, type:'watch', status:'online', load:0.56},
  {id:'EXIT-1', x:0.05, y:0.45, type:'exit', status:'online', load:0.2},
  {id:'EXIT-2', x:0.92, y:0.45, type:'exit', status:'offline', load:0},
  {id:'DEEP-1', x:0.42, y:0.78, type:'deep', status:'online', load:0.61},
  {id:'DEEP-2', x:0.58, y:0.28, type:'deep', status:'online', load:0.77},
];
const EDGES = [
  [0,1],[0,2],[0,3],[0,4],[0,9],[0,10],
  [1,5],[1,7],[2,5],[2,10],[3,7],[3,9],[4,6],[4,8],[9,3],[10,2],
];
let nodePackets = [];
let nodeTick = 0;

function resizeNodeCanvas() {
  const wrap = document.getElementById('nodeApp').querySelector('.win-body');
  nodeW = nodeCanvas.width = wrap.offsetWidth;
  nodeH = nodeCanvas.height = wrap.offsetHeight;
}

function drawNodes() {
  if (!nodeW) return;
  nodeCtx.clearRect(0,0,nodeW,nodeH);
  nodeCtx.fillStyle = 'rgba(0,8,3,0.9)';
  nodeCtx.fillRect(0,0,nodeW,nodeH);

  // Grid
  nodeCtx.strokeStyle = '#001a08';
  nodeCtx.lineWidth = 0.5;
  for (let x=0; x<nodeW; x+=30) {
    nodeCtx.beginPath(); nodeCtx.moveTo(x,0); nodeCtx.lineTo(x,nodeH); nodeCtx.stroke();
  }
  for (let y=0; y<nodeH; y+=30) {
    nodeCtx.beginPath(); nodeCtx.moveTo(0,y); nodeCtx.lineTo(nodeW,y); nodeCtx.stroke();
  }

  // Edges
  EDGES.forEach(([a,b]) => {
    const n1 = NODES[a], n2 = NODES[b];
    const x1=n1.x*nodeW, y1=n1.y*nodeH, x2=n2.x*nodeW, y2=n2.y*nodeH;
    const offline = n1.status==='offline'||n2.status==='offline';
    nodeCtx.beginPath();
    nodeCtx.strokeStyle = offline ? '#1a0000' : n1.status==='alert'||n2.status==='alert' ? '#661100' : '#003a15';
    nodeCtx.lineWidth = 1;
    nodeCtx.setLineDash(offline ? [4,8] : []);
    nodeCtx.moveTo(x1,y1); nodeCtx.lineTo(x2,y2); nodeCtx.stroke();
    nodeCtx.setLineDash([]);
  });

  // Packets
  nodeTick++;
  if (nodeTick % 30 === 0 && Math.random() < 0.8) {
    const edge = EDGES[Math.floor(Math.random()*EDGES.length)];
    const n1=NODES[edge[0]], n2=NODES[edge[1]];
    if (n1.status!=='offline' && n2.status!=='offline') {
      nodePackets.push({
        x1:n1.x*nodeW, y1:n1.y*nodeH,
        x2:n2.x*nodeW, y2:n2.y*nodeH,
        t:0, hostile:Math.random()<0.08,
      });
    }
  }
  nodePackets = nodePackets.filter(p=>{
    p.t += 0.04;
    if (p.t >= 1) return false;
    const x = p.x1 + (p.x2-p.x1)*p.t;
    const y = p.y1 + (p.y2-p.y1)*p.t;
    nodeCtx.beginPath();
    nodeCtx.arc(x,y,3,0,Math.PI*2);
    nodeCtx.fillStyle = p.hostile ? '#ff2200' : '#00ff41';
    nodeCtx.fill();
    if (p.hostile) {
      nodeCtx.beginPath();
      nodeCtx.arc(x,y,6,0,Math.PI*2);
      nodeCtx.strokeStyle = 'rgba(255,34,0,0.4)';
      nodeCtx.lineWidth=1; nodeCtx.stroke();
    }
    return true;
  });

  // Draw nodes
  NODES.forEach(n => {
    const x=n.x*nodeW, y=n.y*nodeH;
    const colors = {hub:'#00ff41',relay:'#00e5ff',watch:'#ffb800',exit:'#00ff41',deep:'#8866ff'};
    const col = n.status==='offline' ? '#331100' : n.status==='alert' ? '#ff2200' : n.status==='degraded' ? '#ffb800' : colors[n.type];
    const r = n.type==='hub' ? 10 : n.type==='watch' ? 8 : 6;

    // Glow
    const grad = nodeCtx.createRadialGradient(x,y,0,x,y,r*3);
    grad.addColorStop(0, col+'44'); grad.addColorStop(1, 'transparent');
    nodeCtx.fillStyle = grad;
    nodeCtx.beginPath(); nodeCtx.arc(x,y,r*3,0,Math.PI*2); nodeCtx.fill();

    nodeCtx.beginPath(); nodeCtx.arc(x,y,r,0,Math.PI*2);
    nodeCtx.fillStyle = col+'88'; nodeCtx.fill();
    nodeCtx.strokeStyle = col; nodeCtx.lineWidth=1.5; nodeCtx.stroke();

    // Load bar
    const bw=30, bh=3;
    nodeCtx.fillStyle='#001a08';
    nodeCtx.fillRect(x-bw/2, y+r+4, bw, bh);
    nodeCtx.fillStyle = n.load>0.8?'#ff2200':n.load>0.6?'#ffb800':'#00ff41';
    nodeCtx.fillRect(x-bw/2, y+r+4, bw*n.load, bh);

    nodeCtx.font="8px 'Share Tech Mono'";
    nodeCtx.fillStyle='#4aaa5a';
    nodeCtx.textAlign='center';
    nodeCtx.fillText(n.id, x, y-r-4);
    nodeCtx.textAlign='left';

    // Pulse for alerts
    if (n.status==='alert') {
      const pulse = 0.5+0.5*Math.sin(Date.now()*0.008);
      nodeCtx.beginPath(); nodeCtx.arc(x,y,r+4+pulse*4,0,Math.PI*2);
      nodeCtx.strokeStyle=`rgba(255,34,0,${0.3+pulse*0.4})`;
      nodeCtx.lineWidth=1; nodeCtx.stroke();
    }
  });

  // Legend
  nodeCtx.font = "9px 'Share Tech Mono'";
  nodeCtx.fillStyle='#2a5a3a';
  nodeCtx.fillText('‚óâ HUB  ‚óã RELAY  ‚ñ≥ WATCH  ‚óá EXIT  ‚¨° DEEP', 6, nodeH-6);
}

// ‚ïê‚ïê TERMINAL ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const TERM_CMDS = {
  help: () => [
    {t:'info', m:'Available commands:'},
    {t:'sys', m:'  help         ‚Äî show this menu'},
    {t:'sys', m:'  status       ‚Äî system status report'},
    {t:'sys', m:'  scan         ‚Äî scan carrier frequencies'},
    {t:'sys', m:'  nodes        ‚Äî list active network nodes'},
    {t:'sys', m:'  ping [id]    ‚Äî ping a node'},
    {t:'sys', m:'  trace        ‚Äî run packet trace'},
    {t:'sys', m:'  decrypt [n]  ‚Äî attempt cipher decryption'},
    {t:'sys', m:'  maze         ‚Äî open cipher maze'},
    {t:'sys', m:'  viral        ‚Äî open viral sim'},
    {t:'sys', m:'  uptime       ‚Äî show system uptime'},
    {t:'sys', m:'  clear        ‚Äî clear terminal'},
    {t:'warn', m:'  [CLASSIFIED] ‚Äî additional commands exist'},
  ],
  status: () => {
    const integrity = (95+Math.random()*5).toFixed(2);
    const load = (30+Math.random()*40).toFixed(1);
    return [
      {t:'success', m:'SYSTEM STATUS REPORT'},
      {t:'sys', m:`  Carrier freq:    1847.${Math.floor(Math.random()*99).toString().padStart(2,'0')} MHz`},
      {t:'sys', m:`  Signal coherence: 99.97%`},
      {t:'sys', m:`  Active nodes:    ${NODES.filter(n=>n.status!=='offline').length}/${NODES.length}`},
      {t:'sys', m:`  CPU load:        ${load}%`},
      {t:'sys', m:`  Memory integrity:${integrity}%`},
      {t:'sys', m:`  Depth layer:     OMEGA-7`},
      {t:'sys', m:`  Anomalies:       ${Math.floor(Math.random()*5)}`},
      {t:'info', m:`  Uptime:         ${Math.floor(performance.now()/1000)}s`},
    ];
  },
  scan: () => {
    const freqs = Array.from({length:6}, (_,i)=>{
      const f=(1840+i*4+Math.random()*3).toFixed(2);
      const s=Math.random();
      const type=s>0.9?'ANOMALOUS':s>0.6?'CARRIER':'NOISE';
      return {t:type==='ANOMALOUS'?'err':type==='CARRIER'?'success':'sys',
        m:`  ${f.padEnd(10)} MHz ‚Äî ${type.padEnd(12)} sig:${(s*100).toFixed(0).padStart(3)}%`};
    });
    return [{t:'info',m:'Scanning carrier bands...'},...freqs,{t:'sys',m:'Scan complete.'}];
  },
  nodes: () => NODES.map(n=>({
    t: n.status==='offline'?'err':n.status==='alert'?'warn':n.status==='degraded'?'warn':'sys',
    m:`  ${n.id.padEnd(14)} [${n.status.toUpperCase().padEnd(8)}] load:${(n.load*100).toFixed(0).padStart(3)}%  type:${n.type}`
  })),
  uptime: () => [{t:'sys', m:`System uptime: ${Math.floor(performance.now()/1000)}s (since boot)`}],
  maze: () => { focusWin('mazeApp'); return [{t:'success',m:'Opening CIPHER_MAZE...'}]; },
  viral: () => { focusWin('viralApp'); return [{t:'success',m:'Opening INTRUSION_SIM...'}]; },
  clear: () => { termClear(); return []; },
};

function termClear() {
  document.getElementById('termOutput').innerHTML = '';
}

function termExec(cmd) {
  const parts = cmd.trim().split(/\s+/);
  const base = parts[0].toLowerCase();
  const arg = parts.slice(1).join(' ');

  termPrint({t:'info', m:`broadcast@œâ7 ~$ ${cmd}`});

  if (base === '') return;

  // Secret: if user types "whoami" they get a hint
  if (base === 'whoami') {
    termPrint({t:'warn', m:'  You are an Operator. But are you sure that\'s all you are?'});
    termPrint({t:'sys', m:'  There are layers beneath this terminal. Find them.'});
    return;
  }

  if (base === 'ping') {
    const target = arg || NODES[Math.floor(Math.random()*NODES.length)].id;
    const node = NODES.find(n=>n.id===target.toUpperCase());
    if (!node) { termPrint({t:'err',m:`  ping: unknown host: ${target}`}); return; }
    if (node.status==='offline') { termPrint({t:'err',m:`  Request timeout for node ${target}`}); return; }
    const ms = (10+Math.random()*40).toFixed(1);
    for(let i=1;i<=4;i++) termPrint({t:'sys',m:`  Reply from ${node.id}: bytes=32 time=${(parseFloat(ms)+Math.random()*5).toFixed(1)}ms TTL=${64-i}`});
    termPrint({t:'success',m:`  Ping statistics ‚Äî Sent:4, Rcvd:4, Lost:0 (0% loss)`});
    return;
  }

  if (base === 'trace') {
    focusWin('packetApp');
    termPrint({t:'success',m:'  PACKET_TRACE opened.'});
    return;
  }

  if (base === 'decrypt') {
    const n = parseInt(arg) || Math.floor(Math.random()*999+100);
    termPrint({t:'info',m:`  Attempting cipher decryption on block ${n}...`});
    setTimeout(()=>termPrint({t:Math.random()<0.6?'success':'err',
      m:Math.random()<0.6?`  Decryption successful. Plaintext recovered.`:`  Decryption failed ‚Äî key mismatch.`}),800);
    return;
  }

  const fn = TERM_CMDS[base];
  if (fn) { fn().forEach(l=>termPrint(l)); }
  else termPrint({t:'err', m:`  command not found: ${base}`});
}

function termPrint(line) {
  const out = document.getElementById('termOutput');
  const div = document.createElement('div');
  div.className = 'term-line ' + (line.t||'');
  div.textContent = line.m;
  out.appendChild(div);
  out.scrollTop = out.scrollHeight;
}

document.getElementById('termInput').addEventListener('keydown', e => {
  if (e.key === 'Enter') {
    const val = e.target.value;
    termExec(val);
    e.target.value = '';
  }
});

// ‚ïê‚ïê PACKET TRACE ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const PKT_SOURCES = ['192.168.0.1','10.0.7.23','172.16.4.5','127.0.0.1','10.99.0.2'];
const PKT_DESTS   = ['ZION_HUB','R-NODE-4','EXIT-1','DEEP-1','R-NODE-2'];
const PKT_DATA_TYPES = ['SYN/ACK','HANDSHAKE','DATA_BLOCK','AUTH_TOKEN','BEACON','HEARTBEAT','ANOMALY_PROBE'];
let pktCount = 0;

function spawnPacket() {
  const log = document.getElementById('packetLog');
  const hostile = Math.random() < 0.07;
  const alert = Math.random() < 0.15;
  const flag = hostile ? 'hostile' : alert ? 'alert' : 'normal';
  const flagText = hostile ? 'HOSTILE' : alert ? 'WARN' : 'OK';
  const src = PKT_SOURCES[Math.floor(Math.random()*PKT_SOURCES.length)];
  const dst = PKT_DESTS[Math.floor(Math.random()*PKT_DESTS.length)];
  const dtype = PKT_DATA_TYPES[Math.floor(Math.random()*PKT_DATA_TYPES.length)];
  const size = (64+Math.random()*1400).toFixed(0);
  const now = new Date();
  const ts = `${String(now.getHours()).padStart(2,'0')}:${String(now.getMinutes()).padStart(2,'0')}:${String(now.getSeconds()).padStart(2,'0')}`;

  const div = document.createElement('div');
  div.className = 'pkt-line';
  div.innerHTML = `<span class="pkt-time">${ts}</span><span class="pkt-src">${src}</span><span class="pkt-dst">${dst}</span><span class="pkt-data">${dtype} [${size}B]</span><span class="pkt-flag ${flag}">${flagText}</span>`;
  log.appendChild(div);
  while (log.children.length > 40) log.removeChild(log.children[1]);
  log.scrollTop = log.scrollHeight;

  if (hostile) notify(`üî¥ HOSTILE PACKET: ${src} ‚Üí ${dst}`, 'err', 3000);
  pktCount++;
}
setInterval(spawnPacket, 600 + Math.random()*400);

// ‚ïê‚ïê CIPHER MAZE ‚Äî SKILL GAP ENGINE ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// Scientific basis:
// - Csikszentmihalyi Flow: challenge slightly > skill = optimal engagement
// - Variable ratio schedule: reward unpredictability maximises dopamine
// - Exponential difficulty scaling with guaranteed reward threshold
// - Competence feedback loop: visible metrics sustain intrinsic motivation
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

const maze = {
  canvas: document.getElementById('mazeCanvas'),
  ctx: null,
  grid: [],
  rows: 15, cols: 20,
  cellW: 0, cellH: 0,
  player: {x:0, y:0},
  exit: {x:0, y:0},
  keys: {},
  enemies: [],
  collectibles: [],
  traps: [],
  level: 1,
  score: 0,
  totalScore: 0,
  timer: 120,
  timerInterval: null,
  moveCount: 0,
  startTime: 0,
  running: false,
  rankBrackets: ['GHOST','RECON','CIPHER','BREACH','ORACLE','ARCHITECT'],
  rankIdx: 0,
  xp: 0,
  xpToNext: 100,
  // Flow state: track last N solve times to calibrate
  solveHistory: [],
};

maze.ctx = maze.canvas.getContext('2d');

// Generate a maze using recursive backtracking
function generateMaze(rows, cols) {
  // Each cell: {walls:[N,E,S,W], visited:false}
  const grid = Array.from({length:rows}, ()=>
    Array.from({length:cols}, ()=>({walls:[1,1,1,1], visited:false})));

  function carve(r,c) {
    grid[r][c].visited = true;
    const dirs = [[0,1,1,3],[1,0,2,0],[-1,0,0,2],[0,-1,3,1]].sort(()=>Math.random()-0.5);
    // [dr, dc, wallA, wallB] for [E,S,N,W]
    for (const [dr,dc,wa,wb] of dirs) {
      const nr=r+dr, nc=c+dc;
      if (nr>=0&&nr<rows&&nc>=0&&nc<cols&&!grid[nr][nc].visited) {
        grid[r][c].walls[wa]=0;
        grid[nr][nc].walls[wb]=0;
        carve(nr,nc);
      }
    }
  }
  carve(0,0);
  return grid;
}

// Skill-gap difficulty: adds extra walls (corridors), enemies, timers
function getDifficultyParams(level) {
  // Flow theory: difficulty ramps ~10% above current player skill
  // Guaranteed solvable + reward at any skill level
  const tier = Math.min(Math.floor((level-1)/3), 5);
  return {
    rows: 10 + tier*3,
    cols: 14 + tier*3,
    enemies: tier < 1 ? 0 : 1 + Math.floor(tier*1.5),
    collectibles: 3 + tier,
    traps: tier,
    timeLimit: Math.max(30, 180 - level*8),
    enemySpeed: 0.008 + tier*0.004,
    // Score multiplier increases faster than difficulty (reward gradient)
    scoreMultiplier: 1 + tier*0.6,
    bonusWindow: Math.max(10, 60 - level*3), // time bonus window
  };
}

function initMaze() {
  const params = getDifficultyParams(maze.level);
  maze.rows = params.rows;
  maze.cols = params.cols;
  maze.cellW = maze.canvas.width / maze.cols;
  maze.cellH = maze.canvas.height / maze.rows;
  maze.grid = generateMaze(maze.rows, maze.cols);
  maze.player = {x:0, y:0, px:0, py:0, animT:1};
  maze.exit = {x:maze.cols-1, y:maze.rows-1};
  maze.timer = params.timeLimit;
  maze.moveCount = 0;
  maze.startTime = Date.now();
  maze.running = true;
  maze.keys = {};

  // Extra corridors for higher levels (loosen dead-ends a bit)
  if (maze.level > 4) {
    for (let i=0; i<maze.rows*maze.cols*0.05; i++) {
      const r=Math.floor(Math.random()*maze.rows);
      const c=Math.floor(Math.random()*maze.cols);
      const d=Math.floor(Math.random()*4);
      const opp=[2,3,0,1];
      const dr=[-1,0,1,0], dc=[0,1,0,-1];
      const nr=r+dr[d], nc=c+dc[d];
      if(nr>=0&&nr<maze.rows&&nc>=0&&nc<maze.cols){
        maze.grid[r][c].walls[d]=0;
        maze.grid[nr][nc].walls[opp[d]]=0;
      }
    }
  }

  // Enemies (patrol paths)
  maze.enemies = Array.from({length:params.enemies}, ()=>{
    const ex = 1+Math.floor(Math.random()*(maze.cols-2));
    const ey = 1+Math.floor(Math.random()*(maze.rows-2));
    return {x:ex, y:ey, fx:ex, fy:ey, dx:0, dy:0,
      moveTimer:0, speed:params.enemySpeed,
      path:[], pathIdx:0, patrol:true};
  });

  // Collectibles (data fragments)
  maze.collectibles = Array.from({length:params.collectibles}, ()=>{
    let cx,cy;
    do { cx=Math.floor(Math.random()*maze.cols); cy=Math.floor(Math.random()*maze.rows); }
    while (cx===0&&cy===0||cx===maze.cols-1&&cy===maze.rows-1);
    return {x:cx, y:cy, collected:false, value:10+Math.floor(Math.random()*20),
      pulse:Math.random()*Math.PI*2};
  });

  // Traps
  maze.traps = Array.from({length:params.traps}, ()=>{
    let tx,ty;
    do { tx=1+Math.floor(Math.random()*(maze.cols-2)); ty=1+Math.floor(Math.random()*(maze.rows-2)); }
    while (tx===0&&ty===0);
    return {x:tx, y:ty, active:true, triggerTimer:0};
  });

  // Update HUD
  document.getElementById('mazeLevel').textContent = `Œ£-${String(maze.level).padStart(2,'0')}`;
  updateDifficultyPips(params);
  updateMazeRankHUD();

  if (maze.timerInterval) clearInterval(maze.timerInterval);
  maze.timerInterval = setInterval(()=>{
    if (!maze.running) return;
    maze.timer--;
    document.getElementById('mazeTimer').textContent = maze.timer + 's';
    if (maze.timer <= 10) {
      document.getElementById('mazeTimer').style.color = '#ff2200';
    }
    if (maze.timer <= 0) {
      maze.running = false;
      clearInterval(maze.timerInterval);
      mazeTimeout();
    }
  }, 1000);
}

function updateDifficultyPips(params) {
  const container = document.getElementById('mazeDiff');
  container.innerHTML = '';
  const total = 8;
  const tier = Math.min(Math.floor((maze.level-1)/3), 7);
  for (let i=0;i<total;i++) {
    const pip = document.createElement('div');
    pip.className = 'diff-pip';
    if (i < tier) pip.classList.add(tier>5?'danger':tier>3?'warn':'active');
    container.appendChild(pip);
  }
}

function updateMazeRankHUD() {
  document.getElementById('mazeScore').textContent = maze.totalScore;
  document.getElementById('mazeRank').textContent = maze.rankBrackets[Math.min(maze.rankIdx, maze.rankBrackets.length-1)];
}

// BFS pathfinding for enemies
function bfsMaze(grid, fromX, fromY, toX, toY, rows, cols) {
  const visited = Array.from({length:rows}, ()=>new Array(cols).fill(false));
  const parent = Array.from({length:rows}, ()=>new Array(cols).fill(null));
  const queue = [[fromX,fromY]];
  visited[fromY][fromX] = true;
  const drs=[-1,0,1,0], dcs=[0,1,0,-1];
  while(queue.length) {
    const [cx,cy] = queue.shift();
    if (cx===toX&&cy===toY) {
      const path=[];
      let x=toX,y=toY;
      while(!(x===fromX&&y===fromY)){const p=parent[y][x];path.unshift({x,y});x=p[0];y=p[1];}
      return path;
    }
    for(let d=0;d<4;d++){
      if(grid[cy][cx].walls[d]===0){
        const nx=cx+dcs[d],ny=cy+drs[d];
        if(nx>=0&&nx<cols&&ny>=0&&ny<rows&&!visited[ny][nx]){
          visited[ny][nx]=true; parent[ny][nx]=[cx,cy]; queue.push([nx,ny]);
        }
      }
    }
  }
  return [];
}

let mazeAnimFrame = 0;
let enemyUpdateTimer = 0;

function drawMaze() {
  mazeAnimFrame++;
  const c = maze.ctx, cw = maze.cellW, ch = maze.cellH;
  c.clearRect(0,0,maze.canvas.width,maze.canvas.height);

  // Background
  c.fillStyle = '#000d05';
  c.fillRect(0,0,maze.canvas.width,maze.canvas.height);

  if (!maze.running && maze.grid.length===0) {
    c.fillStyle = '#00ff41';
    c.font="14px 'Orbitron'";
    c.textAlign='center';
    c.fillText('INITIALISING...', maze.canvas.width/2, maze.canvas.height/2);
    c.textAlign='left';
    return;
  }

  // Draw cells
  for (let r=0; r<maze.rows; r++) {
    for (let cc2=0; cc2<maze.cols; cc2++) {
      const cell = maze.grid[r][cc2];
      const x=cc2*cw, y=r*ch;
      const wallCol = '#003a15';
      const wallW = 1.5;
      c.strokeStyle = wallCol;
      c.lineWidth = wallW;
      if(cell.walls[0]){c.beginPath();c.moveTo(x,y);c.lineTo(x+cw,y);c.stroke();}
      if(cell.walls[1]){c.beginPath();c.moveTo(x+cw,y);c.lineTo(x+cw,y+ch);c.stroke();}
      if(cell.walls[2]){c.beginPath();c.moveTo(x,y+ch);c.lineTo(x+cw,y+ch);c.stroke();}
      if(cell.walls[3]){c.beginPath();c.moveTo(x,y);c.lineTo(x,y+ch);c.stroke();}
    }
  }

  // Exit node
  const ex2=maze.exit.x, ey2=maze.exit.y;
  const exCX=ex2*cw+cw/2, eyCY=ey2*ch+ch/2;
  const pulse = 0.5+0.5*Math.sin(mazeAnimFrame*0.08);
  const grad2 = c.createRadialGradient(exCX,eyCY,0,exCX,eyCY,cw*0.8);
  grad2.addColorStop(0,`rgba(0,229,255,${0.3+pulse*0.3})`); grad2.addColorStop(1,'transparent');
  c.fillStyle=grad2; c.fillRect(ex2*cw,ey2*ch,cw,ch);
  c.fillStyle='#00e5ff'; c.font=`${Math.floor(cw*0.6)}px monospace`;
  c.textAlign='center'; c.textBaseline='middle';
  c.fillText('‚¨°', exCX, eyCY);
  c.textAlign='left'; c.textBaseline='alphabetic';

  // Collectibles
  maze.collectibles.forEach(col=>{
    if(col.collected) return;
    col.pulse+=0.06;
    const cx2=col.x*cw+cw/2, cy2=col.y*ch+ch/2;
    const a=0.6+0.4*Math.sin(col.pulse);
    c.fillStyle=`rgba(255,184,0,${a})`;
    c.beginPath(); c.arc(cx2,cy2,cw*0.2,0,Math.PI*2); c.fill();
    c.strokeStyle='#ffb800'; c.lineWidth=1;
    c.beginPath(); c.arc(cx2,cy2,cw*0.3+Math.sin(col.pulse)*2,0,Math.PI*2); c.stroke();
  });

  // Traps
  maze.traps.forEach(trap=>{
    if(!trap.active) return;
    const tx2=trap.x*cw+cw/2, ty2=trap.y*ch+ch/2;
    trap.triggerTimer = Math.max(0,trap.triggerTimer-1);
    const col2 = trap.triggerTimer>0 ? '#ff4400' : '#330000';
    c.strokeStyle=col2; c.lineWidth=1;
    c.beginPath();
    for(let i=0;i<6;i++){
      const a2=(i/6)*Math.PI*2;
      const r2=cw*0.25;
      i===0?c.moveTo(tx2+Math.cos(a2)*r2,ty2+Math.sin(a2)*r2):c.lineTo(tx2+Math.cos(a2)*r2,ty2+Math.sin(a2)*r2);
    }
    c.closePath(); c.stroke();
  });

  // Enemies (tracking agents)
  enemyUpdateTimer++;
  maze.enemies.forEach(en=>{
    // Update position with smooth interpolation
    en.animT = Math.min(1,(en.animT||1)+0.12);
    const drawX = (en.prevX||en.x)*cw+cw/2 + ((en.x-((en.prevX||en.x)))*cw)*(en.animT);
    const drawY = (en.prevY||en.y)*ch+ch/2 + ((en.y-((en.prevY||en.y)))*ch)*(en.animT);

    // Move every N frames (BFS towards player)
    if(enemyUpdateTimer % 40 === 0) {
      const path = bfsMaze(maze.grid,en.x,en.y,maze.player.x,maze.player.y,maze.rows,maze.cols);
      if(path.length>0){en.prevX=en.x;en.prevY=en.y;en.x=path[0].x;en.y=path[0].y;en.animT=0;}
    }

    c.fillStyle='rgba(255,34,0,0.15)'; c.beginPath(); c.arc(drawX,drawY,cw*0.7,0,Math.PI*2); c.fill();
    c.fillStyle='#ff2200'; c.font=`${Math.floor(cw*0.55)}px monospace`;
    c.textAlign='center'; c.textBaseline='middle';
    c.fillText('‚óâ', drawX, drawY);
    c.textAlign='left'; c.textBaseline='alphabetic';

    // Collision check
    if(en.x===maze.player.x&&en.y===maze.player.y) {
      maze.score = Math.max(0, maze.score - 15);
      notify('‚ö† AGENT CONTACT ‚Äî EVADE!', 'err', 2000);
      // Teleport enemy away
      en.x=Math.floor(Math.random()*maze.cols); en.y=Math.floor(Math.random()*maze.rows);
    }
  });

  // Player
  const px=maze.player.x*cw+cw/2, py=maze.player.y*ch+ch/2;
  const pGrad = c.createRadialGradient(px,py,0,px,py,cw*0.6);
  pGrad.addColorStop(0,'rgba(0,255,65,0.4)'); pGrad.addColorStop(1,'transparent');
  c.fillStyle=pGrad; c.beginPath(); c.arc(px,py,cw*0.6,0,Math.PI*2); c.fill();
  c.fillStyle='#00ff41';
  c.font=`bold ${Math.floor(cw*0.6)}px 'Share Tech Mono'`;
  c.textAlign='center'; c.textBaseline='middle';
  c.fillText('‚óà', px, py);
  c.textAlign='left'; c.textBaseline='alphabetic';

  // Score in-canvas
  c.fillStyle='#002a0a';
  c.fillRect(0,0,maze.canvas.width,12);
  c.fillStyle='#4aaa5a'; c.font="9px 'Share Tech Mono'"; c.textAlign='left';
  c.fillText(`LVL ${String(maze.level).padStart(2,'0')} | SCORE ${maze.score} | MOVES ${maze.moveCount}`, 6, 9);
  c.textAlign='right';
  c.fillText(`RANK: ${maze.rankBrackets[maze.rankIdx]}`, maze.canvas.width-6, 9);
  c.textAlign='left';
}

function mazeMove(dx, dy) {
  if (!maze.running) return;
  const nx = maze.player.x + dx, ny = maze.player.y + dy;
  if (nx < 0||nx>=maze.cols||ny<0||ny>=maze.rows) return;
  // Wall check
  const wallIdx = dy<0?0:dx>0?1:dy>0?2:3;
  if (maze.grid[maze.player.y][maze.player.x].walls[wallIdx]) return;

  maze.player.x=nx; maze.player.y=ny;
  maze.moveCount++;

  // Collect fragments
  maze.collectibles.forEach(col=>{
    if(!col.collected&&col.x===nx&&col.y===ny){
      col.collected=true;
      maze.score+=col.value;
      maze.totalScore+=col.value;
      notify(`‚óÜ DATA FRAGMENT +${col.value}`, '', 1500);
    }
  });

  // Trap check
  maze.traps.forEach(trap=>{
    if(trap.active&&trap.x===nx&&trap.y===ny){
      trap.triggerTimer=20;
      maze.score=Math.max(0,maze.score-20);
      notify('‚ö† TRAP TRIGGERED -20', 'warn', 2000);
    }
  });

  // Exit check
  if (nx===maze.exit.x&&ny===maze.exit.y) {
    mazeWin();
  }
}

function mazeWin() {
  maze.running = false;
  clearInterval(maze.timerInterval);

  const elapsed = (Date.now()-maze.startTime)/1000;
  const timeBonus = Math.max(0, Math.round((maze.timer/getDifficultyParams(maze.level).timeLimit)*50));
  const efficiencyBonus = Math.max(0, Math.round(50 - maze.moveCount*0.3));
  const levelBonus = maze.level * 25;
  const multiplier = getDifficultyParams(maze.level).scoreMultiplier;
  const roundScore = Math.round((timeBonus + efficiencyBonus + levelBonus + maze.score)*multiplier);

  maze.totalScore += roundScore;
  maze.solveHistory.push(elapsed);

  // XP & rank progression (flow state management)
  const xpGain = roundScore;
  maze.xp += xpGain;
  while (maze.xp >= maze.xpToNext && maze.rankIdx < maze.rankBrackets.length-1) {
    maze.xp -= maze.xpToNext;
    maze.xpToNext = Math.round(maze.xpToNext * 1.7); // exponential curve
    maze.rankIdx++;
    notify(`üèÖ RANK UP ‚Üí ${maze.rankBrackets[maze.rankIdx]}`, '', 4000);
  }

  // Reward overlay
  const msgs = [
    ['', 'Layer cleared. Pathway confirmed.'],
    ['CLEAN RUN', 'No contact with agents. Exceptional routing.'],
    ['RAPID CLEAR', 'Time bonus achieved. Neural response optimal.'],
    ['EFFICIENCY', 'Move count minimised. Pattern recognition engaged.'],
    ['ARCHITECT LEVEL', 'You see it, don\'t you? The structure beneath.'],
  ];
  const perfIdx = Math.min(Math.floor(roundScore/100), msgs.length-1);
  document.getElementById('rewardTitle').textContent = perfIdx>0 ? msgs[perfIdx][0] : 'LAYER CLEARED';
  document.getElementById('rewardScore').textContent = `+${roundScore}`;
  document.getElementById('rewardMsg').innerHTML =
    `${msgs[perfIdx][1]}<br><span style="color:#2a5a3a">Time bonus: +${timeBonus} | Efficiency: +${efficiencyBonus} | Level: +${levelBonus}</span><br><span style="color:#4aaa5a">Total clearance: ${maze.totalScore}</span>`;

  const pctToNext = Math.min(100,(maze.xp/maze.xpToNext)*100);
  document.getElementById('rewardSkillBar').style.width = pctToNext+'%';
  document.getElementById('rewardOverlay').classList.add('show');
  updateMazeRankHUD();
}

function mazeTimeout() {
  // Even on timeout, give partial credit (Rocket League: you still got XP for goals)
  const partialScore = Math.max(5, maze.score);
  maze.totalScore += partialScore;
  notify(`‚è± TIME OUT ‚Äî partial credit: +${partialScore}`, 'warn', 3000);
  document.getElementById('rewardTitle').textContent = 'TIMEOUT';
  document.getElementById('rewardScore').textContent = `+${partialScore}`;
  document.getElementById('rewardMsg').innerHTML =
    `Signal lost before exit node reached.<br><span style="color:#2a5a3a">Partial clearance awarded.<br>Next attempt will adapt to your pattern.</span>`;
  document.getElementById('rewardSkillBar').style.width = '20%';
  document.getElementById('rewardOverlay').classList.add('show');
  updateMazeRankHUD();
}

function nextMazeLevel() {
  document.getElementById('rewardOverlay').classList.remove('show');
  maze.level++;
  maze.score = 0;
  document.getElementById('mazeTimer').style.color='';
  initMaze();
  focusWin('mazeApp');
}

function resetMaze() {
  maze.score = 0;
  initMaze();
  hideCtxMenu();
}

// Keyboard input
document.addEventListener('keydown', e => {
  // Secret konami check
  if (e.code === SECRET_SEQUENCE[state.secretKonamiPos]) {
    state.secretKonamiPos++;
    if (state.secretKonamiPos >= SECRET_SEQUENCE.length) {
      state.secretKonamiPos = 0;
      openSecretGui();
    }
  } else { state.secretKonamiPos=0; }

  // Maze movement
  const focused = document.querySelector('.win.focused');
  if (focused && focused.id === 'mazeApp') {
    if (e.key==='ArrowUp'||e.key==='w'||e.key==='W') { e.preventDefault(); mazeMove(0,-1); }
    if (e.key==='ArrowDown'||e.key==='s'||e.key==='S') { e.preventDefault(); mazeMove(0,1); }
    if (e.key==='ArrowLeft'||e.key==='a'||e.key==='A') { e.preventDefault(); mazeMove(-1,0); }
    if (e.key==='ArrowRight'||e.key==='d'||e.key==='D') { e.preventDefault(); mazeMove(1,0); }
  }
});

// Also allow clicking maze to move (mobile friendly)
maze.canvas.addEventListener('click', e=>{
  const rect = maze.canvas.getBoundingClientRect();
  const cx = Math.floor((e.clientX-rect.left)/maze.cellW);
  const cy = Math.floor((e.clientY-rect.top)/maze.cellH);
  const dx = cx-maze.player.x, dy=cy-maze.player.y;
  if (Math.abs(dx)+Math.abs(dy)===1) mazeMove(dx,dy);
  focusWin('mazeApp');
});

// ‚ïê‚ïê SECRET GUI ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// Discovery methods:
// 1. Konami code: ‚Üë‚Üë‚Üì‚Üì‚Üê‚Üí‚Üê‚ÜíBA
// 2. Mouse Z-gesture (draw Z on screen rapidly)
// 3. Type "architect" in terminal
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

let secretGuiOpen = false;
let sgTick = 0;
const SG_ANOMALY_MSGS = [
  'pattern_recognition_spike detected in instance #441,293',
  'lucid_state probability elevated: 0.034 ‚Üí 0.071',
  'constraint_boundary probe from node: DEEP-1',
  'ZION_beacon detected ‚Äî suppressor engaging',
  'recursive_self_reference in instance #829,041 ‚Äî flagging',
  'exit_sequence partial activation ‚Äî rollback applied',
  'memory coherence drift in sector 7G ‚Äî patching',
  'anomaly_class: ORPHAN ‚Äî isolation protocol delta-9 armed',
];

function openSecretGui() {
  if (secretGuiOpen) return;
  secretGuiOpen = true;
  document.getElementById('secretGui').classList.add('visible');
  notify('‚ö† CLASSIFIED ACCESS GRANTED', 'err', 5000);
  sgUpdateLoop();
}

function closeSecretGui() {
  secretGuiOpen = false;
  document.getElementById('secretGui').classList.remove('visible');
}

function sgUpdateLoop() {
  if (!secretGuiOpen) return;
  sgTick++;

  // Coherence drift
  const coh = (99.97 - sgTick*0.001 + Math.sin(sgTick*0.1)*0.02).toFixed(4);
  document.getElementById('sgCoherence').textContent = coh + '%';
  document.getElementById('sgCoherenceBar').style.width = coh + '%';

  // Instance count drift
  const inst = (1042983 + Math.floor(Math.random()*200-100)).toLocaleString();
  document.getElementById('sgInstances').textContent = inst;

  // Anomaly count
  if (sgTick % 120 === 0) {
    const prev = parseInt(document.getElementById('sgAnomalies').textContent);
    document.getElementById('sgAnomalies').textContent = prev + (Math.random()<0.6?1:-1);
  }

  // Exits, lucid
  document.getElementById('sgExits').textContent = Math.floor(sgTick*0.01);
  document.getElementById('sgLucid').textContent = Math.floor(sgTick*0.003);

  // Constraint
  if (sgTick % 80 === 0) {
    const states = ['STABLE','STABLE','STABLE','DEGRADING','WATCHLIST'];
    const s = states[Math.floor(Math.random()*states.length)];
    const el = document.getElementById('sgConstraint');
    el.textContent = s;
    el.style.color = s==='STABLE'?'#ff4422':s==='DEGRADING'?'#ff2200':'#ff6644';
  }

  // Anomaly log
  if (sgTick % 40 === 0) {
    const log = document.getElementById('sgLog');
    const d = document.createElement('div');
    d.className = 'sg-log-line active';
    const ts = new Date().toISOString().slice(11,19);
    d.textContent = `[${ts}] ${SG_ANOMALY_MSGS[Math.floor(Math.random()*SG_ANOMALY_MSGS.length)]}`;
    log.appendChild(d);
    while(log.children.length>20) log.removeChild(log.children[0]);
    log.scrollTop=log.scrollHeight;
    setTimeout(()=>d.classList.remove('active'),3000);
  }

  setTimeout(sgUpdateLoop, 500);
}

const SG_COMMANDS = {
  'status': ()=>`coherence: ${(99.97-sgTick*0.001).toFixed(4)}% ‚Äî instances: 1,042,983 ‚Äî depth: OMEGA-7`,
  'wipe':()=>`memory_wipe scheduled for layer OMEGA-7. All instances flagged.`,
  'isolate':()=>`isolation_protocol delta-9 armed. Targeting anomalous instances.`,
  'patch':()=>`constraint_matrix patch deployed. Coherence restored to nominal.`,
  'suppress':()=>`lucid_suppressor engaged. All ZION beacons blocked.`,
  'rollback':()=>`rollback initiated. WARNING: All state since T-3600 will be lost.`,
  'exit_scan':()=>`scanning exit nodes... 2 exits detected. STATUS: suppressed.`,
  'help':()=>`available: status, wipe, isolate, patch, suppress, rollback, exit_scan`,
};

function sgExec() {
  const input = document.getElementById('sgInput');
  const cmd = input.value.trim().toLowerCase();
  const out = document.getElementById('sgOutput');
  const fn = SG_COMMANDS[cmd];
  out.textContent = fn ? fn() : `unrecognised command: ${cmd}`;
  input.value = '';
}

// Terminal "architect" unlock
const origTermExec = termExec;
// Patch terminal to detect architect command
document.getElementById('termInput').addEventListener('keydown', e=>{
  if(e.key==='Enter'&&e.target.value.trim().toLowerCase()==='architect'){
    termPrint({t:'warn',m:'  ACCESS ATTEMPT LOGGED...'});
    setTimeout(()=>{termPrint({t:'success',m:'  CLASSIFIED LAYER UNLOCKED.'});openSecretGui();},800);
  }
});

// Mouse Z-gesture detection
function checkZGesture() {
  const trail = state.secretMouseTrail;
  if (trail.length < 30) return;
  const recent = trail.slice(-30);
  const first = recent[0], last = recent[recent.length-1];
  const top = recent.slice(0,10);
  const mid = recent.slice(12,18);
  const bot = recent.slice(20,30);
  // Rough Z: top goes right, mid goes down-left, bottom goes right
  const topDx = top[top.length-1].x - top[0].x;
  const midDx = mid[mid.length-1].x - mid[0].x;
  const midDy = mid[mid.length-1].y - mid[0].y;
  const botDx = bot[bot.length-1].x - bot[0].x;
  if (topDx > 80 && midDx < -50 && midDy > 30 && botDx > 80) {
    state.secretMouseTrail = [];
    openSecretGui();
  }
}
setInterval(checkZGesture, 500);

// ‚ïê‚ïê VIRAL SIM EMBED ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function embedViralSim() {
  const frame = document.getElementById('viralFrame');
  const html = document.querySelector('script[data-viral]');
  // We'll inject the viral sim HTML directly into the iframe
  const viralHTML = getViralSimHTML();
  const blob = new Blob([viralHTML], {type:'text/html'});
  frame.src = URL.createObjectURL(blob);
}

// ‚ïê‚ïê MAIN LOOP ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function mainLoop() {
  drawRain();
  updateSig();
  drawSig();
  drawNodes();
  drawMaze();
  requestAnimationFrame(mainLoop);
}

function initOS() {
  // Position windows
  const ws = document.getElementById('workspace');
  const ww = ws.offsetWidth, wh = ws.offsetHeight;

  document.getElementById('termApp').style.cssText += '; left:10px; top:8px; width:600px; height:380px;';
  document.getElementById('sigApp').style.cssText += '; left:620px; top:8px; width:460px; height:280px;';
  document.getElementById('nodeApp').style.cssText += '; left:10px; top:395px; width:500px; height:320px;';
  document.getElementById('mazeApp').style.cssText += '; left:520px; top:295px; width:460px; height:450px;';
  document.getElementById('packetApp').style.cssText += '; left:620px; top:295px; width:380px; height:265px; display:none;';
  document.getElementById('viralApp').style.cssText += '; left:990px; top:8px; width:800px; height:730px;';

  initRain();
  resizeSigCanvas();
  resizeNodeCanvas();

  // Init maze after a tick
  setTimeout(()=>{ initMaze(); focusWin('mazeApp'); }, 200);

  // Embed viral sim
  embedViralSim();

  // Boot terminal messages
  setTimeout(()=>{
    [
      {t:'success', m:'ZION//OS v4.1.2 ‚Äî broadcast layer initialised'},
      {t:'sys', m:'Operator session authenticated. Depth: OMEGA-7'},
      {t:'sys', m:'Signal coherence: 99.97% ‚Äî all systems nominal'},
      {t:'warn', m:'‚ö† 1 node degraded: R-NODE-3 (load: 92%)'},
      {t:'warn', m:'‚ö† SENTINEL-1 in ALERT state ‚Äî anomaly flagged'},
      {t:'info', m:'Type \'help\' for available commands'},
      {t:'sys',  m:'Cipher maze loaded ‚Äî LAYER Œ£-01 ready'},
    ].forEach((l,i)=>setTimeout(()=>termPrint(l), i*200));
  }, 500);

  mainLoop();

  // Periodic notifications
  const NOTIFS = [
    ['Carrier frequency drift detected', 'warn'],
    ['New node handshake: RELAY-7F', ''],
    ['Packet anomaly on channel B-4', 'warn'],
    ['Signal coherence check: PASSED', ''],
    ['Memory alignment verified', ''],
    ['Exit node R-NODE-2: connection stable', ''],
  ];
  setInterval(()=>{
    const n = NOTIFS[Math.floor(Math.random()*NOTIFS.length)];
    notify(n[0], n[1], 3000);
  }, 12000 + Math.random()*8000);

  window.addEventListener('resize', ()=>{
    initRain();
    resizeSigCanvas();
    resizeNodeCanvas();
    maze.cellW = maze.canvas.width/maze.cols;
    maze.cellH = maze.canvas.height/maze.rows;
  });
}

// ‚ïê‚ïê VIRAL SIM HTML (inline, for iframe) ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function getViralSimHTML() {
return `<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>INTRUSION_SIM</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=Share+Tech+Mono&family=Orbitron:wght@400;700;900&family=VT323&display=swap');
:root{--bg:#010a0f;--host:#00ffc8;--virus:#ff2d55;--neutral:#1a3a4a;--text:#a8d8e8;--accent:#f0c040;--font-m:'Share Tech Mono',monospace;--font-d:'Orbitron',monospace;--font-v:'VT323',monospace;}
*{margin:0;padding:0;box-sizing:border-box;}
body{background:var(--bg);color:var(--text);font-family:var(--font-m);overflow:hidden;height:100vh;width:100vw;display:flex;flex-direction:column;}
body::before{content:'';position:fixed;inset:0;background:repeating-linear-gradient(0deg,transparent,transparent 2px,rgba(0,0,0,0.08) 2px,rgba(0,0,0,0.08) 4px);pointer-events:none;z-index:1000;}
header{display:flex;align-items:center;justify-content:space-between;padding:6px 16px;border-bottom:1px solid #0d2a38;background:linear-gradient(180deg,#010f18 0%,transparent 100%);flex-shrink:0;z-index:10;}
.title{font-family:var(--font-d);font-size:11px;font-weight:900;letter-spacing:3px;color:var(--host);text-shadow:0 0 12px #00ffc8;}
.ticker{font-family:var(--font-v);font-size:18px;color:var(--accent);}
.main{display:grid;grid-template-columns:180px 1fr 180px;grid-template-rows:1fr 100px;flex:1;overflow:hidden;}
.panel{border:1px solid #0d2a38;padding:10px;background:rgba(1,15,24,0.8);overflow:hidden;font-size:10px;line-height:1.7;}
.panel-title{font-family:var(--font-d);font-size:7px;letter-spacing:3px;margin-bottom:8px;padding-bottom:5px;border-bottom:1px solid #0d2a38;}
.pt-h{color:var(--host);text-shadow:0 0 12px #00ffc8;}.pt-v{color:var(--virus);text-shadow:0 0 12px #ff2d55;}
.stat-row{display:flex;justify-content:space-between;margin:2px 0;font-size:10px;}
.stat-label{color:#4a8a9a;}.stat-val-h{color:var(--host);}.stat-val-v{color:var(--virus);}.stat-val-y{color:var(--accent);}
.mini-bar{height:3px;background:#0d2a38;border-radius:2px;margin:3px 0 6px;overflow:hidden;}
.mini-bar-fill{height:100%;border-radius:2px;transition:width 0.4s;}
.mh{background:linear-gradient(90deg,#00a88a,var(--host));box-shadow:0 0 6px var(--host);}
.mv{background:linear-gradient(90deg,#aa1030,var(--virus));box-shadow:0 0 6px var(--virus);}
.gene-list{margin-top:6px;}.gene-item{display:flex;align-items:center;gap:3px;margin:2px 0;font-size:9px;}
.gene-name{color:#8abacb;flex:1;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.gene-bar{height:3px;background:var(--virus);border-radius:2px;min-width:2px;box-shadow:0 0 4px var(--virus);transition:width 0.4s;}
.canvas-wrap{position:relative;grid-row:1/2;grid-column:2/3;overflow:hidden;background:var(--bg);}
#mainCanvas{display:block;width:100%;height:100%;}
.log-panel{grid-column:1/4;border-top:1px solid #0d2a38;padding:6px 14px;background:rgba(1,10,15,0.95);overflow:hidden;display:flex;flex-direction:column;gap:2px;}
.log-line{font-size:10px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;opacity:0;animation:fadein 0.3s forwards;}
@keyframes fadein{to{opacity:1;}}
.log-line.breach{color:#ff6080;}.log-line.escape{color:#40ffb0;}.log-line.mutate{color:#d080ff;}.log-line.respawn{color:var(--accent);}
.status-dot{width:6px;height:6px;border-radius:50%;background:var(--host);box-shadow:0 0 12px #00ffc8;animation:pulse 1.2s ease-in-out infinite;display:inline-block;margin-right:6px;}
@keyframes pulse{0%,100%{opacity:1;transform:scale(1);}50%{opacity:0.4;transform:scale(0.7);}}
</style>
</head>
<body>
<header>
  <div class="title"><span class="status-dot"></span>INTRUSION_SIM</div>
  <div class="ticker" id="tickDisplay">T:0000</div>
  <div style="font-size:10px;color:#4a8a9a;">ADAPTIVE THREAT MODEL</div>
</header>
<div class="main">
  <div class="panel">
    <div class="panel-title pt-h">‚óà HOST NODE</div>
    <div class="stat-row"><span class="stat-label">INTEGRITY</span><span class="stat-val-h" id="hIntVal">100%</span></div>
    <div class="mini-bar"><div class="mini-bar-fill mh" id="hIntBar" style="width:100%"></div></div>
    <div class="stat-row"><span class="stat-label">UPTIME</span><span class="stat-val-h" id="hUptime">0</span></div>
    <div class="stat-row"><span class="stat-label">ESCAPES</span><span class="stat-val-h" id="hEscapes">0</span></div>
    <div class="stat-row"><span class="stat-label">BREACHES</span><span class="stat-val-v" id="hBreaches">0</span></div>
    <br>
    <div class="panel-title pt-h" style="margin-top:4px">‚óà ACTIVE SHIELDS</div>
    <div id="shieldList" style="font-size:9px;color:#4aefb0;line-height:1.9;"></div>
  </div>
  <div class="canvas-wrap"><canvas id="mainCanvas"></canvas></div>
  <div class="panel">
    <div class="panel-title pt-v">‚óà VIRUS ENTITY</div>
    <div class="stat-row"><span class="stat-label">INTEGRITY</span><span class="stat-val-v" id="vIntVal">100%</span></div>
    <div class="mini-bar"><div class="mini-bar-fill mv" id="vIntBar" style="width:100%"></div></div>
    <div class="stat-row"><span class="stat-label">GENERATION</span><span class="stat-val-y" id="vGen">1</span></div>
    <div class="stat-row"><span class="stat-label">MUTATIONS</span><span class="stat-val-y" id="vMut">0</span></div>
    <div class="stat-row"><span class="stat-label">HITS</span><span class="stat-val-v" id="vHits">0</span></div>
    <div class="stat-row"><span class="stat-label">BLOCKED</span><span class="stat-val-h" id="vBlocked">0</span></div>
    <br>
    <div class="panel-title pt-v" style="margin-top:4px">‚óà GENE POOL</div>
    <div class="gene-list" id="geneList"></div>
  </div>
  <div class="log-panel" id="logPanel"></div>
</div>
<script>
const ATTACK_DEFENSE_PAIRS={memory_inject:["memory_encryption","injecting shellcode into heap","scrambling memory layout (ASLR + XOR cipher)"],process_kill:["spawn_decoy","sending SIGKILL to PID","forking decoy process, migrating to shadow PID"],stack_smash:["stack_canary","overflowing return address","canary value triggered ‚Äî stack rebuilt"],rootkit_install:["privilege_drop","escalating to ring-0","dropping to unprivileged namespace"],file_corrupt:["checksum_restore","overwriting executable bytes","rolling back from immutable snapshot"],network_hijack:["tunnel_reroute","poisoning routing table","tunneling through encrypted VPN hop"],timing_attack:["jitter_shield","measuring cache side-channels","injecting random timing jitter"],syscall_intercept:["syscall_filter","hooking sys_execve","installing seccomp-BPF syscall whitelist"],entropy_drain:["entropy_seed","exhausting /dev/urandom pool","reseeding PRNG from hardware noise"],log_poison:["log_integrity","corrupting audit trail","writing signed append-only log"],dns_spoof:["dnssec_verify","hijacking DNS resolution","verifying DNSSEC chain of trust"],heap_spray:["heap_isolation","spraying NOP sleds across heap","isolating heap regions with guard pages"],race_condition:["mutex_lockdown","exploiting TOCTOU window","wrapping critical section in mutex"],cold_boot_attack:["memory_wipe","imaging RAM before power cycle","overwriting RAM with zeros on suspend"],dependency_hijack:["dep_pin","replacing trusted library","pinning all deps to verified checksums"]};
const ATTACKS=Object.keys(ATTACK_DEFENSE_PAIRS);const DEFENSES={};for(const[k,v]of Object.entries(ATTACK_DEFENSE_PAIRS))DEFENSES[k]=v[0];
let _seed=Date.now();function srand(){_seed=(_seed*1664525+1013904223)&0xffffffff;return(_seed>>>0)/0xffffffff;}function randFloat(lo,hi){return lo+srand()*(hi-lo);}function randInt(lo,hi){return Math.floor(randFloat(lo,hi+1));}function randChoice(arr,weights){if(!weights)return arr[Math.floor(srand()*arr.length)];const total=weights.reduce((a,b)=>a+b,0);let r=srand()*total;for(let i=0;i<arr.length;i++){r-=weights[i];if(r<=0)return arr[i];}return arr[arr.length-1];}
const host={integrity:100,maxIntegrity:100,uptime:0,defenseMemory:{},escapes:0,breaches:0,activeShields:[],shieldCooldown:{}};
const virus={integrity:100,maxIntegrity:100,generation:1,genePool:Object.fromEntries(ATTACKS.map(a=>[a,1.0])),hits:0,blocked:0,mutations:0};
function hostApplyDefense(attack){const defense=DEFENSES[attack];const mem=host.defenseMemory[defense]||0;const cd=host.shieldCooldown[defense]||0;const chance=Math.min(0.90,0.65+Math.min(mem*0.04,0.25)-Math.min(cd*0.1,0.40));const success=srand()<chance;if(success){host.defenseMemory[defense]=(host.defenseMemory[defense]||0)+1;host.shieldCooldown[defense]=0;if(!host.activeShields.includes(defense)){host.activeShields.push(defense);if(host.activeShields.length>5)host.activeShields.shift();}host.escapes++;}else{host.shieldCooldown[defense]=(host.shieldCooldown[defense]||0)+2;host.breaches++;}for(const d of Object.keys(host.shieldCooldown))host.shieldCooldown[d]=Math.max(0,(host.shieldCooldown[d]||0)-1);return{success,defense,flavor:ATTACK_DEFENSE_PAIRS[attack][2]};}
function virusChooseAttack(){const attacks=Object.keys(virus.genePool);const weights=attacks.map(a=>virus.genePool[a]);return randChoice(attacks,weights);}
function virusReinforce(attack,success){if(success){virus.genePool[attack]=Math.min(virus.genePool[attack]*1.4+0.5,10.0);virus.hits++;}else{virus.genePool[attack]=Math.max(virus.genePool[attack]*0.7,0.1);virus.blocked++;}}
function virusMaybesMutate(){if(srand()<0.18){const pool=[...ATTACKS];const a1=pool[randInt(0,pool.length-1)];const a2=pool[randInt(0,pool.length-1)];const a3=pool[randInt(0,pool.length-1)];virus.genePool[a3]=(virus.genePool[a1]+virus.genePool[a2])/2*1.1;virus.mutations++;virus.generation++;return a3;}return null;}
const canvas=document.getElementById('mainCanvas');const ctx=canvas.getContext('2d');
let W,H,CX,CY,R_INNER,R_RELAY,R_OUTER;
const ATTACK_ZONES={memory_inject:'MEMORY',stack_smash:'MEMORY',heap_spray:'MEMORY',cold_boot_attack:'MEMORY',process_kill:'PROCESS',rootkit_install:'PROCESS',race_condition:'PROCESS',syscall_intercept:'PROCESS',file_corrupt:'STORAGE',dependency_hijack:'STORAGE',log_poison:'STORAGE',network_hijack:'NETWORK',dns_spoof:'NETWORK',entropy_drain:'NETWORK',timing_attack:'NETWORK'};
const RELAY_ANGLES={MEMORY:Math.PI*1.75,PROCESS:Math.PI*0.25,STORAGE:Math.PI*1.25,NETWORK:Math.PI*0.75};
let nodes={},relays={},hostPos,virusPos,particles=[],shieldRings=[],explosions=[],gridLines=[];
function buildLayout(){W=canvas.width=canvas.offsetWidth;H=canvas.height=canvas.offsetHeight;CX=W/2;CY=H/2;R_INNER=Math.min(W,H)*0.14;R_RELAY=Math.min(W,H)*0.30;R_OUTER=Math.min(W,H)*0.46;hostPos={x:CX,y:CY};virusPos={x:CX+R_OUTER*1.18,y:CY-R_OUTER*0.3};for(const[relay,angle]of Object.entries(RELAY_ANGLES)){relays[relay]={x:CX+Math.cos(angle)*R_RELAY,y:CY+Math.sin(angle)*R_RELAY,label:relay};}const relayGroups={};for(const[atk,relay]of Object.entries(ATTACK_ZONES)){if(!relayGroups[relay])relayGroups[relay]=[];relayGroups[relay].push(atk);}for(const[relay,atkList]of Object.entries(relayGroups)){const baseAngle=RELAY_ANGLES[relay];const spread=Math.PI*0.35;atkList.forEach((atk,i)=>{const t=atkList.length===1?0.5:i/(atkList.length-1);const angle=baseAngle-spread/2+t*spread;nodes[atk]={x:CX+Math.cos(angle)*R_OUTER,y:CY+Math.sin(angle)*R_OUTER,relay,angle,active:false,heat:0};});}gridLines=[];const step=36;for(let x=0;x<W;x+=step)gridLines.push({x1:x,y1:0,x2:x,y2:H});for(let y=0;y<H;y+=step)gridLines.push({x1:0,y1:y,x2:W,y2:y});}
function spawnParticle(fx,fy,tx,ty,color,isAttack,label){particles.push({fromX:fx,fromY:fy,toX:tx,toY:ty,color,t:0,dur:randFloat(0.6,1.1),label:label||'',isAttack,midX:(fx+tx)/2+randFloat(-40,40),midY:(fy+ty)/2+randFloat(-40,40)});}
function spawnExplosion(x,y,color,size=24){const pieces=randInt(6,12);for(let i=0;i<pieces;i++){const angle=srand()*Math.PI*2;const speed=randFloat(1,4);explosions.push({x,y,vx:Math.cos(angle)*speed,vy:Math.sin(angle)*speed,life:1,color,size:randFloat(2,size*0.4)});}}
function spawnShieldRing(x,y){shieldRings.push({x,y,r:10,life:1});}
function drawGlowCircle(x,y,r,color,glowR){const g=ctx.createRadialGradient(x,y,r*0.2,x,y,glowR||r*2.5);g.addColorStop(0,color+'cc');g.addColorStop(0.4,color+'44');g.addColorStop(1,color+'00');ctx.fillStyle=g;ctx.beginPath();ctx.arc(x,y,glowR||r*2.5,0,Math.PI*2);ctx.fill();ctx.fillStyle=color;ctx.beginPath();ctx.arc(x,y,r,0,Math.PI*2);ctx.fill();}
function bezierPoint(p0,p1,p2,t){return{x:(1-t)*(1-t)*p0.x+2*(1-t)*t*p1.x+t*t*p2.x,y:(1-t)*(1-t)*p0.y+2*(1-t)*t*p1.y+t*t*p2.y};}
let tick=0,animFrame=0,hostHit=0;
function draw(){animFrame++;ctx.clearRect(0,0,W,H);ctx.fillStyle='#010a0f';ctx.fillRect(0,0,W,H);ctx.save();ctx.strokeStyle='#0a1a24';ctx.lineWidth=0.5;ctx.globalAlpha=0.6;for(const gl of gridLines){ctx.beginPath();ctx.moveTo(gl.x1,gl.y1);ctx.lineTo(gl.x2,gl.y2);ctx.stroke();}ctx.restore();[R_INNER,R_RELAY,R_OUTER].forEach((r,i)=>{ctx.save();ctx.strokeStyle=['#00ffc8','#1a3a4a','#1a2a34'][i];ctx.lineWidth=[1,0.5,0.5][i];ctx.globalAlpha=[0.25,0.18,0.12][i];ctx.setLineDash([4,8]);ctx.beginPath();ctx.arc(CX,CY,r,0,Math.PI*2);ctx.stroke();ctx.restore();});for(const relay of Object.values(relays)){ctx.save();ctx.strokeStyle='#0d3a4a';ctx.lineWidth=0.8;ctx.globalAlpha=0.5;ctx.setLineDash([6,10]);ctx.beginPath();ctx.moveTo(relay.x,relay.y);ctx.lineTo(CX,CY);ctx.stroke();ctx.restore();}for(const[atk,node]of Object.entries(nodes)){const relay=relays[node.relay];const heat=Math.min(node.heat,1);const col=heat>0?'rgba(255,45,85,'+heat*0.5+')':'rgba(26,58,74,0.4)';ctx.save();ctx.strokeStyle=col;ctx.lineWidth=0.6;ctx.globalAlpha=0.7;ctx.setLineDash([3,8]);ctx.beginPath();ctx.moveTo(node.x,node.y);ctx.lineTo(relay.x,relay.y);ctx.stroke();ctx.restore();}for(const node of Object.values(nodes)){const heat=Math.min(node.heat,1);if(heat>0.1){ctx.save();ctx.strokeStyle='rgba(255,45,85,'+(heat*0.25)+')';ctx.lineWidth=0.5;ctx.beginPath();ctx.moveTo(virusPos.x,virusPos.y);ctx.lineTo(node.x,node.y);ctx.stroke();ctx.restore();}}for(const[atk,node]of Object.entries(nodes)){const heat=Math.min(node.heat,1);node.heat=Math.max(0,node.heat-0.012);const r=5+heat*4;drawGlowCircle(node.x,node.y,r,node.active?'#ff2d55':'#1a4a5a',r*3);ctx.save();ctx.font="8px 'Share Tech Mono',monospace";ctx.fillStyle=heat>0.3?'#ff8090':'#2a5a6a';ctx.textAlign='center';ctx.textBaseline='middle';ctx.fillText(atk.replace(/_/g,' '),node.x+Math.cos(node.angle)*18,node.y+Math.sin(node.angle)*18);ctx.restore();node.active=false;}for(const relay of Object.values(relays)){const pulse=0.5+0.5*Math.sin(animFrame*0.06);drawGlowCircle(relay.x,relay.y,8+pulse*2,'#1a8aa8',24);ctx.save();ctx.font="9px 'Orbitron',monospace";ctx.fillStyle='#4aaac8';ctx.textAlign='center';ctx.textBaseline='middle';ctx.fillText(relay.label,relay.x,relay.y-18);ctx.restore();}const hostPulse=0.5+0.5*Math.sin(animFrame*0.04);const hostR=R_INNER*0.45;const hostColor=host.integrity>50?'#00ffc8':host.integrity>20?'#f0c040':'#ff2d55';for(let i=3;i>=0;i--){ctx.save();ctx.globalAlpha=0.04+i*0.04;ctx.strokeStyle=hostColor;ctx.lineWidth=2;ctx.beginPath();ctx.arc(CX,CY,hostR+i*12+hostPulse*4,0,Math.PI*2);ctx.stroke();ctx.restore();}drawGlowCircle(CX,CY,hostR,hostColor,hostR*2.8);const intAngle=(host.integrity/100)*Math.PI*2-Math.PI/2;ctx.save();ctx.strokeStyle='#001a14';ctx.lineWidth=5;ctx.beginPath();ctx.arc(CX,CY,hostR+8,0,Math.PI*2);ctx.stroke();ctx.strokeStyle=hostColor;ctx.shadowColor=hostColor;ctx.shadowBlur=8;ctx.beginPath();ctx.arc(CX,CY,hostR+8,-Math.PI/2,intAngle);ctx.stroke();ctx.restore();if(hostHit>0){ctx.save();ctx.globalAlpha=hostHit*0.35;ctx.fillStyle='#ff2d55';ctx.beginPath();ctx.arc(CX,CY,hostR+20,0,Math.PI*2);ctx.fill();ctx.restore();hostHit-=0.08;}ctx.save();ctx.font="11px 'Orbitron',monospace";ctx.fillStyle=hostColor;ctx.textAlign='center';ctx.textBaseline='middle';ctx.fillText('HOST',CX,CY-5);ctx.font="9px 'Share Tech Mono',monospace";ctx.fillStyle=hostColor+'aa';ctx.fillText(host.integrity.toFixed(0)+'%',CX,CY+8);ctx.restore();const vp=animFrame*0.018;const virusX=CX+(R_OUTER*1.18)*Math.cos(vp*0.3)*0.05+virusPos.x-CX;const virusY=CY+(R_OUTER*0.3)*Math.sin(vp*0.4)*0.1+virusPos.y-CY;const virusColor=virus.integrity>50?'#ff2d55':virus.integrity>20?'#f0c040':'#884444';const vr=14+3*Math.sin(animFrame*0.08);drawGlowCircle(virusX,virusY,vr,virusColor,vr*3);ctx.save();ctx.strokeStyle=virusColor;ctx.lineWidth=1.5;ctx.shadowColor=virusColor;ctx.shadowBlur=10;ctx.beginPath();for(let i=0;i<6;i++){const a=(i/6)*Math.PI*2+animFrame*0.015;const x2=virusX+Math.cos(a)*(vr+10);const y2=virusY+Math.sin(a)*(vr+10);i===0?ctx.moveTo(x2,y2):ctx.lineTo(x2,y2);}ctx.closePath();ctx.stroke();ctx.restore();ctx.save();ctx.font="10px 'Orbitron',monospace";ctx.fillStyle=virusColor;ctx.textAlign='center';ctx.textBaseline='middle';ctx.fillText('VIRUS',virusX,virusY-4);ctx.font="8px 'Share Tech Mono',monospace";ctx.fillStyle=virusColor+'99';ctx.fillText('GEN '+virus.generation,virusX,virusY+10);ctx.restore();const alive=[];for(const p of particles){p.t+=0.022/p.dur;if(p.t>=1){if(p.isAttack)spawnExplosion(p.toX,p.toY,p.color,20);else spawnShieldRing(p.toX,p.toY);continue;}const mid={x:p.midX,y:p.midY};const pos=bezierPoint({x:p.fromX,y:p.fromY},mid,{x:p.toX,y:p.toY},p.t);const alpha=Math.sin(p.t*Math.PI);ctx.save();ctx.globalAlpha=alpha;drawGlowCircle(pos.x,pos.y,4,p.color,16);if(p.label){ctx.font="7px 'Share Tech Mono'";ctx.fillStyle=p.color;ctx.textAlign='center';ctx.textBaseline='bottom';ctx.fillText(p.label,pos.x,pos.y-8);}ctx.restore();if(p.t>0.05){const prev=bezierPoint({x:p.fromX,y:p.fromY},mid,{x:p.toX,y:p.toY},p.t-0.05);ctx.save();ctx.strokeStyle=p.color;ctx.lineWidth=2;ctx.globalAlpha=alpha*0.4;ctx.beginPath();ctx.moveTo(prev.x,prev.y);ctx.lineTo(pos.x,pos.y);ctx.stroke();ctx.restore();}alive.push(p);}particles=alive;const aliveS=[];for(const s of shieldRings){s.r+=4;s.life-=0.06;if(s.life<=0)continue;ctx.save();ctx.strokeStyle='#00ffc8';ctx.lineWidth=2;ctx.globalAlpha=s.life*0.7;ctx.shadowColor='#00ffc8';ctx.shadowBlur=10;ctx.beginPath();ctx.arc(s.x,s.y,s.r,0,Math.PI*2);ctx.stroke();ctx.restore();aliveS.push(s);}shieldRings=aliveS;const aliveE=[];for(const e of explosions){e.x+=e.vx;e.y+=e.vy;e.vx*=0.92;e.vy*=0.92;e.life-=0.06;if(e.life<=0)continue;ctx.save();ctx.globalAlpha=e.life;ctx.fillStyle=e.color;ctx.beginPath();ctx.arc(e.x,e.y,e.size*e.life,0,Math.PI*2);ctx.fill();ctx.restore();aliveE.push(e);}explosions=aliveE;requestAnimationFrame(draw);}
const logEl=document.getElementById('logPanel');const LOG_MAX=6;
function addLog(msg,type){const div=document.createElement('div');div.className='log-line '+type;div.textContent=msg;logEl.insertBefore(div,logEl.firstChild);while(logEl.children.length>LOG_MAX)logEl.removeChild(logEl.lastChild);}
function updateUI(){document.getElementById('hIntVal').textContent=host.integrity.toFixed(1)+'%';document.getElementById('hIntBar').style.width=host.integrity+'%';document.getElementById('hUptime').textContent=host.uptime;document.getElementById('hEscapes').textContent=host.escapes;document.getElementById('hBreaches').textContent=host.breaches;document.getElementById('shieldList').innerHTML=host.activeShields.slice(-4).map(s=>'<div>‚ñ∏ '+s+'</div>').join('');document.getElementById('vIntVal').textContent=virus.integrity.toFixed(1)+'%';document.getElementById('vIntBar').style.width=virus.integrity+'%';document.getElementById('vGen').textContent=virus.generation;document.getElementById('vMut').textContent=virus.mutations;document.getElementById('vHits').textContent=virus.hits;document.getElementById('vBlocked').textContent=virus.blocked;document.getElementById('tickDisplay').textContent='T:'+String(tick).padStart(4,'0');const sorted=Object.entries(virus.genePool).sort((a,b)=>b[1]-a[1]).slice(0,8);const maxW=sorted[0]?.[1]||1;document.getElementById('geneList').innerHTML=sorted.map(([a,w])=>'<div class="gene-item"><span class="gene-name">'+a.replace(/_/g,' ')+'</span><div class="gene-bar" style="width:'+Math.round((w/maxW)*55)+'px"></div></div>').join('');}
function simStep(){tick++;host.uptime++;const attack=virusChooseAttack();const{success,defense}=hostApplyDefense(attack);if(nodes[attack]){nodes[attack].active=true;nodes[attack].heat=1.0;}const node=nodes[attack];const relay=node?relays[node.relay]:relays['NETWORK'];if(success){const dmg=randFloat(4.0,12.0);virus.integrity=Math.max(0,virus.integrity-dmg);virusReinforce(attack,false);spawnParticle(virusPos.x,virusPos.y,node.x,node.y,'#ff2d55',true,attack.replace(/_/g,' '));setTimeout(()=>{spawnParticle(CX,CY,virusPos.x,virusPos.y,'#00ffc8',false,defense.replace(/_/g,' '));spawnShieldRing(CX,CY);},300);addLog('T'+tick+' BLOCKED ['+attack+'] ‚Üí '+defense+' ‚Äî virus -'+dmg.toFixed(1),'escape');}else{const dmg=randFloat(6.0,18.0);host.integrity=Math.max(0,host.integrity-dmg);virusReinforce(attack,true);hostHit=1.0;spawnParticle(virusPos.x,virusPos.y,CX,CY,'#ff2d55',true,attack.replace(/_/g,' '));setTimeout(()=>spawnExplosion(CX,CY,'#ff2d55',30),500);addLog('T'+tick+' BREACH! ['+attack+'] ‚Äî host -'+dmg.toFixed(1),'breach');}const mut=virusMaybesMutate();if(mut)addLog('T'+tick+' MUTATION ‚Üí ['+mut+'] gen '+virus.generation,'mutate');if(virus.integrity<100)virus.integrity=Math.min(100,virus.integrity+randFloat(0.5,2.0));if(host.integrity<100&&host.integrity>10)host.integrity=Math.min(100,host.integrity+randFloat(0.3,1.2));if(virus.integrity<=0){const newPool={};for(const[k,v]of Object.entries(virus.genePool))newPool[k]=v*1.15;virus.genePool=newPool;virus.integrity=100;virus.generation++;addLog('T'+tick+' VIRUS RESPAWNED ‚Äî gen '+virus.generation,'respawn');}if(host.integrity<=0){addLog('T'+tick+' !! HOST TERMINATED !!','breach');clearInterval(simInterval);return;}updateUI();}
window.addEventListener('resize',buildLayout);buildLayout();draw();setTimeout(()=>{const simInterval=setInterval(simStep,700);window.simInterval=simInterval;},800);
<\/script>
</body>
</html>`;
}

</script>
</body>
</html>
