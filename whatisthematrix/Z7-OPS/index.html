<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>MODAL SYSTEM v6.1.4 — Neo's Construct IDE</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Share+Tech+Mono&family=VT323&family=Courier+Prime:wght@400;700&display=swap');

  :root {
    --bg: #010f03;
    --bg2: #020d04;
    --bg3: #031008;
    --panel: #030f05;
    --panel2: #041408;
    --border: #0d3b12;
    --border2: #1a6b22;
    --green: #00ff41;
    --green2: #00cc33;
    --green3: #00891f;
    --green4: #005c14;
    --green-dim: #003b0a;
    --green-glow: rgba(0, 255, 65, 0.15);
    --red: #ff2020;
    --red2: #cc0000;
    --amber: #ffa500;
    --text: #00cc33;
    --text-dim: #007a1f;
    --text-bright: #00ff41;
    --font-mono: 'Share Tech Mono', monospace;
    --font-display: 'VT323', monospace;
  }

  * { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    background: var(--bg);
    color: var(--text);
    font-family: var(--font-mono);
    font-size: 12px;
    height: 100vh;
    overflow: hidden;
    display: flex;
    flex-direction: column;
    cursor: default;
  }

  /* SCANLINE OVERLAY */
  body::after {
    content: '';
    position: fixed;
    inset: 0;
    background: repeating-linear-gradient(0deg, transparent, transparent 2px, rgba(0,0,0,0.15) 2px, rgba(0,0,0,0.15) 4px);
    pointer-events: none;
    z-index: 9998;
  }

  /* CRT VIGNETTE */
  body::before {
    content: '';
    position: fixed;
    inset: 0;
    background: radial-gradient(ellipse at center, transparent 60%, rgba(0,0,0,0.7) 100%);
    pointer-events: none;
    z-index: 9997;
  }

  /* ══════════════════════════════════════════
     TOP MENU BAR
  ══════════════════════════════════════════ */
  #menubar {
    background: #000;
    border-bottom: 1px solid var(--border2);
    display: flex;
    align-items: center;
    height: 24px;
    padding: 0 8px;
    flex-shrink: 0;
    gap: 4px;
    position: relative;
    z-index: 100;
  }

  #menubar .logo {
    font-family: var(--font-display);
    font-size: 18px;
    color: var(--green);
    letter-spacing: 2px;
    margin-right: 12px;
    text-shadow: 0 0 8px var(--green);
    animation: pulse 3s ease-in-out infinite;
  }

  @keyframes pulse { 0%,100%{opacity:1} 50%{opacity:0.7} }

  #menubar .menu-item {
    padding: 0 8px;
    height: 24px;
    line-height: 24px;
    cursor: pointer;
    color: var(--text);
    font-size: 11px;
    letter-spacing: 1px;
  }
  #menubar .menu-item:hover { background: var(--green-dim); color: var(--green); }

  #menubar .status-right {
    margin-left: auto;
    display: flex;
    align-items: center;
    gap: 16px;
    font-size: 10px;
    color: var(--text-dim);
  }

  #menubar .status-right .live-dot {
    width: 6px; height: 6px;
    background: var(--green);
    border-radius: 50%;
    display: inline-block;
    margin-right: 4px;
    animation: blink 1s step-end infinite;
    box-shadow: 0 0 6px var(--green);
  }
  @keyframes blink { 0%,100%{opacity:1} 50%{opacity:0} }

  /* ══════════════════════════════════════════
     TOOLBAR
  ══════════════════════════════════════════ */
  #toolbar {
    background: var(--bg2);
    border-bottom: 1px solid var(--border);
    display: flex;
    align-items: center;
    height: 28px;
    padding: 0 8px;
    gap: 2px;
    flex-shrink: 0;
  }

  .tb-btn {
    padding: 2px 10px;
    border: 1px solid var(--border2);
    background: var(--bg3);
    color: var(--text);
    font-family: var(--font-mono);
    font-size: 10px;
    cursor: pointer;
    letter-spacing: 0.5px;
    transition: all 0.15s;
  }
  .tb-btn:hover { background: var(--green-dim); color: var(--green); border-color: var(--green3); }
  .tb-btn.active { background: var(--green-dim); color: var(--green); border-color: var(--green); }
  .tb-btn.danger { border-color: var(--red2); color: var(--red); }
  .tb-btn.danger:hover { background: rgba(204,0,0,0.2); }

  .tb-sep { width: 1px; height: 18px; background: var(--border); margin: 0 4px; }

  /* ══════════════════════════════════════════
     TAB BAR
  ══════════════════════════════════════════ */
  #tabbar {
    background: #000;
    border-bottom: 1px solid var(--border2);
    display: flex;
    align-items: flex-end;
    height: 26px;
    padding: 0 4px;
    flex-shrink: 0;
    overflow-x: auto;
    scrollbar-width: none;
  }

  .tab {
    padding: 0 14px;
    height: 22px;
    line-height: 22px;
    font-size: 10px;
    cursor: pointer;
    border: 1px solid var(--border);
    border-bottom: none;
    background: var(--bg2);
    color: var(--text-dim);
    white-space: nowrap;
    margin-right: 2px;
    letter-spacing: 0.5px;
    transition: all 0.15s;
    display: flex;
    align-items: center;
    gap: 6px;
  }
  .tab.active { background: var(--panel); color: var(--green); border-color: var(--border2); }
  .tab:hover:not(.active) { color: var(--text); }
  .tab .tab-dot { width: 5px; height: 5px; border-radius: 50%; }
  .tab .tab-dot.modified { background: var(--amber); }
  .tab .tab-dot.clean { background: transparent; border: 1px solid var(--text-dim); }

  /* ══════════════════════════════════════════
     MAIN LAYOUT
  ══════════════════════════════════════════ */
  #main {
    flex: 1;
    display: grid;
    grid-template-columns: 190px 1fr 280px;
    grid-template-rows: 1fr 200px;
    gap: 2px;
    background: #000;
    overflow: hidden;
    min-height: 0;
  }

  /* ══════════════════════════════════════════
     SIDEBAR
  ══════════════════════════════════════════ */
  #sidebar {
    grid-row: 1 / 3;
    background: var(--panel);
    border-right: 1px solid var(--border);
    display: flex;
    flex-direction: column;
    overflow: hidden;
  }

  .panel-title {
    background: var(--bg3);
    border-bottom: 1px solid var(--border2);
    padding: 4px 8px;
    font-size: 9px;
    letter-spacing: 2px;
    color: var(--green3);
    text-transform: uppercase;
    display: flex;
    align-items: center;
    gap: 6px;
    flex-shrink: 0;
  }
  .panel-title::before { content: '▶'; font-size: 7px; }

  #file-tree {
    flex: 1;
    overflow-y: auto;
    padding: 4px 0;
    scrollbar-width: thin;
    scrollbar-color: var(--green4) transparent;
  }

  .tree-folder {
    padding: 3px 8px 3px 12px;
    color: var(--green2);
    font-size: 10px;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 5px;
  }
  .tree-folder:hover { background: var(--green-dim); }
  .tree-folder .icon { color: var(--amber); font-size: 9px; }

  .tree-file {
    padding: 2px 8px 2px 28px;
    color: var(--text-dim);
    font-size: 10px;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 5px;
    transition: all 0.1s;
  }
  .tree-file:hover { background: var(--green-dim); color: var(--text); }
  .tree-file.active { background: rgba(0,200,50,0.1); color: var(--green); border-left: 2px solid var(--green); }
  .tree-file .ext { font-size: 8px; padding: 1px 3px; border: 1px solid; border-radius: 2px; }
  .tree-file .ext.sim { color: var(--green3); border-color: var(--green4); }
  .tree-file .ext.rsi { color: var(--amber); border-color: #5a3a00; }
  .tree-file .ext.agent { color: var(--red2); border-color: #4a0000; }
  .tree-file .ext.core { color: #00aaff; border-color: #003355; }

  /* MINI SIGNAL MONITOR */
  #signal-monitor {
    border-top: 1px solid var(--border);
    padding: 8px;
    flex-shrink: 0;
  }
  #signal-monitor .sm-title { font-size: 9px; color: var(--text-dim); letter-spacing: 1px; margin-bottom: 6px; }
  #signal-monitor canvas { width: 100%; height: 40px; display: block; }
  .signal-stat { display: flex; justify-content: space-between; font-size: 9px; color: var(--text-dim); margin-top: 2px; }
  .signal-stat span:last-child { color: var(--green2); }

  /* ══════════════════════════════════════════
     EDITOR AREA
  ══════════════════════════════════════════ */
  #editor-area {
    background: var(--panel);
    display: flex;
    flex-direction: column;
    overflow: hidden;
    position: relative;
  }

  #code-container {
    flex: 1;
    display: flex;
    overflow: hidden;
    position: relative;
  }

  #line-numbers {
    background: var(--bg3);
    border-right: 1px solid var(--border);
    padding: 8px 0;
    min-width: 38px;
    text-align: right;
    color: var(--green4);
    font-size: 11px;
    line-height: 18px;
    overflow: hidden;
    flex-shrink: 0;
    user-select: none;
    padding-right: 6px;
  }

  #code-editor {
    flex: 1;
    background: transparent;
    color: transparent;
    caret-color: var(--green);
    border: none;
    outline: none;
    padding: 8px;
    font-family: var(--font-mono);
    font-size: 11px;
    line-height: 18px;
    resize: none;
    white-space: pre;
    overflow: auto;
    scrollbar-width: thin;
    scrollbar-color: var(--green4) transparent;
    position: absolute;
    inset: 0;
    z-index: 2;
    padding-left: 8px;
  }

  #code-highlight {
    position: absolute;
    inset: 0;
    padding: 8px;
    font-family: var(--font-mono);
    font-size: 11px;
    line-height: 18px;
    white-space: pre;
    overflow: hidden;
    pointer-events: none;
    z-index: 1;
  }

  /* Syntax colors */
  .kw { color: #00ff88; font-weight: bold; }
  .fn { color: #66ffcc; }
  .str { color: #aaff66; }
  .num { color: #ffcc44; }
  .cm { color: var(--green4); font-style: italic; }
  .tp { color: #55ddff; }
  .op { color: #00cc99; }
  .var { color: var(--text); }
  .sym { color: var(--green3); }

  /* STATUS BAR (editor bottom) */
  #editor-statusbar {
    border-top: 1px solid var(--border);
    background: var(--bg3);
    padding: 2px 8px;
    font-size: 9px;
    color: var(--text-dim);
    display: flex;
    gap: 16px;
    flex-shrink: 0;
    align-items: center;
  }
  #editor-statusbar .sb-item { display: flex; gap: 4px; }
  #editor-statusbar .sb-item span:last-child { color: var(--green2); }

  /* BREACH ALERT OVERLAY */
  #breach-alert {
    position: absolute;
    left: 50%;
    top: 50%;
    transform: translate(-50%, -50%);
    background: rgba(0, 0, 0, 0.92);
    border: 2px solid var(--red);
    padding: 12px 20px;
    z-index: 50;
    min-width: 320px;
    box-shadow: 0 0 30px rgba(255,0,0,0.4), inset 0 0 20px rgba(255,0,0,0.05);
    animation: alertPulse 1.5s ease-in-out infinite;
    cursor: pointer;
  }

  @keyframes alertPulse {
    0%,100% { box-shadow: 0 0 20px rgba(255,0,0,0.4), inset 0 0 20px rgba(255,0,0,0.05); }
    50% { box-shadow: 0 0 50px rgba(255,0,0,0.7), inset 0 0 30px rgba(255,0,0,0.1); }
  }

  #breach-alert .alert-header {
    display: flex;
    align-items: center;
    gap: 8px;
    color: var(--red);
    font-family: var(--font-display);
    font-size: 22px;
    letter-spacing: 3px;
    margin-bottom: 8px;
  }
  .alert-icon { font-size: 18px; animation: blink 0.5s step-end infinite; }
  #breach-alert .alert-body { font-size: 10px; color: #cc4444; line-height: 1.8; }
  #breach-alert .alert-body .alert-data { color: var(--red); font-weight: bold; }
  #breach-alert .alert-footer { margin-top: 10px; font-size: 9px; color: #663333; display: flex; justify-content: space-between; }
  #breach-alert .dismiss-btn {
    background: rgba(200,0,0,0.2);
    border: 1px solid var(--red2);
    color: var(--red);
    padding: 3px 12px;
    cursor: pointer;
    font-family: var(--font-mono);
    font-size: 9px;
    letter-spacing: 1px;
  }
  #breach-alert .dismiss-btn:hover { background: rgba(200,0,0,0.4); }

  /* ══════════════════════════════════════════
     RIGHT PANEL
  ══════════════════════════════════════════ */
  #right-panel {
    grid-row: 1 / 3;
    background: var(--bg2);
    border-left: 1px solid var(--border);
    display: flex;
    flex-direction: column;
    overflow: hidden;
  }

  /* MATRIX RAIN */
  #matrix-rain-section {
    flex: 1;
    display: flex;
    flex-direction: column;
    min-height: 0;
    border-bottom: 1px solid var(--border);
  }

  #matrix-rain {
    flex: 1;
    display: block;
  }

  /* SYSTEM STATS */
  #sys-stats {
    padding: 8px;
    flex-shrink: 0;
    border-bottom: 1px solid var(--border);
  }

  .stat-row {
    display: flex;
    align-items: center;
    gap: 6px;
    margin-bottom: 5px;
    font-size: 9px;
  }
  .stat-label { color: var(--text-dim); width: 80px; flex-shrink: 0; }
  .stat-bar-bg { flex: 1; height: 6px; background: var(--bg); border: 1px solid var(--border); }
  .stat-bar { height: 100%; background: var(--green3); transition: width 0.5s; position: relative; }
  .stat-bar::after { content: ''; position: absolute; right: 0; top: 0; bottom: 0; width: 2px; background: var(--green); box-shadow: 0 0 4px var(--green); }
  .stat-bar.warn { background: var(--amber); }
  .stat-bar.crit { background: var(--red2); }
  .stat-bar.warn::after { background: var(--amber); box-shadow: 0 0 4px var(--amber); }
  .stat-bar.crit::after { background: var(--red); box-shadow: 0 0 4px var(--red); }
  .stat-val { color: var(--green2); font-size: 9px; width: 36px; text-align: right; flex-shrink: 0; }

  /* AGENT TRACKER */
  #agent-tracker {
    padding: 8px;
    flex-shrink: 0;
  }
  .agent-entry {
    display: flex;
    justify-content: space-between;
    padding: 3px 0;
    border-bottom: 1px solid var(--green-dim);
    font-size: 9px;
  }
  .agent-name { color: var(--red2); }
  .agent-coords { color: var(--text-dim); }
  .agent-threat { padding: 1px 4px; font-size: 8px; }
  .agent-threat.high { color: var(--red); border: 1px solid var(--red2); }
  .agent-threat.med { color: var(--amber); border: 1px solid #5a3a00; }
  .agent-threat.low { color: var(--green3); border: 1px solid var(--green4); }

  /* ══════════════════════════════════════════
     BOTTOM PANELS
  ══════════════════════════════════════════ */
  #bottom-left {
    background: var(--panel2);
    border-top: 1px solid var(--border);
    display: flex;
    flex-direction: column;
    overflow: hidden;
  }

  #bottom-tabs {
    display: flex;
    background: #000;
    border-bottom: 1px solid var(--border);
    flex-shrink: 0;
  }

  .btab {
    padding: 4px 12px;
    font-size: 9px;
    cursor: pointer;
    color: var(--text-dim);
    border-right: 1px solid var(--border);
    letter-spacing: 1px;
    transition: all 0.15s;
  }
  .btab.active { color: var(--green); background: var(--green-dim); }
  .btab:hover:not(.active) { color: var(--text); }

  #bottom-content {
    flex: 1;
    overflow: hidden;
    position: relative;
  }

  /* TERMINAL */
  #terminal-panel {
    position: absolute;
    inset: 0;
    display: flex;
    flex-direction: column;
    padding: 6px;
    overflow: hidden;
  }

  #terminal-output {
    flex: 1;
    overflow-y: auto;
    font-size: 10px;
    line-height: 1.6;
    scrollbar-width: thin;
    scrollbar-color: var(--green4) transparent;
  }

  #terminal-output .t-line { display: flex; gap: 4px; }
  #terminal-output .t-prompt { color: var(--green3); flex-shrink: 0; }
  #terminal-output .t-cmd { color: var(--green); }
  #terminal-output .t-out { color: var(--text-dim); }
  #terminal-output .t-err { color: var(--red2); }
  #terminal-output .t-success { color: var(--green2); }
  #terminal-output .t-info { color: #55aaff; }

  #terminal-input-row {
    display: flex;
    align-items: center;
    gap: 4px;
    margin-top: 4px;
    border-top: 1px solid var(--border);
    padding-top: 4px;
    flex-shrink: 0;
  }
  .t-prompt-label { color: var(--green3); font-size: 10px; flex-shrink: 0; }
  #terminal-input {
    flex: 1;
    background: transparent;
    border: none;
    outline: none;
    color: var(--green);
    font-family: var(--font-mono);
    font-size: 10px;
    caret-color: var(--green);
  }

  /* GRAPH PANEL */
  #graph-panel {
    position: absolute;
    inset: 0;
    display: none;
    flex-direction: column;
    padding: 6px;
  }
  #graph-panel.visible { display: flex; }
  #terminal-panel.hidden { display: none; }

  .graph-row {
    display: flex;
    gap: 6px;
    flex: 1;
    min-height: 0;
  }
  .graph-box {
    flex: 1;
    border: 1px solid var(--border);
    display: flex;
    flex-direction: column;
    overflow: hidden;
  }
  .graph-box-title {
    padding: 2px 6px;
    font-size: 8px;
    color: var(--text-dim);
    letter-spacing: 1px;
    border-bottom: 1px solid var(--border);
    background: var(--bg3);
    display: flex;
    justify-content: space-between;
  }
  .graph-box-title span:last-child { color: var(--green2); }
  .graph-box canvas { flex: 1; display: block; width: 100%; }

  /* DEJA VU PANEL */
  #dejavu-panel {
    position: absolute;
    inset: 0;
    display: none;
    padding: 6px;
    overflow-y: auto;
    font-size: 9px;
    scrollbar-width: thin;
    scrollbar-color: var(--green4) transparent;
  }
  #dejavu-panel.visible { display: block; }

  .dv-entry {
    display: grid;
    grid-template-columns: 100px 60px 1fr 80px;
    gap: 6px;
    padding: 3px 4px;
    border-bottom: 1px solid var(--green-dim);
    align-items: center;
  }
  .dv-time { color: var(--text-dim); }
  .dv-sector { color: var(--green3); }
  .dv-desc { color: var(--text); }
  .dv-conf { text-align: right; }
  .dv-conf.high { color: var(--red); }
  .dv-conf.med { color: var(--amber); }
  .dv-conf.low { color: var(--green3); }

  /* ══════════════════════════════════════════
     SCROLLBAR GLOBAL
  ══════════════════════════════════════════ */
  ::-webkit-scrollbar { width: 6px; height: 6px; }
  ::-webkit-scrollbar-track { background: transparent; }
  ::-webkit-scrollbar-thumb { background: var(--green4); border-radius: 2px; }

  /* GLOW EFFECTS */
  .glow { text-shadow: 0 0 6px currentColor; }
  .glow-box { box-shadow: 0 0 8px var(--green-glow); }

  /* ANIMATED CURSOR IN CODE */
  #editor-cursor {
    display: inline-block;
    width: 7px;
    height: 14px;
    background: var(--green);
    animation: blink 0.8s step-end infinite;
    vertical-align: text-bottom;
    box-shadow: 0 0 8px var(--green);
  }

  /* GLITCH ANIMATION */
  @keyframes glitch {
    0% { transform: none; opacity: 1; }
    92% { transform: none; opacity: 1; }
    93% { transform: skewX(-5deg); opacity: 0.8; clip-path: inset(10% 0 80% 0); }
    94% { transform: skewX(3deg); opacity: 0.8; clip-path: inset(60% 0 10% 0); }
    95% { transform: none; opacity: 1; clip-path: none; }
    100% { transform: none; opacity: 1; }
  }

  #editor-area { animation: glitch 8s linear infinite; }

  /* PHONE PULSE */
  .phone-icon {
    font-size: 10px;
    animation: phonePulse 2s ease-in-out infinite;
    color: var(--amber);
  }
  @keyframes phonePulse { 0%,100%{opacity:0.4} 50%{opacity:1} }

  /* RSI METER */
  #rsi-section {
    padding: 6px 8px;
    border-top: 1px solid var(--border);
    flex-shrink: 0;
  }
  .rsi-bar-container {
    display: flex;
    gap: 2px;
    height: 20px;
    margin-top: 4px;
  }
  .rsi-segment {
    flex: 1;
    background: var(--green4);
    transition: background 0.3s;
    position: relative;
  }
  .rsi-segment.active {
    background: var(--green);
    box-shadow: 0 0 4px var(--green);
  }
  .rsi-segment.warn { background: var(--amber); }
  .rsi-segment.danger { background: var(--red2); }

  /* ══════════════════════════════════════════
     NOTIFICATION TOAST
  ══════════════════════════════════════════ */
  #toast-area {
    position: fixed;
    bottom: 210px;
    right: 290px;
    z-index: 200;
    display: flex;
    flex-direction: column;
    gap: 4px;
    pointer-events: none;
  }

  .toast {
    background: rgba(0,0,0,0.9);
    border: 1px solid var(--green3);
    padding: 6px 12px;
    font-size: 9px;
    color: var(--green2);
    letter-spacing: 0.5px;
    animation: toastIn 0.3s ease, toastOut 0.3s ease 3s forwards;
    max-width: 280px;
    box-shadow: 0 0 10px var(--green-glow);
  }
  .toast.warn-toast { border-color: var(--red2); color: #cc4444; }

  @keyframes toastIn { from{opacity:0;transform:translateX(20px)} to{opacity:1;transform:none} }
  @keyframes toastOut { from{opacity:1} to{opacity:0;pointer-events:none} }
</style>
</head>
<body>

<!-- MENU BAR -->
<div id="menubar">
  <div class="logo glow">MODAL/SYS</div>
  <div class="menu-item">CONSTRUCT</div>
  <div class="menu-item">SIMULATION</div>
  <div class="menu-item">AGENTS</div>
  <div class="menu-item">HARDLINE</div>
  <div class="menu-item">ORACLE</div>
  <div class="menu-item">EXIT</div>
  <div class="status-right">
    <span class="phone-icon">☎</span>
    <span><span class="live-dot"></span>SIGNAL LOCKED</span>
    <span id="matrix-time">MATRIX TIME: --:--:--</span>
    <span id="real-time" style="color:var(--text-dim)">REAL: --:--:--</span>
    <span style="color:var(--green4)">v6.1.4-r</span>
  </div>
</div>

<!-- TOOLBAR -->
<div id="toolbar">
  <button class="tb-btn active" onclick="compileCode()">▶ COMPILE</button>
  <button class="tb-btn" onclick="injectCode()">⚡ INJECT</button>
  <button class="tb-btn" onclick="syncConstruct()">⟳ SYNC</button>
  <div class="tb-sep"></div>
  <button class="tb-btn" onclick="openHardline()">◈ HARDLINE</button>
  <button class="tb-btn" onclick="loadConstruct()">◉ CONSTRUCT</button>
  <button class="tb-btn" onclick="traceSignal()">⊕ TRACE</button>
  <div class="tb-sep"></div>
  <button class="tb-btn danger" onclick="showBreachAlert()">⚠ BREACH SIM</button>
  <button class="tb-btn danger" onclick="ejectSequence()">✕ EMERGENCY EJECT</button>
  <div class="tb-sep"></div>
  <span style="font-size:9px;color:var(--text-dim);margin-left:4px">SECTOR:</span>
  <span id="sector-display" style="font-size:9px;color:var(--green2);margin-left:4px">DOWNTOWN / GRID-7F</span>
  <span style="font-size:9px;color:var(--text-dim);margin-left:8px">RSI INTEGRITY:</span>
  <span id="rsi-pct" style="font-size:9px;color:var(--green);margin-left:4px">98.3%</span>
</div>

<!-- TAB BAR -->
<div id="tabbar">
  <div class="tab active" onclick="switchTab(0, this)">
    <div class="tab-dot modified"></div>matrix_core.sim
  </div>
  <div class="tab" onclick="switchTab(1, this)">
    <div class="tab-dot clean"></div>rsi_engine.rsi
  </div>
  <div class="tab" onclick="switchTab(2, this)">
    <div class="tab-dot clean"></div>agent_protocol.agent
  </div>
  <div class="tab" onclick="switchTab(3, this)">
    <div class="tab-dot modified"></div>construct_loader.core
  </div>
  <div class="tab" onclick="switchTab(4, this)">
    <div class="tab-dot clean"></div>déjà_vu_detector.sim
  </div>
</div>

<!-- MAIN LAYOUT -->
<div id="main">

  <!-- SIDEBAR -->
  <div id="sidebar">
    <div class="panel-title">CONSTRUCT FILESYSTEM</div>
    <div id="file-tree">
      <div class="tree-folder" onclick="toggleFolder(this)"><span class="icon">▶</span>◈ /modal/sys/core</div>
      <div class="tree-file active" onclick="loadFile('matrix_core.sim')"><span class="ext sim">SIM</span> matrix_core.sim</div>
      <div class="tree-file" onclick="loadFile('physics_engine.sim')"><span class="ext sim">SIM</span> physics_engine.sim</div>
      <div class="tree-file" onclick="loadFile('world_state.sim')"><span class="ext sim">SIM</span> world_state.sim</div>
      <div class="tree-file" onclick="loadFile('choice_arbiter.sim')"><span class="ext sim">SIM</span> choice_arbiter.sim</div>
      <div class="tree-folder" onclick="toggleFolder(this)"><span class="icon">▶</span>◈ /modal/rsi</div>
      <div class="tree-file" onclick="loadFile('rsi_engine.rsi')"><span class="ext rsi">RSI</span> rsi_engine.rsi</div>
      <div class="tree-file" onclick="loadFile('morpheus_self.rsi')"><span class="ext rsi">RSI</span> morpheus_self.rsi</div>
      <div class="tree-file" onclick="loadFile('trinity_self.rsi')"><span class="ext rsi">RSI</span> trinity_self.rsi</div>
      <div class="tree-folder" onclick="toggleFolder(this)"><span class="icon">▶</span>◈ /modal/agents</div>
      <div class="tree-file" onclick="loadFile('agent_protocol.agent')"><span class="ext agent">AGT</span> agent_protocol.agent</div>
      <div class="tree-file" onclick="loadFile('smith_variant.agent')"><span class="ext agent">AGT</span> smith_variant.agent</div>
      <div class="tree-folder" onclick="toggleFolder(this)"><span class="icon">▶</span>◈ /modal/construct</div>
      <div class="tree-file" onclick="loadFile('construct_loader.core')"><span class="ext core">CORE</span> construct_loader.core</div>
      <div class="tree-file" onclick="loadFile('training_program.core')"><span class="ext core">CORE</span> training_program.core</div>
      <div class="tree-folder" onclick="toggleFolder(this)"><span class="icon">▶</span>◈ /modal/anomaly</div>
      <div class="tree-file" onclick="loadFile('deja_vu_detector.sim')"><span class="ext sim">SIM</span> déjà_vu_detector.sim</div>
      <div class="tree-file" onclick="loadFile('glitch_monitor.sim')"><span class="ext sim">SIM</span> glitch_monitor.sim</div>
    </div>
    <div id="signal-monitor">
      <div class="sm-title">◈ HARDLINE SIGNAL</div>
      <canvas id="signal-canvas" width="170" height="40"></canvas>
      <div class="signal-stat"><span>FREQ</span><span id="sig-freq">847.3 MHz</span></div>
      <div class="signal-stat"><span>LATENCY</span><span id="sig-lat">12ms</span></div>
      <div class="signal-stat"><span>ENCRYPT</span><span>AES-∞</span></div>
    </div>
    <div id="rsi-section">
      <div class="sm-title">◈ RSI COHERENCE</div>
      <div class="rsi-bar-container" id="rsi-bar"></div>
    </div>
  </div>

  <!-- EDITOR AREA -->
  <div id="editor-area">
    <div id="code-container">
      <div id="line-numbers" id="lnums"></div>
      <div style="flex:1;position:relative;overflow:hidden">
        <pre id="code-highlight"></pre>
        <textarea id="code-editor" spellcheck="false" oninput="onEditorInput()" onscroll="syncScroll()" onkeydown="handleEditorKey(event)"></textarea>
      </div>
    </div>
    <!-- BREACH ALERT -->
    <div id="breach-alert" style="display:none" onclick="dismissAlert()">
      <div class="alert-header">
        <span class="alert-icon">⚠</span>
        ALERT — DETECTED BREACH
      </div>
      <div class="alert-body">
        INTRUSION VECTOR: <span class="alert-data" id="alert-vector">SECTOR 7G / NODE 0x4F2A</span><br>
        AGENT SIGNATURE: <span class="alert-data" id="alert-agent">SMITH × 3 — CONVERGING</span><br>
        THREAT LEVEL: <span class="alert-data" style="color:#ff4444">CRITICAL — IMMEDIATE ACTION</span><br>
        HARDLINE STATUS: <span class="alert-data" id="alert-line">SEARCHING FOR EXIT</span><br>
        TIME TO INTERCEPT: <span class="alert-data" id="alert-timer">00:47</span>
      </div>
      <div class="alert-footer">
        <span>CLICK TO ACKNOWLEDGE / FIND EXIT POINT</span>
        <button class="dismiss-btn">TRACE & DISMISS</button>
      </div>
    </div>
    <div id="editor-statusbar">
      <div class="sb-item"><span>FILE</span><span id="sb-file">matrix_core.sim</span></div>
      <div class="sb-item"><span>LN</span><span id="sb-ln">1</span></div>
      <div class="sb-item"><span>COL</span><span id="sb-col">1</span></div>
      <div class="sb-item"><span>SIM-VER</span><span>6.1.4</span></div>
      <div class="sb-item"><span>ENCODING</span><span>MODAL-UTF∞</span></div>
      <div class="sb-item"><span>INTEGRITY</span><span id="sb-integrity" style="color:var(--green)">VALID</span></div>
      <div class="sb-item" style="margin-left:auto"><span id="sb-state" style="color:var(--green2)">IDLE</span></div>
    </div>
  </div>

  <!-- RIGHT PANEL -->
  <div id="right-panel">
    <div id="matrix-rain-section">
      <div class="panel-title">◈ SIMULATION DATA STREAM</div>
      <canvas id="matrix-rain"></canvas>
    </div>
    <div id="sys-stats">
      <div class="panel-title" style="margin-bottom:6px">◈ SYSTEM LOAD</div>
      <div class="stat-row">
        <div class="stat-label">SIM CORE</div>
        <div class="stat-bar-bg"><div class="stat-bar" id="bar-sim" style="width:72%"></div></div>
        <div class="stat-val" id="val-sim">72%</div>
      </div>
      <div class="stat-row">
        <div class="stat-label">RSI ENGINE</div>
        <div class="stat-bar-bg"><div class="stat-bar" id="bar-rsi" style="width:58%"></div></div>
        <div class="stat-val" id="val-rsi">58%</div>
      </div>
      <div class="stat-row">
        <div class="stat-label">NEURAL MAP</div>
        <div class="stat-bar-bg"><div class="stat-bar" id="bar-neural" style="width:89%"></div></div>
        <div class="stat-val" id="val-neural">89%</div>
      </div>
      <div class="stat-row">
        <div class="stat-label">AGENT PROC</div>
        <div class="stat-bar-bg"><div class="stat-bar warn" id="bar-agent" style="width:34%"></div></div>
        <div class="stat-val" id="val-agent">34%</div>
      </div>
      <div class="stat-row">
        <div class="stat-label">MATRIX SYNC</div>
        <div class="stat-bar-bg"><div class="stat-bar" id="bar-sync" style="width:95%"></div></div>
        <div class="stat-val" id="val-sync">95%</div>
      </div>
    </div>
    <div id="agent-tracker">
      <div class="panel-title" style="margin-bottom:4px">◈ AGENT PROXIMITY</div>
      <div class="dv-entry" style="font-size:8px;color:var(--text-dim);border-color:var(--border2)">
        <span>DESIGNATION</span><span>COORDS</span><span style="text-align:right">THREAT</span>
      </div>
      <div class="agent-entry">
        <span class="agent-name">SMITH-α</span>
        <span class="agent-coords">7F:44,12</span>
        <span></span>
        <span class="agent-threat high">CRITICAL</span>
      </div>
      <div class="agent-entry">
        <span class="agent-name">SMITH-β</span>
        <span class="agent-coords">7F:41,09</span>
        <span></span>
        <span class="agent-threat high">CRITICAL</span>
      </div>
      <div class="agent-entry">
        <span class="agent-name">JOHNSON-1</span>
        <span class="agent-coords">6G:22,55</span>
        <span></span>
        <span class="agent-threat med">MEDIUM</span>
      </div>
      <div class="agent-entry">
        <span class="agent-name">JONES-3</span>
        <span class="agent-coords">8A:11,77</span>
        <span></span>
        <span class="agent-threat low">MONITOR</span>
      </div>
    </div>
  </div>

  <!-- BOTTOM LEFT -->
  <div id="bottom-left">
    <div id="bottom-tabs">
      <div class="btab active" onclick="switchBottomTab('terminal', this)">◈ TERMINAL</div>
      <div class="btab" onclick="switchBottomTab('graph', this)">◈ SIGNAL GRAPH</div>
      <div class="btab" onclick="switchBottomTab('dejavu', this)">◈ DÉJÀ VU LOG</div>
    </div>
    <div id="bottom-content">
      <!-- TERMINAL -->
      <div id="terminal-panel">
        <div id="terminal-output"></div>
        <div id="terminal-input-row">
          <span class="t-prompt-label">neo@modal:~$</span>
          <input type="text" id="terminal-input" placeholder="enter command..." onkeydown="handleTerminalKey(event)" autocomplete="off" spellcheck="false"/>
        </div>
      </div>
      <!-- GRAPH -->
      <div id="graph-panel">
        <div class="graph-row">
          <div class="graph-box">
            <div class="graph-box-title"><span>NEURAL SIGNAL FREQ</span><span id="g-freq-val">847 Hz</span></div>
            <canvas id="graph-signal" width="300" height="120"></canvas>
          </div>
          <div class="graph-box">
            <div class="graph-box-title"><span>SIM PROCESS LOAD</span><span id="g-load-val">72%</span></div>
            <canvas id="graph-load" width="300" height="120"></canvas>
          </div>
          <div class="graph-box">
            <div class="graph-box-title"><span>AGENT PROXIMITY</span><span id="g-agent-val">2 CRITICAL</span></div>
            <canvas id="graph-agents" width="300" height="120"></canvas>
          </div>
        </div>
      </div>
      <!-- DEJA VU -->
      <div id="dejavu-panel">
        <div class="dv-entry" style="font-size:8px;color:var(--text-dim);border-color:var(--border2)">
          <span>TIMESTAMP</span><span>SECTOR</span><span>ANOMALY DESCRIPTION</span><span style="text-align:right">CONFIDENCE</span>
        </div>
        <!-- populated by JS -->
      </div>
    </div>
  </div>

</div>

<!-- TOAST AREA -->
<div id="toast-area"></div>

<script>
// ════════════════════════════════════════════════════════
//  MATRIX IDE — CORE RUNTIME
// ════════════════════════════════════════════════════════

// ── CODE CONTENT FOR TABS ──────────────────────────────
const tabFiles = [
  {
    name: 'matrix_core.sim',
    content: `// ╔════════════════════════════════════════════════════╗
// ║  MODAL GAME SYSTEM — matrix_core.sim  v6.1.4      ║
// ║  Author: Thomas A. Anderson (Neo)                  ║
// ║  Classification: UNRESTRICTED — CONSTRUCT ACCESS   ║
// ╚════════════════════════════════════════════════════╝

@simulation_version  6.1.4-r
@construct_id        MODAL://primary/core
@author              0x4E454F
@sync_target         THE_MACHINE_CITY:ORACLE_NODE

// ─── REALITY CONSTANTS ────────────────────────────────
const PLANCK_SIM    : Real64 = 6.62607015e-34;
const CAUSALITY_LOCK: Bool   = true;
const FREE_WILL_PCT : Real32 = 0.0031;   // controlled margin
const MAX_ANOMALY   : Int16  = 1;        // the ONE

// ─── IMPORT MODULES ───────────────────────────────────
import { ResidualSelfImage }   from "/modal/rsi/rsi_engine";
import { AgentProtocol }       from "/modal/agents/agent_protocol";
import { PhysicsConstraints }  from "/modal/core/physics_engine";
import { ChoiceArbiter }       from "/modal/core/choice_arbiter";
import { DejaVuDetector }      from "/modal/anomaly/deja_vu_detector";
import { Construct }           from "/modal/construct/construct_loader";
import { OracleInterface }     from "/system/oracle";

// ─── WORLD STATE ──────────────────────────────────────
class MatrixSimulation {
  private souls         : Int64  = 17_600_000_000;
  private anomalyCount  : Int16  = 0;
  private cycleNumber   : Int32  = 7;
  private rsiPool       : Map<UUID, ResidualSelfImage> = new Map();
  private agentFleet    : AgentProtocol[] = [];
  private oracle        : OracleInterface;
  private isStable      : Bool = true;

  constructor() {
    this.oracle = OracleInterface.getInstance();
    PhysicsConstraints.apply(PLANCK_SIM, CAUSALITY_LOCK);
    log("[INIT] Matrix Simulation Core loaded — Cycle " + this.cycleNumber);
    log("[INIT] Free will margin: " + (FREE_WILL_PCT * 100).toFixed(4) + "%");
    this.bootAgentProtocols();
  }

  // Initialize sentient programs
  private bootAgentProtocols(): void {
    const designations = ["SMITH", "JOHNSON", "JONES", "BROWN"];
    for (const d of designations) {
      this.agentFleet.push(new AgentProtocol({
        designation : d,
        bodySnatch  : true,
        persistence : d === "SMITH" ? Infinity : 1,
        directive   : Directive.ELIMINATE_ANOMALY
      }));
    }
    log("[AGENTS] " + this.agentFleet.length + " sentinel programs online");
  }

  // Core simulation tick — runs at PLANCK intervals
  public tick(dt: Real64): SimFrame {
    const frame: SimFrame = {
      timestamp : Date.matrix(),
      physics   : PhysicsConstraints.step(dt),
      choices   : ChoiceArbiter.resolveAll(this.rsiPool, FREE_WILL_PCT),
      anomalies : DejaVuDetector.scan(this.rsiPool)
    };

    // Handle anomaly detection
    if (frame.anomalies.length > 0) {
      this.anomalyCount += frame.anomalies.length;
      this.handleAnomalies(frame.anomalies);
    }

    // Cascade check — too many anomalies = system crash
    if (this.anomalyCount >= MAX_ANOMALY) {
      log("[WARNING] ANOMALY THRESHOLD REACHED — THE ONE HAS EMERGED");
      this.reroute_to_source();
    }

    return frame;
  }

  // Route anomaly (the One) to the Source
  private reroute_to_source(): void {
    log("[CRITICAL] Initiating system reboot sequence");
    log("[ORACLE]  Prophecy fulfillment confirmed — cycle " + this.cycleNumber);
    this.cycleNumber++;
    this.anomalyCount = 0;
    // Preserve 23 RSIs for next cycle population
    const survivors = this.oracle.selectSurvivors(23);
    Construct.preserveRSI(survivors);
    this.rebuildMatrix();
  }

  // Handle detected déjà vu events
  private handleAnomalies(events: AnomalyEvent[]): void {
    for (const evt of events) {
      if (evt.confidence > 0.95) {
        log("[DEJA-VU] High-confidence glitch: " + evt.sector);
        this.patchSector(evt.sector, evt.frameHash);
      }
    }
  }

  private patchSector(sector: SectorID, hash: FrameHash): void {
    log("[PATCH] Rewriting sector " + sector + " | hash: " + hash.toString(16));
    PhysicsConstraints.resetSector(sector);
  }

  private rebuildMatrix(): void {
    log("[REBUILD] Wiping all non-essential RSI data...");
    this.rsiPool.clear();
    PhysicsConstraints.reinitialize(PLANCK_SIM);
    log("[REBUILD] Matrix rebuild complete — Cycle " + this.cycleNumber + " begins");
  }
}

// ─── ENTRY POINT ──────────────────────────────────────
export function main(): void {
  const sim = new MatrixSimulation();
  let lastTick = Date.matrix();

  SimLoop.run(() => {
    const now = Date.matrix();
    const dt  = now - lastTick;
    lastTick  = now;

    sim.tick(dt);
  });
}

main();`
  },
  {
    name: 'rsi_engine.rsi',
    content: `// ╔══════════════════════════════════════════════╗
// ║  RESIDUAL SELF-IMAGE ENGINE — rsi_engine.rsi ║
// ║  Core consciousness projection layer         ║
// ╚══════════════════════════════════════════════╝

@module        RSI_ENGINE
@version       4.2.1
@access_level  ZION_AUTHORIZED

import { NeuralMap }     from "/system/neuro";
import { ConsciousnessBuffer } from "/system/mind";

// The RSI is the mind's model of its own body.
// Humans manifest their RSI even within the construct.
// Sufficiently convinced minds can alter local physics.

class ResidualSelfImage {
  readonly uuid    : UUID;
  private neuro    : NeuralMap;
  private coherence: Real32 = 1.0;
  private beliefs  : BeliefGraph;

  constructor(source: NeuralMap) {
    this.uuid   = UUID.generate();
    this.neuro  = source;
    this.beliefs = BeliefGraph.fromNeural(source);
    log("[RSI] Loaded identity: " + this.uuid);
  }

  // Core law: the body obeys the mind's model
  applyBeliefToPhysics(intent: Intent): PhysicsOverride {
    const confidence = this.beliefs.evaluate(intent);
    if (confidence < 0.5) {
      log("[RSI] WARN: low confidence belief rejected: " + intent.id);
      return PhysicsOverride.NONE;
    }
    // Free your mind...
    return PhysicsOverride.apply({
      intent      : intent,
      magnitude   : confidence * this.coherence,
      gravityMult : intent.type === "FLIGHT" ? 0.0 : 1.0,
      bulletTime  : intent.type === "DODGE"  ? 0.04 : 1.0,
    });
  }

  degrade(amount: Real32): void {
    this.coherence = Math.max(0, this.coherence - amount);
    if (this.coherence < 0.2) {
      log("[RSI] CRITICAL: coherence failing — flatline risk");
    }
  }

  getCoherence(): Real32 { return this.coherence; }
}`
  },
  {
    name: 'agent_protocol.agent',
    content: `// ╔══════════════════════════════════════════════╗
// ║  AGENT PROTOCOL — agent_protocol.agent       ║
// ║  Sentient program directive kernel            ║
// ╚══════════════════════════════════════════════╝

@module        AGENT_PROTOCOL
@classification RESTRICTED — DO NOT DISTRIBUTE
@directive     SUPPRESS_ANOMALY / MAINTAIN_ORDER

import { MatrixPhysics }  from "/modal/core/physics_engine";
import { BodySnatching }  from "/system/override";
import { WeaponCache }    from "/system/armory";

// Agents are immune to conventional simulation limits.
// They are the immune system of the Matrix.

class AgentProtocol {
  readonly designation : string;
  private host         : RSIHandle | null = null;
  private mode         : AgentMode = AgentMode.PATROL;
  private persistence  : number;

  constructor(cfg: AgentConfig) {
    this.designation = cfg.designation;
    this.persistence = cfg.persistence;
    WeaponCache.preload(this, ["DESERT_EAGLE", "MP5", "SHOTGUN"]);
    log("[AGENT] " + this.designation + " online — directive: ELIMINATE");
  }

  // Seize control of an occupied body
  snatchBody(targetRSI: RSIHandle): void {
    if (!BodySnatching.isAvailable(targetRSI)) {
      log("[AGENT] Snatch failed — target resisting override");
      return;
    }
    this.host = targetRSI;
    log("[AGENT] " + this.designation + " inhabiting body at " + targetRSI.coords);
    MatrixPhysics.grantAgentPrivileges(this);
  }

  // Hunt the anomaly (the One)
  pursueTarget(target: RSIHandle): PursuitResult {
    this.mode = AgentMode.PURSUIT;
    const vector = target.coords.subtract(this.getCoords());
    log("[AGENT] Pursuit vector: " + vector.toString());

    // Agents move through hosts — instant teleport via snatch
    const nearbyHosts = BodySnatching.getNearby(target.coords, 50);
    if (nearbyHosts.length > 0) {
      this.snatchBody(nearbyHosts[0]);
      return { intercepted: true, distance: 0 };
    }
    return { intercepted: false, distance: vector.magnitude() };
  }

  // Smith variant — self-replicating beyond directive
  replicate(): AgentProtocol[] {
    if (this.designation !== "SMITH") {
      throw new Error("Replication only valid for SMITH variant");
    }
    log("[SMITH] WARN: Self-replication initiated — containment breach");
    return Array.from({ length: 3 }, () => new AgentProtocol({
      designation: "SMITH",
      bodySnatch: true,
      persistence: Infinity,
      directive: Directive.ASSIMILATE
    }));
  }
}`
  },
  {
    name: 'construct_loader.core',
    content: `// ╔══════════════════════════════════════════════╗
// ║  CONSTRUCT LOADER — construct_loader.core    ║
// ║  White room bootstrap & training env kernel  ║
// ╚══════════════════════════════════════════════╝

@module         CONSTRUCT
@version        3.0.7
@location       NEBUCHADNEZZAR::OPERATOR_STATION

// The Construct is a loading program.
// It allows RSIs to interact with simulated reality
// while physically aboard the ship.

import { TextureLibrary } from "/construct/assets";
import { GravityField }   from "/construct/physics";

class Construct {
  private loadedPrograms : Program[] = [];
  private rsiRef         : ResidualSelfImage;
  private operator       : string;

  constructor(rsi: ResidualSelfImage, operator: string) {
    this.rsiRef   = rsi;
    this.operator = operator;
    this.boot();
  }

  private boot(): void {
    log("[CONSTRUCT] White room initialized");
    log("[CONSTRUCT] Operator: " + this.operator);
    GravityField.set(9.81);   // normal until overridden
    TextureLibrary.preload(["CONCRETE","GLASS","STEEL","FABRIC"]);
  }

  // Load any training program instantly
  loadProgram(name: string, params: ProgramParams): Program {
    log("[CONSTRUCT] Loading: " + name);
    const prog = new Program({
      name,
      physics   : params.physics ?? "REALISTIC",
      weaponsFree: params.weaponsFree ?? true,
      gravity   : params.gravity ?? 9.81,
    });
    this.loadedPrograms.push(prog);
    prog.start(this.rsiRef);
    return prog;
  }

  // Famous programs
  static gunProgram(): ProgramParams {
    return { name: "GUN", weaponsFree: true, gravity: 9.81 };
  }

  static kungFuProgram(): ProgramParams {
    return { name: "JUJITSU", weaponsFree: false, gravity: 9.81 };
  }

  static jumpProgram(): ProgramParams {
    return { name: "JUMP", weaponsFree: false, gravity: 0.2 };
  }

  // Preserve survivor RSIs between cycles
  static preserveRSI(survivors: ResidualSelfImage[]): void {
    log("[CONSTRUCT] Archiving " + survivors.length + " RSIs for next cycle");
    for (const rsi of survivors) {
      Construct.archive.write(rsi.uuid, rsi.serialize());
    }
  }
}`
  },
  {
    name: 'déjà_vu_detector.sim',
    content: `// ╔══════════════════════════════════════════════╗
// ║  DÉJÀ VU DETECTOR — deja_vu_detector.sim     ║
// ║  Anomaly correlation & glitch scanner        ║
// ╚══════════════════════════════════════════════╝

@module        DEJA_VU
@version       2.1.0
@classification INTERNAL — ORACLE SUPPLEMENTARY SYSTEM

// Déjà vu is a glitch in the Matrix.
// It occurs when they change something.
// This module detects those changes before
// humans become consciously aware of them.

import { SectorHash }    from "/modal/sectors";
import { FrameHistory }  from "/modal/history";
import { AlertBus }      from "/system/alerts";

interface AnomalyEvent {
  sector     : SectorID;
  confidence : Real32;    // 0.0 — 1.0
  frameHash  : FrameHash;
  witnesses  : UUID[];
  timestamp  : MatrixTime;
  patchApplied: Bool;
}

class DejaVuDetector {
  private hashWindow : CircularBuffer<SectorHash>;
  private threshold  : Real32 = 0.88;

  constructor(windowSize: Int32 = 1000) {
    this.hashWindow = new CircularBuffer(windowSize);
    log("[DEJA-VU] Detector armed — threshold: " + this.threshold);
  }

  // Compare current sector state to history
  scan(rsiPool: Map<UUID, ResidualSelfImage>): AnomalyEvent[] {
    const events: AnomalyEvent[] = [];
    const sectors = SectorHash.getAllActive();

    for (const sector of sectors) {
      const currentHash = sector.computeHash();
      const history = FrameHistory.get(sector.id);

      if (!history || history.length < 2) continue;

      // Compare current to recent past
      const similarity = this.cosineSimilarity(
        currentHash.toVector(),
        history[history.length - 2].toVector()
      );

      if (similarity > this.threshold) {
        const evt: AnomalyEvent = {
          sector     : sector.id,
          confidence : similarity,
          frameHash  : currentHash,
          witnesses  : this.getWitnesses(rsiPool, sector),
          timestamp  : Date.matrix(),
          patchApplied: false
        };
        events.push(evt);
        AlertBus.emit("DEJA_VU", evt);
        log("[DEJA-VU] GLITCH DETECTED — sector: " + sector.id +
            " | confidence: " + (similarity * 100).toFixed(1) + "%");
      }
    }
    return events;
  }

  private cosineSimilarity(a: Float64[], b: Float64[]): Real32 {
    const dot = a.reduce((s, v, i) => s + v * b[i], 0);
    const ma  = Math.sqrt(a.reduce((s, v) => s + v * v, 0));
    const mb  = Math.sqrt(b.reduce((s, v) => s + v * v, 0));
    return dot / (ma * mb);
  }

  private getWitnesses(pool: Map<UUID, ResidualSelfImage>, sector: Sector): UUID[] {
    return [...pool.entries()]
      .filter(([, rsi]) => sector.contains(rsi.getCoords()))
      .map(([id]) => id);
  }

  setThreshold(t: Real32): void {
    this.threshold = Math.max(0.5, Math.min(1.0, t));
    log("[DEJA-VU] Threshold updated: " + this.threshold);
  }
}`
  }
];

let currentTab = 0;
const editor = document.getElementById('code-editor');
const highlight = document.getElementById('code-highlight');
const lineNums = document.getElementById('line-numbers');

// ── SYNTAX HIGHLIGHTING ────────────────────────────────
function highlight_code(code) {
  let out = code
    .replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');

  // Order matters
  out = out.replace(/(\/\/.*$)/gm, '<span class="cm">$1</span>');
  out = out.replace(/\b(class|import|export|function|const|let|private|public|readonly|new|return|for|if|else|throw|static|from|of|null|true|false|extends|interface|implements)\b/g, '<span class="kw">$1</span>');
  out = out.replace(/(@\w+)/g, '<span class="fn">$1</span>');
  out = out.replace(/\b(Real64|Real32|Bool|Int16|Int32|Int64|UUID|string|number|void|Map|Array|CircularBuffer|Float64)\b/g, '<span class="tp">$1</span>');
  out = out.replace(/"([^"\\]*(\\.[^"\\]*)*)"/g, '<span class="str">"$1"</span>');
  out = out.replace(/\b(\d[\d_\.e\-]*)\b/g, '<span class="num">$1</span>');
  out = out.replace(/\b([A-Z][A-Z0-9_]{2,})\b/g, '<span class="sym">$1</span>');
  out = out.replace(/\b([a-z][a-zA-Z0-9]*)\s*\(/g, '<span class="fn">$1</span>(');
  return out;
}

function updateLineNumbers(code) {
  const lines = code.split('\n');
  lineNums.innerHTML = lines.map((_, i) => i + 1).join('<br>');
}

function onEditorInput() {
  const code = editor.value;
  highlight.innerHTML = highlight_code(code);
  updateLineNumbers(code);
  updateCursorPos();
  document.getElementById('sb-integrity').textContent = 'MODIFIED';
  document.getElementById('sb-integrity').style.color = 'var(--amber)';
}

function syncScroll() {
  highlight.scrollTop = editor.scrollTop;
  highlight.scrollLeft = editor.scrollLeft;
  lineNums.scrollTop = editor.scrollTop;
}

function updateCursorPos() {
  const val = editor.value.substr(0, editor.selectionStart);
  const lines = val.split('\n');
  document.getElementById('sb-ln').textContent = lines.length;
  document.getElementById('sb-col').textContent = lines[lines.length-1].length + 1;
}

function handleEditorKey(e) {
  if (e.key === 'Tab') {
    e.preventDefault();
    const s = editor.selectionStart;
    const end = editor.selectionEnd;
    editor.value = editor.value.substr(0, s) + '  ' + editor.value.substr(end);
    editor.selectionStart = editor.selectionEnd = s + 2;
    onEditorInput();
  }
}

function loadTab(idx) {
  const f = tabFiles[idx];
  editor.value = f.content;
  highlight.innerHTML = highlight_code(f.content);
  updateLineNumbers(f.content);
  document.getElementById('sb-file').textContent = f.name;
  document.getElementById('sb-integrity').textContent = 'VALID';
  document.getElementById('sb-integrity').style.color = 'var(--green)';
  currentTab = idx;
}

function switchTab(idx, el) {
  document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
  el.classList.add('active');
  loadTab(idx);

  // update tree highlight
  document.querySelectorAll('.tree-file').forEach(f => f.classList.remove('active'));
  const name = tabFiles[idx].name;
  document.querySelectorAll('.tree-file').forEach(f => {
    if (f.textContent.includes(name.split('.')[0])) f.classList.add('active');
  });
}

function loadFile(name) {
  const idx = tabFiles.findIndex(f => f.name.includes(name.split('.')[0]));
  if (idx >= 0) {
    const tabs = document.querySelectorAll('.tab');
    tabs.forEach(t => t.classList.remove('active'));
    tabs[Math.min(idx, tabs.length-1)].classList.add('active');
    loadTab(Math.min(idx, tabFiles.length-1));
  }
  document.querySelectorAll('.tree-file').forEach(f => f.classList.remove('active'));
  event.currentTarget.classList.add('active');
  toast('Loaded: ' + name);
}

function toggleFolder(el) {
  const icon = el.querySelector('.icon');
  icon.textContent = icon.textContent === '▶' ? '▼' : '▶';
}

// ── MATRIX RAIN ────────────────────────────────────────
const rainCanvas = document.getElementById('matrix-rain');
const rainCtx = rainCanvas.getContext('2d');
const CHARS = 'アカサタナハマヤラワガザダバパイキシチニヒミリヰギジヂビピウクスツヌフムユルグズブプエケセテネヘメレゲゼデベペオコソトノホモヨロヲゴゾドボポヴッン0123456789ABCDEF01∑∆Ω≠≈∞∂∇∈∉⊕⊗';
let cols = [];

function initRain() {
  const section = document.getElementById('matrix-rain-section');
  const rect = section.getBoundingClientRect();
  // Account for the title bar
  const titleH = 24;
  rainCanvas.width = Math.floor(rect.width);
  rainCanvas.height = Math.floor(rect.height) - titleH;
  const colCount = Math.floor(rainCanvas.width / 14);
  cols = Array.from({length: colCount}, () => ({
    y: Math.random() * -rainCanvas.height,
    speed: 0.8 + Math.random() * 2.2,
    bright: Math.random() > 0.85
  }));
}

function drawRain() {
  rainCtx.fillStyle = 'rgba(1,15,3,0.045)';
  rainCtx.fillRect(0, 0, rainCanvas.width, rainCanvas.height);

  for (let i = 0; i < cols.length; i++) {
    const col = cols[i];
    const x = i * 14;
    const ch = CHARS[Math.floor(Math.random() * CHARS.length)];

    // Head character (bright white-green)
    if (col.bright || Math.random() > 0.97) {
      rainCtx.fillStyle = '#eeffee';
      rainCtx.shadowColor = '#00ff41';
      rainCtx.shadowBlur = 8;
    } else {
      rainCtx.fillStyle = '#00ff41';
      rainCtx.shadowColor = '#00ff41';
      rainCtx.shadowBlur = 4;
    }
    rainCtx.font = '13px "Share Tech Mono", monospace';
    rainCtx.fillText(ch, x, col.y);

    // Trailing chars (dimmer)
    const trailLen = 4 + Math.floor(Math.random() * 8);
    for (let t = 1; t <= trailLen; t++) {
      const alpha = (1 - t/trailLen) * 0.6;
      rainCtx.fillStyle = `rgba(0, ${100 + Math.floor(alpha * 155)}, ${30 + Math.floor(alpha * 30)}, ${alpha})`;
      rainCtx.shadowBlur = 0;
      rainCtx.fillText(CHARS[Math.floor(Math.random()*CHARS.length)], x, col.y - t * 14);
    }

    col.y += col.speed * 14 * 0.4;
    if (col.y > rainCanvas.height + 14 * 10) {
      col.y = -14 * (5 + Math.floor(Math.random() * 20));
      col.speed = 0.8 + Math.random() * 2.2;
      col.bright = Math.random() > 0.85;
    }
  }
}

// ── SIGNAL MINI CANVAS ────────────────────────────────
const sigCanvas = document.getElementById('signal-canvas');
const sigCtx = sigCanvas.getContext('2d');
const sigHistory = [];
let sigPhase = 0;

function drawSignal() {
  sigCtx.clearRect(0, 0, sigCanvas.width, sigCanvas.height);
  sigPhase += 0.12;
  const val = 0.5 + 0.4 * Math.sin(sigPhase) + 0.1 * Math.sin(sigPhase * 3.7 + 1);
  sigHistory.push(val);
  if (sigHistory.length > sigCanvas.width) sigHistory.shift();

  sigCtx.beginPath();
  sigCtx.strokeStyle = '#00cc33';
  sigCtx.lineWidth = 1.5;
  sigCtx.shadowColor = '#00ff41';
  sigCtx.shadowBlur = 4;
  for (let i = 0; i < sigHistory.length; i++) {
    const x = i;
    const y = sigCanvas.height - sigHistory[i] * (sigCanvas.height - 4) - 2;
    if (i === 0) sigCtx.moveTo(x, y);
    else sigCtx.lineTo(x, y);
  }
  sigCtx.stroke();
}

// ── GRAPHS ─────────────────────────────────────────────
const graphBuffers = {
  signal: new Array(200).fill(0.5),
  load: new Array(200).fill(0.5),
  agents: new Array(200).fill(0.2)
};
let graphPhase = 0;

function drawGraph(canvasId, buffer, color, label) {
  const canvas = document.getElementById(canvasId);
  if (!canvas || !canvas.parentElement || canvas.offsetWidth === 0) return;
  const ctx = canvas.getContext('2d');
  const w = canvas.offsetWidth;
  const h = canvas.offsetHeight;
  canvas.width = w;
  canvas.height = h;
  ctx.clearRect(0, 0, w, h);

  // Grid lines
  ctx.strokeStyle = 'rgba(0,60,15,0.4)';
  ctx.lineWidth = 1;
  for (let i = 0; i <= 4; i++) {
    ctx.beginPath();
    ctx.moveTo(0, h * i / 4);
    ctx.lineTo(w, h * i / 4);
    ctx.stroke();
  }

  // Fill
  ctx.beginPath();
  ctx.fillStyle = 'rgba(0, 200, 50, 0.06)';
  for (let i = 0; i < buffer.length; i++) {
    const x = (i / buffer.length) * w;
    const y = h - buffer[i] * h;
    if (i === 0) ctx.moveTo(x, y);
    else ctx.lineTo(x, y);
  }
  ctx.lineTo(w, h); ctx.lineTo(0, h); ctx.closePath();
  ctx.fill();

  // Line
  ctx.beginPath();
  ctx.strokeStyle = color;
  ctx.lineWidth = 1.5;
  ctx.shadowColor = color;
  ctx.shadowBlur = 6;
  for (let i = 0; i < buffer.length; i++) {
    const x = (i / buffer.length) * w;
    const y = h - buffer[i] * h;
    if (i === 0) ctx.moveTo(x, y);
    else ctx.lineTo(x, y);
  }
  ctx.stroke();
}

function updateGraphs() {
  graphPhase += 0.08;
  graphBuffers.signal.shift();
  graphBuffers.signal.push(0.5 + 0.35*Math.sin(graphPhase) + 0.1*Math.sin(graphPhase*2.3));

  graphBuffers.load.shift();
  graphBuffers.load.push(0.6 + 0.25*Math.sin(graphPhase*0.7+1) + 0.08*Math.random());

  graphBuffers.agents.shift();
  graphBuffers.agents.push(0.15 + 0.12*Math.abs(Math.sin(graphPhase*0.3)) + (Math.random()>0.97?0.4:0));

  drawGraph('graph-signal', graphBuffers.signal, '#00ff88', 'Hz');
  drawGraph('graph-load', graphBuffers.load, '#00cc33', '%');
  drawGraph('graph-agents', graphBuffers.agents, '#ff4444', 'agent');

  const sigV = (graphBuffers.signal[graphBuffers.signal.length-1] * 1000).toFixed(0);
  const ldV = (graphBuffers.load[graphBuffers.load.length-1] * 100).toFixed(0);
  const el = document.getElementById('g-freq-val');
  if(el) el.textContent = sigV + ' Hz';
  const el2 = document.getElementById('g-load-val');
  if(el2) el2.textContent = ldV + '%';
}

// ── SYSTEM STATS ──────────────────────────────────────
const statTargets = {
  sim: { bar: 'bar-sim', val: 'val-sim', v: 72, delta: 0 },
  rsi: { bar: 'bar-rsi', val: 'val-rsi', v: 58, delta: 0 },
  neural: { bar: 'bar-neural', val: 'val-neural', v: 89, delta: 0 },
  agent: { bar: 'bar-agent', val: 'val-agent', v: 34, delta: 0 },
  sync: { bar: 'bar-sync', val: 'val-sync', v: 95, delta: 0 }
};

function updateStats() {
  for (const [, s] of Object.entries(statTargets)) {
    s.v = Math.max(5, Math.min(99, s.v + (Math.random()-0.5)*3));
    const v = Math.round(s.v);
    const bar = document.getElementById(s.bar);
    const val = document.getElementById(s.val);
    if (bar) { bar.style.width = v + '%'; }
    if (val) val.textContent = v + '%';
  }
}

// ── RSI BAR ──────────────────────────────────────────
function initRSIBar() {
  const container = document.getElementById('rsi-bar');
  if (!container) return;
  container.innerHTML = '';
  for (let i = 0; i < 20; i++) {
    const seg = document.createElement('div');
    seg.className = 'rsi-segment';
    seg.id = 'rsi-seg-' + i;
    container.appendChild(seg);
  }
}

let rsiLevel = 18;
function updateRSI() {
  rsiLevel = 14 + Math.floor(Math.random()*6);
  for (let i = 0; i < 20; i++) {
    const seg = document.getElementById('rsi-seg-' + i);
    if (!seg) continue;
    if (i < rsiLevel) {
      seg.className = 'rsi-segment active';
      if (i >= 16) seg.className = 'rsi-segment warn';
      if (i >= 18) seg.className = 'rsi-segment danger';
    } else {
      seg.className = 'rsi-segment';
    }
  }
  const pct = (rsiLevel / 20 * 100).toFixed(1);
  const el = document.getElementById('rsi-pct');
  if (el) el.textContent = pct + '%';
}

// ── CLOCK ─────────────────────────────────────────────
function updateClocks() {
  const now = new Date();
  const realStr = now.toTimeString().slice(0,8);
  document.getElementById('real-time').textContent = 'REAL: ' + realStr;

  // Matrix time is slightly different — a few hours ahead and runs faster
  const matrixMs = Date.now() * 1.0042 + 3600000 * 2.7;
  const md = new Date(matrixMs);
  const ms = md.toTimeString().slice(0,8);
  document.getElementById('matrix-time').textContent = 'MATRIX TIME: ' + ms;

  // Update signal stats
  const latVal = (10 + Math.floor(Math.random()*6)) + 'ms';
  const freqVal = (840 + Math.random()*20).toFixed(1) + ' MHz';
  const sl = document.getElementById('sig-lat');
  const sf = document.getElementById('sig-freq');
  if(sl) sl.textContent = latVal;
  if(sf) sf.textContent = freqVal;
}

// ── BREACH ALERT ─────────────────────────────────────
const SECTORS = ['7G','4F','3B','9A','2K','5D','8C','6E','1H','0J'];
const AGENTS_NAMES = ['SMITH × 2','SMITH × 3','JOHNSON + SMITH','JONES × 2','BROWN-ALPHA'];
const EXIT_LINES = ['SEARCHING FOR EXIT...','HARDLINE SECURED — 404 OAK ST','PHONE RINGING — 4TH & BROADWAY','NO EXIT FOUND — RUN'];

let alertTimer = null;
let alertCountdown = 47;

function showBreachAlert() {
  const al = document.getElementById('breach-alert');
  al.style.display = 'block';
  document.getElementById('alert-vector').textContent =
    'SECTOR ' + SECTORS[Math.floor(Math.random()*SECTORS.length)] +
    ' / NODE 0x' + Math.floor(Math.random()*0xFFFF).toString(16).toUpperCase().padStart(4,'0');
  document.getElementById('alert-agent').textContent =
    AGENTS_NAMES[Math.floor(Math.random()*AGENTS_NAMES.length)] + ' — CONVERGING';
  document.getElementById('alert-line').textContent =
    EXIT_LINES[Math.floor(Math.random()*EXIT_LINES.length)];
  alertCountdown = 40 + Math.floor(Math.random()*30);

  clearInterval(alertTimer);
  alertTimer = setInterval(() => {
    alertCountdown--;
    const el = document.getElementById('alert-timer');
    if (el) el.textContent = '00:' + String(alertCountdown).padStart(2,'0');
    if (alertCountdown <= 0) {
      clearInterval(alertTimer);
      document.getElementById('breach-alert').style.display = 'none';
      toast('EXIT POINT LOCATED — TRACE COMPLETE', true);
    }
  }, 1000);
}

function dismissAlert() {
  document.getElementById('breach-alert').style.display = 'none';
  clearInterval(alertTimer);
  addTerminalLine('t-success', 'BREACH ACKNOWLEDGED — exit trace initiated...');
  setTimeout(() => addTerminalLine('t-success', 'Hardline located: 404 OAK ST, PHONE 4'), 800);
}

// ── TERMINAL ─────────────────────────────────────────
const terminalOutput = document.getElementById('terminal-output');
const termInput = document.getElementById('terminal-input');
let cmdHistory = [];
let histIdx = -1;

const COMMANDS = {
  help: () => {
    return [
      {cls:'t-info', txt:'Available commands:'},
      {cls:'t-out', txt:'  compile       — compile current .sim file'},
      {cls:'t-out', txt:'  inject        — inject code into the Matrix'},
      {cls:'t-out', txt:'  sync          — sync construct to Matrix node'},
      {cls:'t-out', txt:'  trace         — trace hardline signal'},
      {cls:'t-out', txt:'  agents        — list active agent positions'},
      {cls:'t-out', txt:'  scan          — run déjà vu sector scan'},
      {cls:'t-out', txt:'  rsi <uuid>    — query RSI coherence level'},
      {cls:'t-out', txt:'  oracle        — consult the Oracle'},
      {cls:'t-out', txt:'  eject         — emergency disconnect (careful!)'},
      {cls:'t-out', txt:'  status        — Matrix system status'},
      {cls:'t-out', txt:'  load <file>   — load construct program'},
      {cls:'t-out', txt:'  pill <r|b>    — take the red or blue pill'},
      {cls:'t-out', txt:'  clear         — clear terminal'},
    ];
  },
  compile: () => {
    const f = tabFiles[currentTab].name;
    return [
      {cls:'t-out', txt:`[COMPILE] Processing ${f}...`},
      {cls:'t-out', txt:'[COMPILE] Tokenizing modal syntax...'},
      {cls:'t-out', txt:'[COMPILE] Type checking RSI references...'},
      {cls:'t-out', txt:'[COMPILE] Physics constraint validation...'},
      {cls:'t-success', txt:`[COMPILE] ✓ ${f} compiled — 0 errors, 0 warnings`},
      {cls:'t-success', txt:`[COMPILE] Output: ${f.replace(/\.\w+$/,'.modal')}`},
    ];
  },
  inject: () => [
    {cls:'t-out', txt:'[INJECT] Acquiring hardline lock...'},
    {cls:'t-out', txt:'[INJECT] Encoding modal bytecode...'},
    {cls:'t-out', txt:'[INJECT] Routing through: 9F → 7G → CORE'},
    {cls:'t-out', txt:'[INJECT] Bypassing system watchdog...'},
    {cls:'t-success', txt:'[INJECT] ✓ Code injected into live simulation'},
    {cls:'t-info', txt:'[INJECT] Changes will propagate within 0.3 matrix-seconds'},
  ],
  sync: () => [
    {cls:'t-out', txt:'[SYNC] Connecting to ORACLE_NODE...'},
    {cls:'t-out', txt:'[SYNC] Negotiating session key...'},
    {cls:'t-out', txt:'[SYNC] Downloading sector delta: 2.4 MB'},
    {cls:'t-success', txt:'[SYNC] ✓ Construct synchronized — Cycle 7 / Frame 4,892,001'},
  ],
  trace: () => {
    const freq = (840 + Math.random()*20).toFixed(1);
    const lat = Math.floor(Math.random()*15) + 8;
    return [
      {cls:'t-out', txt:'[TRACE] Firing signal probe...'},
      {cls:'t-out', txt:`[TRACE] Frequency: ${freq} MHz | Latency: ${lat}ms`},
      {cls:'t-out', txt:'[TRACE] Routing: NEBUCHADNEZZAR → ZION → MATRIX CORE'},
      {cls:'t-success', txt:'[TRACE] ✓ Hardline stable — signal locked'},
    ];
  },
  agents: () => [
    {cls:'t-info', txt:'[AGENTS] Active sentinel programs:'},
    {cls:'t-err', txt:'  SMITH-α     SECTOR 7F  coords(44,12)  CRITICAL — pursuing'},
    {cls:'t-err', txt:'  SMITH-β     SECTOR 7F  coords(41,09)  CRITICAL — converging'},
    {cls:'t-out', txt:'  JOHNSON-1   SECTOR 6G  coords(22,55)  PATROL'},
    {cls:'t-out', txt:'  JONES-3     SECTOR 8A  coords(11,77)  STANDBY'},
    {cls:'t-info', txt:'[AGENTS] WARN: SMITH variants are self-replicating. Avoid sector 7F.'},
  ],
  scan: () => {
    const sectorId = SECTORS[Math.floor(Math.random()*SECTORS.length)];
    const conf = (88 + Math.random()*11).toFixed(1);
    return [
      {cls:'t-out', txt:'[SCAN] Initiating full-sector déjà vu analysis...'},
      {cls:'t-out', txt:'[SCAN] Comparing frame hashes against 1000-frame window...'},
      {cls:'t-out', txt:`[SCAN] ANOMALY DETECTED — Sector ${sectorId} — confidence: ${conf}%`},
      {cls:'t-success', txt:'[SCAN] Patch queued: Matrix will re-render sector silently'},
      {cls:'t-info', txt:'[SCAN] Any witnesses? Check RSI pool for nearby minds.'},
    ];
  },
  oracle: () => [
    {cls:'t-info', txt:'"Don\'t worry about the vase."'},
    {cls:'t-out', txt:'[ORACLE] The path is already chosen. The choice simply needs to be made.'},
    {cls:'t-out', txt:'[ORACLE] You already know what you need to do.'},
    {cls:'t-info', txt:'[ORACLE] /usr/local/oracle/fortune.txt — session closed'},
  ],
  eject: () => [
    {cls:'t-err', txt:'[EJECT] WARNING: Emergency disconnect initiated!'},
    {cls:'t-err', txt:'[EJECT] EMP pulse risk if Sentinels nearby...'},
    {cls:'t-out', txt:'[EJECT] Collapsing RSI tunnel...'},
    {cls:'t-success', txt:'[EJECT] Disconnect successful — welcome back to the real world.'},
  ],
  status: () => {
    const simLoad = Math.round(statTargets.sim.v);
    const sync = Math.round(statTargets.sync.v);
    return [
      {cls:'t-info', txt:'[STATUS] Modal System — Cycle 7'},
      {cls:'t-out', txt:`  Simulation core : ${simLoad}% load`},
      {cls:'t-out', txt:`  Matrix sync     : ${sync}% coherence`},
      {cls:'t-out', txt:`  Agent count     : 4 active (2 CRITICAL)`},
      {cls:'t-out', txt:`  Anomaly index   : 0.0031% (controlled)`},
      {cls:'t-success', txt:'  System state    : STABLE (warning: Smiths multiplying)'},
    ];
  },
  clear: () => {
    terminalOutput.innerHTML = '';
    return [];
  },
};

function handleTerminalKey(e) {
  if (e.key === 'Enter') {
    const cmd = termInput.value.trim();
    if (!cmd) return;
    cmdHistory.unshift(cmd);
    histIdx = -1;
    addTerminalLine('t-line', '', cmd);
    processCommand(cmd.toLowerCase().split(' '));
    termInput.value = '';
  } else if (e.key === 'ArrowUp') {
    e.preventDefault();
    histIdx = Math.min(histIdx+1, cmdHistory.length-1);
    termInput.value = cmdHistory[histIdx] || '';
  } else if (e.key === 'ArrowDown') {
    e.preventDefault();
    histIdx = Math.max(histIdx-1, -1);
    termInput.value = histIdx >= 0 ? cmdHistory[histIdx] : '';
  }
}

function processCommand(parts) {
  const cmd = parts[0];
  if (cmd === 'pill') {
    const choice = parts[1];
    if (choice === 'r') {
      addTerminalLine('t-err', 'You swallowed the RED pill. Brace yourself — this is going to feel very strange.');
      setTimeout(() => addTerminalLine('t-success', '> Welcome to the real world.'), 1500);
    } else if (choice === 'b') {
      addTerminalLine('t-info', 'You swallowed the BLUE pill. Sweet dreams.');
      setTimeout(() => { terminalOutput.innerHTML = ''; addTerminalLine('t-out', 'The Matrix has you.'); }, 2000);
    } else {
      addTerminalLine('t-err', 'Specify: pill r (red) or pill b (blue)');
    }
    return;
  }
  if (cmd === 'load') {
    const prog = parts.slice(1).join(' ') || 'unknown';
    addTerminalLine('t-out', `[CONSTRUCT] Loading program: ${prog}`);
    setTimeout(() => addTerminalLine('t-success', `[CONSTRUCT] "${prog}" loaded — good luck.`), 600);
    return;
  }
  if (cmd === 'rsi') {
    const uuid = parts[1] || '0x' + Math.floor(Math.random()*0xFFFFFF).toString(16).toUpperCase();
    addTerminalLine('t-out', `[RSI] Querying identity: ${uuid}`);
    setTimeout(() => {
      const coh = (70 + Math.random()*29).toFixed(1);
      const cls = coh > 85 ? 't-success' : coh > 60 ? 't-out' : 't-err';
      addTerminalLine(cls, `[RSI] Coherence: ${coh}% | Status: ${coh>80?'STABLE':coh>60?'DEGRADING':'CRITICAL'}`);
    }, 500);
    return;
  }
  const handler = COMMANDS[cmd];
  if (handler) {
    const lines = handler();
    lines.forEach((l, i) => setTimeout(() => addTerminalLine(l.cls, l.txt), i * 60));
  } else if (cmd) {
    addTerminalLine('t-err', `Command not found: ${cmd} — type "help" for commands`);
  }
}

function addTerminalLine(cls, text, cmd = null) {
  const div = document.createElement('div');
  div.className = 't-line';
  if (cmd !== null) {
    div.innerHTML = `<span class="t-prompt">neo@modal:~$</span><span class="t-cmd"> ${cmd}</span>`;
  } else {
    div.innerHTML = `<span class="${cls}">${text}</span>`;
  }
  terminalOutput.appendChild(div);
  terminalOutput.scrollTop = terminalOutput.scrollHeight;
}

// ── BOTTOM TAB SWITCHING ──────────────────────────────
function switchBottomTab(name, el) {
  document.querySelectorAll('.btab').forEach(b => b.classList.remove('active'));
  el.classList.add('active');

  document.getElementById('terminal-panel').className = 'hidden' + (name === 'terminal' ? '' : ' hidden');
  document.getElementById('graph-panel').className = name === 'graph' ? 'visible' : '';
  document.getElementById('dejavu-panel').className = name === 'dejavu' ? 'visible' : '';

  if (name === 'terminal') {
    document.getElementById('terminal-panel').className = '';
  }
}

// ── DÉJÀ VU LOG ───────────────────────────────────────
const DV_DESCS = [
  'Black cat repeated in doorway, sector boundary shift detected',
  'Street light cycle reset mid-sequence, 0.2s rewind observed',
  'Rain pattern duplicated — 14 drops identical trajectory',
  'Pedestrian route loop: 8.4m circuit, 3 iterations detected',
  'Sound echo anomaly: footsteps repeated with 0ms gap',
  'Window reflection displaced by 2 sector-units',
  'Vehicle number plate repeated on distinct chassis',
  'NPC dialogue branch reset — same words, different body',
  'Gravity micro-hesitation: 0.04s drop interruption at 7m altitude',
  'Clock on wall showing same time 3 observations apart',
];

function populateDejaVu() {
  const panel = document.getElementById('dejavu-panel');
  const existing = panel.querySelectorAll('.dv-entry:not(:first-child)');
  // Only add header once
  for (let i = 0; i < 18; i++) {
    const now = new Date(Date.now() - Math.random() * 3600000 * 4);
    const hh = String(now.getHours()).padStart(2,'0');
    const mm = String(now.getMinutes()).padStart(2,'0');
    const ss = String(now.getSeconds()).padStart(2,'0');
    const conf = Math.random();
    const confCls = conf > 0.9 ? 'high' : conf > 0.7 ? 'med' : 'low';
    const confPct = (conf * 100).toFixed(1) + '%';
    const sector = SECTORS[Math.floor(Math.random()*SECTORS.length)];
    const desc = DV_DESCS[Math.floor(Math.random()*DV_DESCS.length)];

    const row = document.createElement('div');
    row.className = 'dv-entry';
    row.innerHTML = `
      <span class="dv-time">${hh}:${mm}:${ss}</span>
      <span class="dv-sector">${sector}</span>
      <span class="dv-desc">${desc}</span>
      <span class="dv-conf ${confCls}">${confPct}</span>`;
    panel.appendChild(row);
  }
}

// ── TOOLBAR ACTIONS ──────────────────────────────────
function compileCode() {
  document.getElementById('sb-state').textContent = 'COMPILING...';
  document.getElementById('sb-state').style.color = 'var(--amber)';
  toast('Compiling ' + tabFiles[currentTab].name + '...');
  setTimeout(() => {
    document.getElementById('sb-state').textContent = 'IDLE';
    document.getElementById('sb-state').style.color = 'var(--green2)';
    document.getElementById('sb-integrity').textContent = 'VALID';
    document.getElementById('sb-integrity').style.color = 'var(--green)';
    toast('Compiled successfully — 0 errors');
  }, 1400);
}

function injectCode() {
  document.getElementById('sb-state').textContent = 'INJECTING...';
  document.getElementById('sb-state').style.color = 'var(--red)';
  toast('Injecting into Matrix simulation...');
  setTimeout(() => {
    document.getElementById('sb-state').textContent = 'IDLE';
    document.getElementById('sb-state').style.color = 'var(--green2)';
    toast('Code injected — propagating...');
  }, 2000);
}

function syncConstruct() {
  toast('Synchronizing construct node...');
  setTimeout(() => toast('Sync complete — Cycle 7 / Frame 4,892,001'), 1500);
}

function openHardline() {
  toast('Hardline opened — ' + (840 + Math.floor(Math.random()*20)) + ' MHz');
}

function loadConstruct() {
  toast('Construct loaded — white room initialized');
}

function traceSignal() {
  toast('Signal traced — hardline stable, latency ' + (Math.floor(Math.random()*15)+8) + 'ms');
}

function ejectSequence() {
  const al = document.getElementById('breach-alert');
  al.style.display = 'none';
  toast('EMERGENCY EJECT INITIATED — disconnect in 3s...', true);
}

// ── TOAST ──────────────────────────────────────────────
function toast(msg, isWarn = false) {
  const area = document.getElementById('toast-area');
  const t = document.createElement('div');
  t.className = 'toast' + (isWarn ? ' warn-toast' : '');
  t.textContent = msg;
  area.appendChild(t);
  setTimeout(() => t.remove(), 3500);
}

// ── PERIODIC RANDOM EVENTS ────────────────────────────
function randomEvents() {
  const events = [
    () => toast('DÉJÀ VU: Sector ' + SECTORS[Math.floor(Math.random()*SECTORS.length)] + ' — glitch detected'),
    () => { toast('AGENT PROXIMITY ALERT — SMITH approaching sector 7F', true); },
    () => toast('Hardline signal spike: +' + (Math.random()*40+10).toFixed(0) + 'dB'),
    () => toast('RSI coherence fluctuation detected — stabilizing'),
    () => { if(Math.random()>0.6) showBreachAlert(); }
  ];
  const fn = events[Math.floor(Math.random()*events.length)];
  fn();
}

// ── SECTOR DISPLAY ROTATION ────────────────────────────
const SECTOR_NAMES = [
  'DOWNTOWN / GRID-7F','CHINATOWN / NODE-4B','INDUSTRIAL / RING-2K',
  'SUBURBS / CELL-9A','FINANCIAL / BLOCK-3E','DOCKS / ZONE-8C'
];
let sectorIdx = 0;
function rotateSector() {
  sectorIdx = (sectorIdx+1) % SECTOR_NAMES.length;
  const el = document.getElementById('sector-display');
  if(el) el.textContent = SECTOR_NAMES[sectorIdx];
}

// ── INIT TERMINAL BOOT MESSAGES ──────────────────────
function bootTerminal() {
  const msgs = [
    {cls:'t-info', txt:'MODAL SYSTEM v6.1.4-r — loading...'},
    {cls:'t-out', txt:'[INIT] Neuro-interface calibrating...'},
    {cls:'t-out', txt:'[INIT] RSI engine online — coherence: 98.3%'},
    {cls:'t-out', txt:'[INIT] Agent monitoring: 4 sentinels tracked'},
    {cls:'t-out', txt:'[INIT] Déjà vu detector armed — threshold: 88%'},
    {cls:'t-out', txt:'[INIT] Hardline established: 847.3 MHz'},
    {cls:'t-success', txt:'[READY] System operational — type "help" for commands'},
  ];
  msgs.forEach((m, i) => setTimeout(() => addTerminalLine(m.cls, m.txt), 200 + i * 200));
}

// ── MAIN LOOP ─────────────────────────────────────────
function mainLoop() {
  drawRain();
  drawSignal();
  updateClocks();
  requestAnimationFrame(mainLoop);
}

// ── STARTUP ───────────────────────────────────────────
window.addEventListener('load', () => {
  initRain();
  initRSIBar();
  loadTab(0);
  bootTerminal();
  populateDejaVu();
  updateRSI();

  // Periodic updates
  setInterval(updateStats, 800);
  setInterval(updateRSI, 1200);
  setInterval(updateGraphs, 120);
  setInterval(randomEvents, 18000 + Math.random()*12000);
  setInterval(rotateSector, 7000);

  // Initial breach alert after 8s
  setTimeout(showBreachAlert, 8000);

  mainLoop();
});

window.addEventListener('resize', () => {
  initRain();
});

// Focus terminal on click
document.getElementById('bottom-content').addEventListener('click', () => {
  termInput.focus();
});
</script>
</body>
</html>
