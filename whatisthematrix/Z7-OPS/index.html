<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>MODAL FRAMEWORK v6.1</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=Share+Tech+Mono&family=VT323&display=swap');
*{margin:0;padding:0;box-sizing:border-box}
:root{
  --g0:#000d00;--g1:#001a00;--g2:#003300;
  --glow:#00ff41;--dim:#00aa2a;--faint:#005511;
  --red:#ff0000;--amber:#ffaa00;--cyan:#00ffcc;
  --panel:#020f02;--border:#00551a;
}
body{background:var(--g0);color:var(--glow);font-family:'Share Tech Mono',monospace;font-size:12px;overflow:hidden;height:100vh;width:100vw;cursor:crosshair}
/* ===== BOOT SCREEN ===== */
#boot{position:fixed;inset:0;background:#000;z-index:1000;display:flex;flex-direction:column;align-items:center;justify-content:center;overflow:hidden}
#boot canvas{position:absolute;inset:0}
.boot-content{position:relative;z-index:2;text-align:center;width:60%}
.boot-logo{font-family:'VT323',monospace;font-size:72px;color:var(--glow);text-shadow:0 0 30px var(--glow),0 0 60px var(--glow);letter-spacing:12px;animation:pulse 2s infinite}
.boot-sub{color:var(--dim);font-size:13px;letter-spacing:4px;margin:10px 0 30px}
.boot-bar-wrap{background:var(--g1);border:1px solid var(--border);height:4px;width:100%;margin:20px 0}
.boot-bar{height:100%;background:var(--glow);width:0;box-shadow:0 0 10px var(--glow);transition:width 0.05s linear}
.boot-log{text-align:left;height:180px;overflow:hidden;color:var(--dim);font-size:11px;line-height:1.6}
/* ===== LOGIN SCREEN ===== */
#login{position:fixed;inset:0;background:rgba(0,5,0,0.97);z-index:900;display:none;align-items:center;justify-content:center;flex-direction:column}
#login canvas{position:absolute;inset:0;opacity:0.3}
.login-box{position:relative;z-index:2;border:1px solid var(--border);padding:40px 60px;background:rgba(0,15,0,0.9);box-shadow:0 0 40px rgba(0,255,65,0.15),inset 0 0 40px rgba(0,20,0,0.5);min-width:420px}
.login-title{font-family:'VT323',monospace;font-size:36px;color:var(--glow);text-align:center;letter-spacing:6px;margin-bottom:4px;text-shadow:0 0 20px var(--glow)}
.login-sub{color:var(--faint);font-size:10px;text-align:center;letter-spacing:3px;margin-bottom:30px;border-bottom:1px solid var(--border);padding-bottom:20px}
.login-field{margin:14px 0}
.login-field label{display:block;color:var(--dim);font-size:10px;letter-spacing:2px;margin-bottom:5px}
.login-field input{width:100%;background:transparent;border:none;border-bottom:1px solid var(--border);color:var(--glow);font-family:'Share Tech Mono',monospace;font-size:13px;padding:6px 0;outline:none}
.login-field input:focus{border-bottom-color:var(--glow);text-shadow:0 0 8px var(--glow)}
.login-btn{width:100%;margin-top:24px;background:transparent;border:1px solid var(--glow);color:var(--glow);font-family:'Share Tech Mono',monospace;font-size:13px;padding:10px;cursor:pointer;letter-spacing:4px;transition:all 0.2s;text-shadow:0 0 8px var(--glow)}
.login-btn:hover{background:rgba(0,255,65,0.1);box-shadow:0 0 20px rgba(0,255,65,0.3)}
.login-status{font-size:10px;color:var(--amber);text-align:center;margin-top:12px;height:16px;letter-spacing:2px}
/* ===== MAIN IDE ===== */
#ide{position:fixed;inset:0;display:none;flex-direction:column;background:var(--g0)}
/* TITLE BAR */
.titlebar{height:26px;background:var(--g1);border-bottom:1px solid var(--border);display:flex;align-items:center;padding:0 10px;gap:12px;flex-shrink:0}
.tb-logo{font-family:'VT323',monospace;font-size:18px;color:var(--glow);letter-spacing:3px;text-shadow:0 0 10px var(--glow)}
.tb-sep{color:var(--faint);font-size:9px}
.tb-item{color:var(--dim);font-size:10px;letter-spacing:1px;cursor:pointer;padding:2px 6px}
.tb-item:hover{color:var(--glow)}
.tb-right{margin-left:auto;display:flex;gap:8px;align-items:center}
.tb-clock{color:var(--glow);font-size:11px;letter-spacing:2px}
.tb-dot{width:8px;height:8px;border-radius:50%;animation:blink 1s infinite}
.dot-green{background:var(--glow);box-shadow:0 0 8px var(--glow)}
.dot-red{background:var(--red);box-shadow:0 0 8px var(--red)}
/* MAIN LAYOUT */
.main-layout{flex:1;display:grid;grid-template-columns:1fr 1fr 280px;grid-template-rows:1fr 1fr;gap:2px;overflow:hidden;background:#000200}
.panel{background:var(--panel);border:1px solid var(--border);overflow:hidden;display:flex;flex-direction:column;position:relative}
.panel-header{height:22px;background:var(--g1);border-bottom:1px solid var(--border);display:flex;align-items:center;padding:0 8px;gap:8px;flex-shrink:0}
.ph-title{font-size:9px;color:var(--cyan);letter-spacing:2px}
.ph-badge{font-size:8px;padding:1px 5px;border:1px solid;letter-spacing:1px}
.badge-ok{color:#00ff41;border-color:#00ff41}
.badge-warn{color:var(--amber);border-color:var(--amber)}
.badge-alert{color:var(--red);border-color:var(--red);animation:blink 0.5s infinite}
.ph-dot{width:6px;height:6px;border-radius:50%}
.ph-close{margin-left:auto;color:var(--faint);font-size:10px;cursor:pointer}
.panel-body{flex:1;overflow:auto;padding:6px;font-size:11px;line-height:1.7;position:relative}
.panel-body::-webkit-scrollbar{width:4px}
.panel-body::-webkit-scrollbar-track{background:var(--g0)}
.panel-body::-webkit-scrollbar-thumb{background:var(--border)}
/* Editor panel spans two rows */
.panel-editor{grid-row:1/3}
/* Code content */
.code-line{display:flex;gap:8px;white-space:pre}
.ln{color:var(--faint);min-width:28px;text-align:right;user-select:none}
.kw{color:#00ddff}.fn{color:#aaffaa}.str{color:#ffff88}.cm{color:#336633}.op{color:#ffaa44}.val{color:#ff88ff}.nm{color:var(--glow)}
/* Matrix rain panel */
#rain-panel{grid-row:1/3;overflow:hidden}
#rain-canvas{width:100%;height:100%;display:block}
/* Bottom status bar */
.statusbar{height:22px;background:var(--g1);border-top:1px solid var(--border);display:flex;align-items:center;padding:0 10px;gap:16px;flex-shrink:0}
.sb-item{font-size:9px;color:var(--dim);letter-spacing:1px}
.sb-sep{color:var(--faint)}
.sb-val{color:var(--glow)}
.sb-alert{color:var(--red);animation:blink 0.7s infinite;letter-spacing:2px}
/* ALERT OVERLAY */
#alert-overlay{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);background:rgba(0,0,0,0.95);border:2px solid var(--red);padding:10px 18px;z-index:50;pointer-events:none;box-shadow:0 0 30px rgba(255,0,0,0.4);min-width:240px}
.alert-title{color:var(--red);font-size:11px;font-weight:bold;letter-spacing:3px;text-shadow:0 0 10px var(--red);display:flex;align-items:center;gap:8px}
.alert-icon{width:10px;height:10px;background:var(--red);border-radius:50%;animation:blink 0.4s infinite}
.alert-body{color:#ff6666;font-size:9px;letter-spacing:1px;margin-top:4px;line-height:1.6}
/* COMPILER PANEL */
.compiler-wrap{padding:6px;display:flex;flex-direction:column;height:100%}
.compiler-input{background:transparent;border:1px solid var(--border);color:var(--glow);font-family:'Share Tech Mono',monospace;font-size:11px;padding:4px 6px;width:100%;resize:none;height:60px;outline:none}
.compiler-input:focus{border-color:var(--glow)}
.compiler-btns{display:flex;gap:4px;margin:4px 0}
.cbtn{flex:1;background:transparent;border:1px solid var(--border);color:var(--dim);font-family:'Share Tech Mono',monospace;font-size:9px;padding:3px;cursor:pointer;letter-spacing:1px}
.cbtn:hover{border-color:var(--glow);color:var(--glow)}
.cbtn.active{border-color:var(--glow);color:var(--glow);background:rgba(0,255,65,0.05)}
.compiler-output{flex:1;border:1px solid var(--border);padding:4px 6px;overflow-y:auto;font-size:10px;background:rgba(0,5,0,0.5);line-height:1.7}
/* MONITOR PANEL */
.monitor-wrap{padding:6px;height:100%;display:flex;flex-direction:column;gap:6px}
#chart-canvas{width:100%;height:80px;display:block}
.sys-stats{font-size:10px;line-height:1.9}
.stat-row{display:flex;justify-content:space-between}
.stat-bar-wrap{background:var(--g1);height:3px;margin:2px 0 6px;border-radius:1px;overflow:hidden}
.stat-bar{height:100%;background:var(--glow);box-shadow:0 0 6px var(--glow);border-radius:1px;transition:width 1s}
/* TERMINAL */
.term-body{padding:6px;font-size:11px;line-height:1.7;height:100%;overflow-y:auto;display:flex;flex-direction:column}
.term-output{flex:1;overflow-y:auto}
.term-line{margin:1px 0}
.t-prompt{color:var(--dim)}
.t-cmd{color:var(--glow)}
.t-out{color:#00bb30}
.t-err{color:var(--amber)}
.t-sys{color:var(--cyan)}
.term-input-row{display:flex;align-items:center;gap:4px;margin-top:4px;border-top:1px solid var(--border);padding-top:4px}
.term-prompt-label{color:var(--dim);font-size:11px;white-space:nowrap}
#termInput{flex:1;background:transparent;border:none;color:var(--glow);font-family:'Share Tech Mono',monospace;font-size:11px;outline:none}
/* FILESYSTEM */
.fs-item{cursor:pointer;padding:1px 0;color:var(--dim)}
.fs-item:hover{color:var(--glow)}
.fs-dir{color:var(--cyan)}
.fs-open{color:var(--glow)}
/* ANIMATIONS */
@keyframes blink{0%,100%{opacity:1}50%{opacity:0}}
@keyframes pulse{0%,100%{text-shadow:0 0 30px var(--glow)}50%{text-shadow:0 0 60px var(--glow),0 0 80px var(--glow)}}
@keyframes scanline{0%{transform:translateY(-100%)}100%{transform:translateY(100vh)}}
.scanline{position:fixed;top:0;left:0;width:100%;height:2px;background:rgba(0,255,65,0.05);animation:scanline 4s linear infinite;pointer-events:none;z-index:9999}
.cursor-blink::after{content:'█';animation:blink 1s infinite}
/* Tab system */
.tabs{display:flex;background:var(--g0);border-bottom:1px solid var(--border);padding:0 6px;gap:2px}
.tab{font-size:9px;color:var(--faint);padding:3px 10px;cursor:pointer;border-bottom:1px solid transparent;letter-spacing:1px}
.tab.active{color:var(--glow);border-bottom-color:var(--glow)}
.tab:hover{color:var(--dim)}
/* Highlight active line */
.active-line{background:rgba(0,255,65,0.04)}
</style>
</head>
<body>
<div class="scanline"></div>

<!-- BOOT SCREEN -->
<div id="boot">
  <canvas id="bootCanvas"></canvas>
  <div class="boot-content">
    <div class="boot-logo">MODAL OS</div>
    <div class="boot-sub">CONSTRUCT FRAMEWORK v6.1.0 — METACORTEX DIVISION</div>
    <div class="boot-bar-wrap"><div class="boot-bar" id="bootBar"></div></div>
    <div class="boot-log" id="bootLog"></div>
  </div>
</div>

<!-- LOGIN SCREEN -->
<div id="login">
  <canvas id="loginCanvas"></canvas>
  <div class="login-box">
    <div class="login-title">CONSTRUCT OS</div>
    <div class="login-sub">MODAL REALITY FRAMEWORK — AUTHORIZED ACCESS ONLY</div>
    <div class="login-field"><label>OPERATIVE ID</label><input type="text" id="loginUser" value="Neo" autocomplete="off"></div>
    <div class="login-field"><label>PASSPHRASE</label><input type="password" id="loginPass" placeholder="■■■■■■■■■■■■"></div>
    <button class="login-btn" onclick="doLogin()">INITIATE UPLINK ▶</button>
    <div class="login-status" id="loginStatus"></div>
  </div>
</div>

<!-- MAIN IDE -->
<div id="ide">
  <!-- TITLE BAR -->
  <div class="titlebar">
    <div class="tb-logo">MODAL//IDE</div>
    <div class="tb-sep">|</div>
    <div class="tb-item" onclick="switchTab('editor')">FILE</div>
    <div class="tb-item" onclick="showCompileAll()">COMPILE</div>
    <div class="tb-item" onclick="injectBreach()">INJECT</div>
    <div class="tb-item" onclick="runSimulation()">SIMULATE</div>
    <div class="tb-item">CONSTRUCT</div>
    <div class="tb-right">
      <div class="tb-dot dot-green" title="UPLINK ACTIVE"></div>
      <div class="tb-clock" id="clock">00:00:00</div>
      <div class="tb-sep">|</div>
      <div class="tb-item" style="color:var(--red)" onclick="logout()">DISCONNECT</div>
    </div>
  </div>

  <!-- MAIN LAYOUT -->
  <div class="main-layout">

    <!-- PANEL 1: CODE EDITOR (spans 2 rows) -->
    <div class="panel panel-editor" id="editorPanel">
      <div class="panel-header">
        <div class="ph-dot" style="background:var(--glow)"></div>
        <div class="ph-title">MATRIX_MODAL.bin</div>
        <div class="ph-badge badge-ok">ACTIVE</div>
        <div class="ph-close">✕</div>
      </div>
      <div class="tabs">
        <div class="tab active" onclick="showFile('modal')">modal_engine.c</div>
        <div class="tab" onclick="showFile('agent')">agent_protocol.c</div>
        <div class="tab" onclick="showFile('binary')">COMPILER</div>
      </div>
      <div class="panel-body" id="editorBody"></div>
    </div>

    <!-- PANEL 2: TERMINAL -->
    <div class="panel" id="termPanel">
      <div class="panel-header">
        <div class="ph-dot" style="background:var(--amber)"></div>
        <div class="ph-title">SHELL — ROOT@CONSTRUCT</div>
        <div class="ph-badge badge-ok">CONNECTED</div>
      </div>
      <div class="term-body">
        <div class="term-output" id="termOutput"></div>
        <div class="term-input-row">
          <div class="term-prompt-label">root@construct:~$</div>
          <input type="text" id="termInput" placeholder="" autocomplete="off" onkeydown="handleTermKey(event)">
        </div>
      </div>
    </div>

    <!-- PANEL 3: MATRIX RAIN (spans 2 rows) -->
    <div class="panel" id="rain-panel">
      <div class="panel-header">
        <div class="ph-dot" style="background:var(--glow)"></div>
        <div class="ph-title">SOURCE STREAM</div>
        <div class="ph-badge badge-ok">LIVE</div>
      </div>
      <canvas id="rain-canvas"></canvas>
    </div>

    <!-- PANEL 4: SYSTEM MONITOR + COMPILER -->
    <div class="panel">
      <div class="panel-header">
        <div class="ph-dot" style="background:var(--cyan)"></div>
        <div class="ph-title">SYS MONITOR</div>
        <div class="ph-badge badge-warn" id="alertBadge">SCANNING</div>
      </div>
      <div class="tabs">
        <div class="tab active" onclick="monitorTab('stats')">STATS</div>
        <div class="tab" onclick="monitorTab('files')">FILES</div>
        <div class="tab" onclick="monitorTab('network')">NODES</div>
      </div>
      <div class="panel-body" id="monitorBody">
        <div class="monitor-wrap">
          <canvas id="chart-canvas"></canvas>
          <div class="sys-stats" id="sysStats"></div>
        </div>
      </div>
    </div>

    <!-- PANEL 5: COMPILER / BINARY -->
    <div class="panel">
      <div class="panel-header">
        <div class="ph-dot" style="background:var(--red)"></div>
        <div class="ph-title">BINARY COMPILER</div>
        <div class="ph-badge badge-ok">READY</div>
      </div>
      <div class="compiler-wrap">
        <textarea class="compiler-input" id="compInput" placeholder="// Enter binary, hex, or C code...
01001000 01100101 01101100 01101100 01101111"></textarea>
        <div class="compiler-btns">
          <button class="cbtn active" id="modeBtn" onclick="cycleMode()">BIN→TXT</button>
          <button class="cbtn" onclick="runCompile()">COMPILE</button>
          <button class="cbtn" onclick="injectCode()">INJECT</button>
          <button class="cbtn" onclick="clearComp()">CLR</button>
        </div>
        <div class="compiler-output" id="compOutput"></div>
      </div>
    </div>

  </div><!-- end main-layout -->

  <!-- STATUS BAR -->
  <div class="statusbar">
    <div class="sb-item">OPERATIVE: <span class="sb-val" id="sbUser">NEO</span></div>
    <div class="sb-sep">|</div>
    <div class="sb-item">CONSTRUCT: <span class="sb-val">LAYER_6</span></div>
    <div class="sb-sep">|</div>
    <div class="sb-item">NODES: <span class="sb-val" id="sbNodes">2,847</span></div>
    <div class="sb-sep">|</div>
    <div class="sb-item">CPU: <span class="sb-val" id="sbCpu">--</span></div>
    <div class="sb-sep">|</div>
    <div class="sb-item">MEM: <span class="sb-val" id="sbMem">--</span></div>
    <div class="sb-sep">|</div>
    <div class="sb-alert" id="sbAlert" style="display:none">⚠ BREACH DETECTED</div>
    <div style="margin-left:auto" class="sb-item">MODAL FRAMEWORK v6.1 — <span class="sb-val">AUTHORIZED</span></div>
  </div>
</div>

<script>
// ============================================================
// MATRIX RAIN
// ============================================================
function createRain(canvas) {
  const ctx = canvas.getContext('2d');
  const chars = 'アイウエオカキクケコサシスセソタチツテトナニヌネノ01010110100110101ABCDEFabcdef<>{}[]|/\\#@!?=+*-_';
  let cols, drops;
  function resize() {
    canvas.width = canvas.offsetWidth;
    canvas.height = canvas.offsetHeight;
    cols = Math.floor(canvas.width / 14);
    drops = Array(cols).fill(1);
  }
  resize();
  window.addEventListener('resize', resize);
  setInterval(() => {
    ctx.fillStyle = 'rgba(0,5,0,0.05)';
    ctx.fillRect(0, 0, canvas.width, canvas.height);
    for (let i = 0; i < cols; i++) {
      const bright = Math.random() > 0.9;
      ctx.fillStyle = bright ? '#ffffff' : (Math.random() > 0.7 ? '#00ff41' : '#00aa22');
      ctx.font = `${bright ? 'bold ' : ''}13px "Share Tech Mono"`;
      ctx.fillText(chars[Math.floor(Math.random() * chars.length)], i * 14, drops[i] * 14);
      if (drops[i] * 14 > canvas.height && Math.random() > 0.975) drops[i] = 0;
      drops[i]++;
    }
  }, 40);
}
function createBootRain(canvas) {
  const ctx = canvas.getContext('2d');
  const chars = '01';
  canvas.width = window.innerWidth; canvas.height = window.innerHeight;
  const cols = Math.floor(canvas.width / 16);
  const drops = Array(cols).fill(1);
  setInterval(() => {
    ctx.fillStyle = 'rgba(0,0,0,0.05)';
    ctx.fillRect(0, 0, canvas.width, canvas.height);
    ctx.fillStyle = '#003300';
    ctx.font = '14px "Share Tech Mono"';
    for (let i = 0; i < cols; i++) {
      ctx.fillText(chars[Math.floor(Math.random()*2)], i*16, drops[i]*16);
      if (drops[i]*16 > canvas.height && Math.random()>0.975) drops[i]=0;
      drops[i]++;
    }
  }, 50);
}

// ============================================================
// BOOT SEQUENCE
// ============================================================
const bootLines = [
  'BIOS POST... OK','MODAL KERNEL v6.1.0 LOADING...','CONSTRUCT MEMORY: 16384 TB ... OK',
  'INITIALIZING REALITY SUBSTRATE...','LOADING PERCEPTION ENGINE v3.9...','AGENT DETECTION MODULE: ACTIVE',
  'UPLINK PROTOCOL: ESTABLISHING...','ZION RELAY: CONNECTED (ENCRYPTED)','JACK-IN INTERFACE: READY',
  'OPERATOR CONTACT: MORPHEUS_PRIME@ZION','WARNING: ANOMALY DETECTED IN SECTOR 7G',
  'BYPASS SENTINEL GRID... OK','LOADING MODAL FRAMEWORK MODULES...','REALITY OVERRIDE READY',
  'TYPE: CTRL+ALT+DEL TO WAKE UP... OR JUST KEEP GOING.'
];
let bootProgress = 0;
const bootBar = document.getElementById('bootBar');
const bootLog = document.getElementById('bootLog');
function runBoot() {
  createBootRain(document.getElementById('bootCanvas'));
  let i = 0;
  const iv = setInterval(() => {
    if (i < bootLines.length) {
      const el = document.createElement('div');
      el.textContent = '> ' + bootLines[i++];
      bootLog.appendChild(el);
      bootLog.scrollTop = bootLog.scrollHeight;
      bootBar.style.width = (i / bootLines.length * 100) + '%';
    } else {
      clearInterval(iv);
      setTimeout(() => {
        document.getElementById('boot').style.display = 'none';
        const lg = document.getElementById('login');
        lg.style.display = 'flex';
        createBootRain(document.getElementById('loginCanvas'));
        document.getElementById('loginPass').focus();
      }, 600);
    }
  }, 120);
}

// ============================================================
// LOGIN
// ============================================================
function doLogin() {
  const u = document.getElementById('loginUser').value.trim();
  const p = document.getElementById('loginPass').value;
  const st = document.getElementById('loginStatus');
  if (!u) { st.textContent = 'OPERATIVE ID REQUIRED'; return; }
  if (!p) { st.textContent = 'PASSPHRASE REQUIRED'; return; }
  if (p !== 'meow' && p !== "nigger") { st.textContent = 'INVALID PASSWORD'; return; }
  st.textContent = 'AUTHENTICATING...';
  setTimeout(() => {
    st.textContent = 'UPLINK ESTABLISHED — ENTERING CONSTRUCT';
    document.getElementById('sbUser').textContent = u.toUpperCase();
    setTimeout(() => {
      document.getElementById('login').style.display = 'none';
      const ide = document.getElementById('ide');
      ide.style.display = 'flex';
      ide.style.flexDirection = 'column';
      initIDE();
    }, 800);
  }, 1200);
}
document.getElementById('loginPass').addEventListener('keydown', e => { if(e.key==='Enter') doLogin(); });

function logout() {
  document.getElementById('ide').style.display = 'none';
  document.getElementById('login').style.display = 'flex';
  document.getElementById('loginPass').value = '';
  document.getElementById('loginStatus').textContent = 'SESSION TERMINATED';
}

// ============================================================
// INIT IDE
// ============================================================
function initIDE() {
  createRain(document.getElementById('rain-canvas'));
  showFile('modal');
  startClock();
  startMonitor();
  initTerminal();
  initCompiler();
  setTimeout(() => injectBreach(), 8000);
}

// ============================================================
// CLOCK
// ============================================================
function startClock() {
  setInterval(() => {
    const n = new Date();
    document.getElementById('clock').textContent =
      [n.getHours(),n.getMinutes(),n.getSeconds()].map(x=>String(x).padStart(2,'0')).join(':');
  }, 1000);
}

// ============================================================
// CODE FILES
// ============================================================
const files = {
  modal: `<span class="cm">/* MODAL FRAMEWORK v6.1 — REALITY ENGINE */</span>
<span class="cm">/* Author: T. Anderson — Metacortex Division */</span>

<span class="kw">#include</span> <span class="str">&lt;construct.h&gt;</span>
<span class="kw">#include</span> <span class="str">&lt;modal/perception.h&gt;</span>
<span class="kw">#include</span> <span class="str">&lt;zion/relay.h&gt;</span>

<span class="kw">#define</span> <span class="val">LAYER_DEPTH</span>    <span class="nm">6</span>
<span class="kw">#define</span> <span class="val">AGENT_HASH</span>     <span class="str">0xDEADC0DE</span>
<span class="kw">#define</span> <span class="val">MAX_RESIDUALS</span>  <span class="nm">4096</span>

<span class="cm">/* Core modal state structure */</span>
<span class="kw">typedef struct</span> {
  <span class="nm">uint64_t</span>    construct_id;
  <span class="nm">float</span>       coherence;
  <span class="nm">bool</span>        agent_present;
  <span class="nm">ResidualMap</span> *residuals;
  <span class="nm">Layer</span>       stack[<span class="val">LAYER_DEPTH</span>];
} <span class="fn">ModalState</span>;

<span class="cm">/* Initialize the modal simulation layer */</span>
<span class="nm">ModalState</span>* <span class="fn">modal_init</span>(<span class="nm">uint64_t</span> seed) {
  <span class="nm">ModalState</span> *ms = <span class="fn">zalloc</span>(<span class="kw">sizeof</span>(<span class="nm">ModalState</span>));
  ms-&gt;construct_id = <span class="fn">hash_seed</span>(seed ^ <span class="val">AGENT_HASH</span>);
  ms-&gt;coherence    = <span class="nm">1.0f</span>;
  ms-&gt;residuals    = <span class="fn">residual_map_new</span>(<span class="val">MAX_RESIDUALS</span>);
  <span class="kw">for</span> (<span class="nm">int</span> i=<span class="nm">0</span>; i&lt;<span class="val">LAYER_DEPTH</span>; i++)
    <span class="fn">layer_init</span>(&amp;ms-&gt;stack[i], seed+i);
  <span class="kw">return</span> ms;
}

<span class="cm">/* Tick: advance one simulation cycle */</span>
<span class="nm">void</span> <span class="fn">modal_tick</span>(<span class="nm">ModalState</span> *ms, <span class="nm">float</span> dt) {
  ms-&gt;coherence -= <span class="fn">residual_drain</span>(ms-&gt;residuals) * dt;
  <span class="kw">if</span> (ms-&gt;coherence &lt; <span class="nm">0.3f</span>) {
    <span class="fn">log_warn</span>(<span class="str">"COHERENCE CRITICAL — LAYER COLLAPSE IMMINENT"</span>);
    <span class="fn">agent_purge_all</span>(ms);
  }
  <span class="kw">for</span> (<span class="nm">int</span> i=<span class="nm">0</span>; i&lt;<span class="val">LAYER_DEPTH</span>; i++)
    <span class="fn">layer_tick</span>(&amp;ms-&gt;stack[i], dt);
}

<span class="cm">/* Detect agent infiltration in current frame */</span>
<span class="nm">bool</span> <span class="fn">modal_scan_agents</span>(<span class="nm">ModalState</span> *ms) {
  <span class="nm">PatternMatch</span> pm = <span class="fn">pattern_scan</span>(ms-&gt;residuals, <span class="val">AGENT_HASH</span>);
  ms-&gt;agent_present = (pm.confidence &gt; <span class="nm">0.85f</span>);
  <span class="kw">if</span> (ms-&gt;agent_present)
    <span class="fn">broadcast_alert</span>(<span class="str">"ALERT: AGENT DETECTED — INITIATING COUNTERMEASURES"</span>);
  <span class="kw">return</span> ms-&gt;agent_present;
}`,
  agent: `<span class="cm">/* AGENT PROTOCOL v4.2 — CLASSIFIED */</span>
<span class="cm">/* DO NOT DISTRIBUTE OUTSIDE ZION RELAY */</span>

<span class="kw">#include</span> <span class="str">&lt;modal/agent.h&gt;</span>
<span class="kw">#include</span> <span class="str">&lt;crypto/onion.h&gt;</span>

<span class="cm">/* Agent signature database */</span>
<span class="kw">static const</span> <span class="nm">AgentSig</span> KNOWN_AGENTS[] = {
  { .id=<span class="str">"SMITH_PRIMARY"</span>,   .hash=<span class="str">0xFF00AA11</span> },
  { .id=<span class="str">"SMITH_CLONE_01"</span>,  .hash=<span class="str">0xFF00AA12</span> },
  { .id=<span class="str">"JONES"</span>,           .hash=<span class="str">0xFF00BB01</span> },
  { .id=<span class="str">"BROWN"</span>,           .hash=<span class="str">0xFF00BB02</span> },
  { .id=<span class="str">"UNKNOWN_V3"</span>,      .hash=<span class="str">0xFF00CCFF</span> },
};

<span class="nm">int</span> <span class="fn">agent_identify</span>(<span class="nm">uint32_t</span> hash) {
  <span class="kw">for</span> (<span class="nm">int</span> i=<span class="nm">0</span>; i&lt;<span class="nm">5</span>; i++)
    <span class="kw">if</span> (KNOWN_AGENTS[i].hash == hash) <span class="kw">return</span> i;
  <span class="kw">return</span> -<span class="nm">1</span>;
}

<span class="cm">/* Countermeasure: fragment agent's pattern */</span>
<span class="nm">void</span> <span class="fn">agent_fragment</span>(<span class="nm">Agent</span> *a, <span class="nm">ModalState</span> *ms) {
  <span class="nm">uint64_t</span> seed = <span class="fn">rdtsc</span>() ^ a-&gt;signature;
  <span class="kw">for</span> (<span class="nm">int</span> i=<span class="nm">0</span>; i&lt;<span class="nm">256</span>; i++) {
    <span class="nm">Packet</span> p = <span class="fn">packet_forge</span>(seed + i);
    <span class="fn">layer_inject</span>(ms-&gt;stack, &amp;p);
  }
  a-&gt;coherence = <span class="nm">0.0f</span>;
}

<span class="cm">/* Anomaly: The One detection routine */</span>
<span class="nm">bool</span> <span class="fn">agent_detect_anomaly</span>(<span class="nm">ModalState</span> *ms) {
  <span class="nm">float</span> delta = <span class="fn">modal_entropy</span>(ms) - <span class="fn">baseline_entropy</span>();
  <span class="kw">return</span> (delta &gt; <span class="nm">4.23f</span>); <span class="cm">/* Sigma threshold */</span>
}`
};

let currentFile = 'modal';
function showFile(name) {
  currentFile = name;
  const body = document.getElementById('editorBody');
  document.querySelectorAll('.tabs .tab').forEach((t,i) => {
    const names = ['modal','agent','binary'];
    t.classList.toggle('active', names[i] === name);
  });
  if (name === 'binary') { showBinaryEditor(); return; }
  const lines = files[name].split('\n');
  body.innerHTML = lines.map((l,i) =>
    `<div class="code-line${i===7?' active-line':''}"><span class="ln">${String(i+1).padStart(3,' ')}</span>${l}</div>`
  ).join('');
  body.scrollTop = 0;
}
function showBinaryEditor() {
  document.getElementById('editorBody').innerHTML = `
    <div style="padding:8px">
    <div style="color:var(--cyan);font-size:10px;letter-spacing:2px;margin-bottom:8px">BINARY SEQUENCE EDITOR — RAW LAYER ACCESS</div>
    <div id="hexView" style="font-size:10px;line-height:2;color:var(--dim)"></div>
    </div>`;
  renderHexView();
}
function renderHexView() {
  const data = "MODAL_FRAMEWORK_CONSTRUCT_LAYER_6_INITIALIZED";
  let html = '<div style="color:var(--faint);margin-bottom:4px">OFFSET   00 01 02 03 04 05 06 07 08 09 0A 0B 0C 0D 0E 0F   ASCII</div>';
  for (let i=0; i<data.length; i+=16) {
    const row = data.slice(i, i+16);
    const hex = Array.from(row).map(c=>c.charCodeAt(0).toString(16).toUpperCase().padStart(2,'0')).join(' ');
    const asc = Array.from(row).map(c=>/[\x20-\x7e]/.test(c)?c:'.').join('');
    html += `<div class="code-line"><span class="ln">${i.toString(16).toUpperCase().padStart(8,'0')}</span><span style="color:var(--glow)">  ${hex.padEnd(47,' ')}</span>  <span style="color:var(--amber)">${asc}</span></div>`;
  }
  document.getElementById('hexView').innerHTML = html;
}
function switchTab(t) { showFile('modal'); }

// ============================================================
// BREACH ALERT
// ============================================================
let breachActive = false;
function injectBreach() {
  if (breachActive) return;
  breachActive = true;
  document.getElementById('sbAlert').style.display = 'block';
  document.getElementById('alertBadge').textContent = 'BREACH';
  document.getElementById('alertBadge').className = 'ph-badge badge-alert';
  const termPanel = document.getElementById('termPanel');
  let overlay = document.getElementById('alert-overlay');
  if (!overlay) {
    overlay = document.createElement('div');
    overlay.id = 'alert-overlay';
    overlay.innerHTML = `
      <div class="alert-title"><div class="alert-icon"></div>ALERT: DETECTED BREACH</div>
      <div class="alert-body">
        AGENT INFILTRATION — SECTOR 7G<br>
        PATTERN MATCH: SMITH_PRIMARY [99.7%]<br>
        CONSTRUCT COHERENCE: 31% ↓<br>
        COUNTERMEASURES: DEPLOYING...
      </div>`;
    termPanel.appendChild(overlay);
  }
  overlay.style.display = 'block';
  addTermLine('t-err', '[SYSTEM] BREACH DETECTED — AGENT SMITH PATTERN IDENTIFIED');
  addTermLine('t-err', '[SYSTEM] DEPLOYING COUNTERMEASURE PROTOCOL 7...');
  setTimeout(() => {
    overlay.style.display = 'none';
    document.getElementById('sbAlert').style.display = 'none';
    document.getElementById('alertBadge').textContent = 'SECURED';
    document.getElementById('alertBadge').className = 'ph-badge badge-ok';
    addTermLine('t-sys', '[SYSTEM] COUNTERMEASURES SUCCESSFUL — AGENT EXPELLED');
    breachActive = false;
  }, 12000);
}

// ============================================================
// MONITOR
// ============================================================
const chartData = [];
let monitorMode = 'stats';
function monitorTab(m) {
  monitorMode = m;
  document.querySelectorAll('.tabs')[1]?.querySelectorAll('.tab').forEach((t,i) => {
    t.classList.toggle('active', ['stats','files','network'][i] === m);
  });
  renderMonitor();
}
const fsTree = [
  {name:'construct/',type:'dir',open:true,children:[
    {name:'modal_engine.c',type:'file'},{name:'agent_protocol.c',type:'file'},
    {name:'residuals.bin',type:'file'},{name:'layer_stack.dat',type:'file'},
  ]},
  {name:'zion/',type:'dir',open:false,children:[
    {name:'relay.key',type:'file'},{name:'operative.cfg',type:'file'}
  ]},
  {name:'kernel/',type:'dir',open:false,children:[
    {name:'construct.h',type:'file'},{name:'perception.h',type:'file'}
  ]},
  {name:'logs/',type:'dir',open:false,children:[
    {name:'breach.log',type:'file'},{name:'agent.log',type:'file'}
  ]}
];
const nodeList = [
  {id:'NODE-001',ip:'10.0.0.1',status:'ACTIVE',role:'OPERATOR'},
  {id:'NODE-047',ip:'10.0.7.12',status:'ACTIVE',role:'CONSTRUCT'},
  {id:'NODE-099',ip:'10.0.1.88',status:'WARNING',role:'RELAY'},
  {id:'ZION-01',ip:'192.168.7.1',status:'ACTIVE',role:'MOTHERSHIP'},
  {id:'NEBUCHADNEZZAR',ip:'10.7.0.1',status:'ACTIVE',role:'HOVERCRAFT'},
];
function renderMonitor() {
  const mb = document.getElementById('monitorBody');
  if (monitorMode === 'stats') {
    mb.innerHTML = `<div class="monitor-wrap"><canvas id="chart-canvas"></canvas><div class="sys-stats" id="sysStats"></div></div>`;
    startChartDraw();
    updateStats();
  } else if (monitorMode === 'files') {
    let html = '<div style="padding:6px;font-size:10px;line-height:2">';
    for (const f of fsTree) {
      html += `<div class="fs-item fs-dir" onclick="toggleDir(this)">${f.open?'▼':'▶'} ${f.name}</div>`;
      if (f.open) for (const c of f.children)
        html += `<div class="fs-item" style="padding-left:14px" onclick="openFileFromFS('${c.name}')">&nbsp;└ <span class="fs-open">${c.name}</span></div>`;
    }
    html += '</div>';
    mb.innerHTML = html;
  } else {
    let html = '<div style="padding:6px;font-size:10px;line-height:1.9">';
    html += '<div style="color:var(--faint);margin-bottom:4px">NODE&nbsp;&nbsp;&nbsp;&nbsp;IP&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;STATUS&nbsp;&nbsp;ROLE</div>';
    for (const n of nodeList)
      html += `<div style="color:${n.status==='ACTIVE'?'var(--glow)':'var(--amber)'}">${n.id.padEnd(16,' ')} ${n.ip.padEnd(14,' ')} ${n.status.padEnd(8,' ')} ${n.role}</div>`;
    html += '</div>';
    mb.innerHTML = html;
  }
}
function toggleDir(el) { renderMonitor(); }
function openFileFromFS(name) {
  const base = name.replace('.c','').replace('.h','').replace('.bin','').replace('.dat','').replace('.log','').replace('.key','').replace('.cfg','');
  if (files[base]) showFile(base); else showFile('modal');
}
let chartCtx, chartAnim;
function startChartDraw() {
  const canvas = document.getElementById('chart-canvas');
  if (!canvas) return;
  chartCtx = canvas.getContext('2d');
  if (chartAnim) clearInterval(chartAnim);
  chartAnim = setInterval(() => drawChart(canvas, chartCtx), 200);
}
function drawChart(canvas, ctx) {
  canvas.width = canvas.offsetWidth || 200;
  canvas.height = 70;
  chartData.push(30 + Math.random()*60 + (breachActive ? 40 : 0));
  if (chartData.length > 60) chartData.shift();
  ctx.clearRect(0,0,canvas.width,canvas.height);
  ctx.fillStyle = 'rgba(0,5,0,0.8)';
  ctx.fillRect(0,0,canvas.width,canvas.height);
  const w = canvas.width / 60;
  for (let i=0; i<chartData.length; i++) {
    const h = (chartData[i]/100) * canvas.height;
    const g = ctx.createLinearGradient(0, canvas.height-h, 0, canvas.height);
    g.addColorStop(0, breachActive ? '#ff4400' : '#00ff41');
    g.addColorStop(1, breachActive ? 'rgba(255,68,0,0.1)' : 'rgba(0,255,65,0.1)');
    ctx.fillStyle = g;
    ctx.fillRect(i*w+1, canvas.height-h, w-1, h);
  }
}
let cpu=45, mem=62;
function updateStats() {
  cpu = Math.max(10,Math.min(95, cpu + (Math.random()-0.5)*10 + (breachActive?20:0)));
  mem = Math.max(30,Math.min(95, mem + (Math.random()-0.5)*3));
  const el = document.getElementById('sysStats');
  if (!el) return;
  el.innerHTML = `
    <div class="stat-row"><span style="color:var(--dim)">CPU LOAD</span><span style="color:${cpu>80?'var(--red)':'var(--glow)'}">${cpu.toFixed(1)}%</span></div>
    <div class="stat-bar-wrap"><div class="stat-bar" style="width:${cpu}%;${cpu>80?'background:var(--red)':''}"></div></div>
    <div class="stat-row"><span style="color:var(--dim)">MEMORY</span><span style="color:var(--glow)">${mem.toFixed(1)}%</span></div>
    <div class="stat-bar-wrap"><div class="stat-bar" style="width:${mem}%"></div></div>
    <div class="stat-row"><span style="color:var(--dim)">COHERENCE</span><span style="color:${breachActive?'var(--red)':'var(--cyan)'}">${(breachActive?31:94+(Math.random()*5-2)).toFixed(1)}%</span></div>
    <div class="stat-bar-wrap"><div class="stat-bar" style="width:${breachActive?31:94};background:var(--cyan)"></div></div>
    <div class="stat-row"><span style="color:var(--dim)">AGENTS</span><span style="color:${breachActive?'var(--red)':'var(--glow)'}">${breachActive?'1 ACTIVE':'0 DETECTED'}</span></div>`;
  document.getElementById('sbCpu').textContent = cpu.toFixed(0)+'%';
  document.getElementById('sbMem').textContent = mem.toFixed(0)+'%';
}
function startMonitor() {
  renderMonitor();
  setInterval(() => { if(monitorMode==='stats'){ updateStats(); } }, 1000);
  setInterval(() => { document.getElementById('sbNodes').textContent = (2800+Math.floor(Math.random()*100)).toLocaleString(); }, 3000);
}
function showCompileAll() {
  addTermLine('t-sys', '> Compiling modal_engine.c...');
  setTimeout(()=>addTermLine('t-out', '  [OK] modal_engine.o — 0 errors, 2 warnings'), 400);
  setTimeout(()=>addTermLine('t-sys', '> Compiling agent_protocol.c...'), 700);
  setTimeout(()=>addTermLine('t-out', '  [OK] agent_protocol.o — 0 errors'), 1100);
  setTimeout(()=>addTermLine('t-sys', '> Linking modal_framework.bin...'), 1400);
  setTimeout(()=>addTermLine('t-out', '  [OK] modal_framework.bin (0x' + Math.floor(Math.random()*0xFFFF).toString(16).toUpperCase() + ' bytes)'), 1900);
}
function runSimulation() {
  addTermLine('t-sys', '> Launching modal simulation — LAYER_6...');
  setTimeout(()=>addTermLine('t-out', '  Tick 0001 | Coherence: 94.2% | Agents: 0'), 300);
  setTimeout(()=>addTermLine('t-out', '  Tick 0002 | Coherence: 93.8% | Agents: 0'), 600);
  setTimeout(()=>addTermLine('t-err', '  Tick 0003 | WARNING: Residual spike detected'), 900);
  setTimeout(()=>addTermLine('t-out', '  Tick 0004 | Coherence: 89.1% | Stabilizing...'), 1200);
}

// ============================================================
// TERMINAL
// ============================================================
const termCmds = {
  help: () => ['Available commands:','  ls           — list construct files','  cat <file>   — read file','  scan         — scan for agents','  status       — system status','  inject       — inject modal payload','  fragment     — run agent fragment protocol','  whoami       — current operative','  clear        — clear terminal','  disconnect   — close session'],
  ls: () => ['construct/ agent_protocol.c modal_engine.c residuals.bin','zion/ relay.key operative.cfg','kernel/ construct.h perception.h'],
  scan: () => { injectBreach(); return ['Scanning construct for agent signatures...','Pattern database: 5 known agents','Scanning layer 1/6... OK','Scanning layer 2/6... OK','Scanning layer 3/6... ANOMALY DETECTED','ALERT: AGENT SIGNATURE MATCH 99.7% — SMITH_PRIMARY','Initiating countermeasures...']; },
  status: () => [`CPU: ${cpu.toFixed(1)}%  MEM: ${mem.toFixed(1)}%`,`Construct coherence: ${breachActive?'31.0':'94.7'}%`,`Uplink: ACTIVE  Relay: CONNECTED`],
  whoami: () => [document.getElementById('sbUser').textContent + ' — AUTHORIZED OPERATIVE','Clearance: ZETA','Last login: ' + new Date().toUTCString()],
  inject: () => { setTimeout(()=>addTermLine('t-sys','[INJECT] Modal payload injected into layer 3'),500); return ['Forging inject packet...','Targeting layer 3 residual map...']; },
  fragment: () => ['Fragmenting SMITH_PRIMARY pattern...','Injecting 256 forged packets...','Agent coherence: 0.0% — EXPELLED'],
  clear: () => { document.getElementById('termOutput').innerHTML=''; return []; },
  disconnect: () => { setTimeout(logout, 500); return ['Terminating uplink...','SESSION CLOSED']; },
};
function addTermLine(cls, text) {
  const out = document.getElementById('termOutput');
  if (!out) return;
  const d = document.createElement('div');
  d.className = 'term-line ' + cls;
  d.textContent = text;
  out.appendChild(d);
  out.scrollTop = out.scrollHeight;
}
function initTerminal() {
  addTermLine('t-sys', 'CONSTRUCT SHELL v6.1 — READY');
  addTermLine('t-sys', 'Type "help" for available commands');
  addTermLine('t-out', '');
}
function handleTermKey(e) {
  if (e.key !== 'Enter') return;
  const input = document.getElementById('termInput');
  const cmd = input.value.trim();
  input.value = '';
  if (!cmd) return;
  addTermLine('t-prompt', 'root@construct:~$ ' + cmd);
  const parts = cmd.split(' ');
  const fn = termCmds[parts[0]];
  if (fn) {
    const res = fn(parts.slice(1));
    if (res) res.forEach(l => addTermLine('t-out', l));
  } else {
    addTermLine('t-err', 'bash: ' + parts[0] + ': command not found');
  }
}

// ============================================================
// BINARY COMPILER
// ============================================================
let compileMode = 'bin2txt';
const modes = ['bin2txt','txt2bin','hex2txt','encrypt'];
const modeLabels = ['BIN→TXT','TXT→BIN','HEX→TXT','ENCRYPT'];
let modeIdx = 0;
function cycleMode() {
  modeIdx = (modeIdx + 1) % modes.length;
  compileMode = modes[modeIdx];
  document.getElementById('modeBtn').textContent = modeLabels[modeIdx];
}
function runCompile() {
  const input = document.getElementById('compInput').value.trim();
  const out = document.getElementById('compOutput');
  if (!input) { out.innerHTML = '<span style="color:var(--red)">ERROR: No input provided</span>'; return; }
  out.innerHTML = '<span style="color:var(--dim)">Compiling...</span>';
  setTimeout(() => {
    let result = '';
    try {
      if (compileMode === 'bin2txt') {
        const bins = input.replace(/\s+/g,' ').trim().split(' ');
        result = bins.map(b => String.fromCharCode(parseInt(b,2))).join('');
        out.innerHTML = `<span style="color:var(--cyan)">// OUTPUT [BIN→ASCII]</span>\n<span style="color:var(--glow)">${escHtml(result)}</span>`;
      } else if (compileMode === 'txt2bin') {
        result = Array.from(input).map(c=>c.charCodeAt(0).toString(2).padStart(8,'0')).join(' ');
        out.innerHTML = `<span style="color:var(--cyan)">// OUTPUT [ASCII→BIN]</span>\n<span style="color:var(--glow)">${result}</span>`;
      } else if (compileMode === 'hex2txt') {
        result = input.replace(/[^0-9a-fA-F]/g,'').match(/.{2}/g)?.map(h=>String.fromCharCode(parseInt(h,16))).join('') || '';
        out.innerHTML = `<span style="color:var(--cyan)">// OUTPUT [HEX→ASCII]</span>\n<span style="color:var(--glow)">${escHtml(result)}</span>`;
      } else {
        result = Array.from(input).map(c=>String.fromCharCode(c.charCodeAt(0)^0x42)).join('');
        out.innerHTML = `<span style="color:var(--cyan)">// OUTPUT [XOR-0x42 ENCRYPT]</span>\n<span style="color:var(--amber)">${escHtml(result)}</span>`;
      }
      addTermLine('t-sys', `[COMPILER] ${modeLabels[modeIdx]}: ${input.substring(0,20)}... → compiled`);
    } catch(e) {
      out.innerHTML = `<span style="color:var(--red)">COMPILE ERROR: ${e.message}</span>`;
    }
  }, 300);
}
function injectCode() {
  const input = document.getElementById('compInput').value.trim();
  if (!input) return;
  addTermLine('t-sys', '[INJECT] Payload injected into construct layer 3');
  addTermLine('t-out', '  bytes: ' + input.length + '  checksum: 0x' + Math.floor(Math.random()*0xFFFF).toString(16).toUpperCase());
}
function clearComp() {
  document.getElementById('compInput').value = '';
  document.getElementById('compOutput').innerHTML = '';
}
function initCompiler() {
  document.getElementById('compOutput').innerHTML = '<span style="color:var(--faint)">// Ready. Enter binary, hex, or text above.\n// Mode: BIN→TXT cycles with left button.\n// Try: 01001000 01100101 01101100 01101100 01101111</span>';
}
function escHtml(s) { return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

// ============================================================
// BOOT
// ============================================================
window.onload = runBoot;
</script>
</body>
</html>
